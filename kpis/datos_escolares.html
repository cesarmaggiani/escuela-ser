<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Datos Escolares</title>

    <link rel="icon" type="image/png" href="https://lh3.googleusercontent.com/d/1FurpirvyhqaVyBaZySWALony1vkyTsdz">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        // Cache buster: añade un timestamp único a las URLs de los scripts de Google
        const timestamp = new Date().getTime();
        document.write(`<script async defer src="https://apis.google.com/js/api.js?cb=${timestamp}" onload="gapiLoaded()"><\/script>`);
        document.write(`<script async defer src="https://accounts.google.com/gsi/client?cb=${timestamp}" onload="gisLoaded()"><\/script>`);
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; }
        .sidebar { transition: transform 0.3s ease-in-out; }
        .main-content { transition: margin-left 0.3s ease-in-out; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        #menu-button { transition: transform 0.3s; }
        .active-link {
            background-color: #4a5568;
            color: #ffffff;
        }
        /* Oculta los enlaces de navegación por defecto */
        #main-nav .nav-link {
            display: none;
        }
        /* Estilo para resaltar subfase actual */
        .current-subphase {
            font-weight: 600; /* semibold */
            color: #1d4ed8; /* blue-700 */
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="login-screen" class="fixed inset-0 flex items-center justify-center bg-gray-100 z-50">
        <div class="bg-white p-8 md:p-12 rounded-xl shadow-2xl text-center w-full max-w-md mx-4">

            <div class="flex justify-center items-center mb-4">
                <img src="https://lh3.googleusercontent.com/d/1perW5iSIdezcMgMQi6ouq593vb6Sc23e" alt="Logotipo" class="h-16 w-auto object-contain">
            </div>
            <h1 class="text-3xl font-bold text-gray-800 mb-2">Datos Escolares</h1>
            <p class="text-gray-600 mb-8">Inicia sesión para acceder al tablero.</p>

            <div class="mb-6 w-full">
                <label for="school-selector" class="block text-sm font-medium text-gray-700 mb-2 text-left">Selecciona tu escuela:</label>
                <select id="school-selector" name="school" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" disabled>
                    <option selected>Cargando escuelas...</option>
                </select>
            </div>
            <button id="login-button" class="bg-blue-600 text-white w-full flex items-center justify-center px-4 py-3 rounded-lg shadow-md hover:bg-blue-700 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50" disabled>
                <svg class="w-6 h-6 mr-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><defs><path id="a" d="M44.5 20H24v8.5h11.8C34.7 33.9 30.1 37 24 37c-7.2 0-13-5.8-13-13s5.8-13 13-13c3.1 0 5.9 1.1 8.1 2.9l6.4-6.4C34.6 4.1 29.6 2 24 2 11.8 2 2 11.8 2 24s9.8 22 22 22c11 0 21-8 21-22 0-1.3-.2-2.7-.5-4z"/></defs><clipPath id="b"><use xlink:href="#a" overflow="visible"/></clipPath><path clip-path="url(#b)" fill="#FBBC05" d="M0 37V11l17 13z"/><path clip-path="url(#b)" fill="#EA4335" d="M0 11l17 13 7-6.1L48 14V0H0z"/><path clip-path="url(#b)" fill="#34A853" d="M0 37l30-23.5 7.9 1L48 0v48H0z"/><path clip-path="url(#b)" fill="#4285F4" d="M48 48L17 24l-4-3 35-10z"/></svg>
                <span class="font-semibold">Iniciar Sesión con Google</span>
            </button>
        </div>
    </div>

    <div id="app-wrapper" class="flex h-screen w-full hidden">
        <aside id="sidebar" class="bg-gray-800 text-white w-64 space-y-6 py-7 px-2 absolute inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0 transition duration-200 ease-in-out z-20">

            <a href="#" class="text-white flex flex-col items-center space-y-2 px-4">
                <img src="https://lh3.googleusercontent.com/d/1Dlnf947o9B3ISYf5ylfCSe7XOYl5BRqn" alt="Logo Plataforma" class="h-12 w-auto object-contain">
                <span class="text-2xl font-extrabold">Datos Escolares</span>
            </a>

            <nav id="main-nav">
                <a href="#resumen" class="block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700 nav-link active-link"><i data-lucide="home" class="inline-block w-5 h-5 mr-2"></i> Resumen</a>
                <a href="#entregables" class="block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700 nav-link"><i data-lucide="calendar-check" class="inline-block w-5 h-5 mr-2"></i> Entregables</a>
                <a href="#estudiantes" class="block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700 nav-link"><i data-lucide="users" class="inline-block w-5 h-5 mr-2"></i> Estudiantes</a>
                <a href="#docentes" class="block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700 nav-link"><i data-lucide="briefcase" class="inline-block w-5 h-5 mr-2"></i> Docentes</a>
                <a href="#formacion-docente" class="block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700 nav-link"><i data-lucide="presentation" class="inline-block w-5 h-5 mr-2"></i> Formación Docente</a>
                <a href="#calificaciones" class="block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700 nav-link"><i data-lucide="book-marked" class="inline-block w-5 h-5 mr-2"></i> Calificaciones</a>
                <a href="#calificaciones-grado" class="block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700 nav-link"><i data-lucide="graduation-cap" class="inline-block w-5 h-5 mr-2"></i> Calificaciones por Grado</a>
                <a href="#boletos-salida" class="block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700 nav-link"><i data-lucide="ticket" class="inline-block w-5 h-5 mr-2"></i> Boletos de Salida</a>
                <a href="#expediente-estudiante" class="block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700 nav-link"><i data-lucide="contact-2" class="inline-block w-5 h-5 mr-2"></i> Expediente Estudiante</a>
                <a href="#asistencia-padres" class="block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700 nav-link"><i data-lucide="users" class="inline-block w-5 h-5 mr-2"></i> Escuela para Padres</a>
                <a href="#desarrollo-profesional" class="block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700 nav-link"><i data-lucide="award" class="inline-block w-5 h-5 mr-2"></i> Desarrollo Profesional</a>
            </nav>
        </aside>

        <div class="flex-1 flex flex-col overflow-hidden">
            <header class="flex justify-between items-center py-4 px-6 bg-white border-b-2">
                <div class="flex items-center space-x-4">
                    <button id="menu-button" class="text-gray-500 focus:outline-none md:hidden"><i data-lucide="menu" class="h-6 w-6"></i></button>

                    <div class="flex items-center space-x-3">
                        <i data-lucide="bar-chart-3" id="default-icon" class="h-8 w-8 text-blue-600"></i>
                        <img id="school-logo-sidebar" src="" alt="Logo Escuela" class="h-10 w-auto object-contain hidden rounded-md">
                        <h2 id="school-name-header" class="text-xl font-bold text-gray-700 hidden"></h2>
                    </div>
                </div>

                <div class="flex items-center space-x-4 ml-auto">
                    <span id="user-info" class="text-gray-600 hidden"></span>
                    <button id="signout_button" class="bg-red-500 text-white px-4 py-2 rounded shadow hover:bg-red-600 hidden">Cerrar Sesión</button>
                </div>
            </header>
            <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-4 md:p-6">
                <div id="loading-indicator" class="text-center p-10 hidden">
                    <i data-lucide="loader-2" class="mx-auto h-12 w-12 text-gray-400 animate-spin"></i>
                    <h3 class="mt-2 text-sm font-medium text-gray-900">Cargando datos...</h3>
                    <p class="mt-1 text-sm text-gray-500">Obteniendo la información desde Google Sheets.</p>
                </div>

                <div id="unauthorized-message" class="text-center p-10 hidden">
                    <i data-lucide="lock" class="mx-auto h-12 w-12 text-red-500"></i>
                    <h3 class="mt-2 text-sm font-medium text-gray-900">Acceso Denegado</h3>
                    <p class="mt-1 text-sm text-gray-500">Tu cuenta no tiene permisos para ver este tablero. Por favor, contacta al administrador.</p>
                </div>

                <div id="main-container" class="container mx-auto hidden">
                    <section id="resumen" class="content-section fade-in">
                        <div class="flex flex-wrap justify-between items-center mb-6"><h2 class="text-3xl font-bold text-gray-800">Resumen General</h2><div class="mt-4 sm:mt-0"><label for="period-filter" class="text-sm font-medium text-gray-700 mr-2">Filtrar por:</label><select id="period-filter" class="rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"></select></div></div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 xl:grid-cols-5 gap-6">
                            <div class="bg-white p-6 rounded-xl shadow-md flex items-center justify-between"><div><p class="text-sm font-medium text-gray-500">Matrícula Total</p><p id="summary-matricula" class="text-3xl font-bold text-gray-800">0</p></div><div class="bg-blue-100 p-3 rounded-full"><i data-lucide="user-check" class="h-6 w-6 text-blue-500"></i></div></div>
                            <div class="bg-white p-6 rounded-xl shadow-md flex items-center justify-between"><div><p class="text-sm font-medium text-gray-500">Alumnos BAP</p><p id="summary-bap" class="text-3xl font-bold text-gray-800">0</p></div><div class="bg-orange-100 p-3 rounded-full"><i data-lucide="heart" class="h-6 w-6 text-orange-500"></i></div></div>
                            <div class="bg-white p-6 rounded-xl shadow-md flex items-center justify-between"><div><p class="text-sm font-medium text-gray-500">Asistencia Promedio</p><p id="summary-asistencia" class="text-3xl font-bold text-gray-800">0%</p></div><div class="bg-green-100 p-3 rounded-full"><i data-lucide="calendar-check-2" class="h-6 w-6 text-green-500"></i></div></div>
                            <div id="card-bajas" class="bg-white p-6 rounded-xl shadow-md flex items-center justify-between"><div><p class="text-sm font-medium text-gray-500">Bajas de Estudiantes</p><p id="summary-bajas" class="text-3xl font-bold text-gray-800">0</p></div><div class="bg-red-100 p-3 rounded-full"><i data-lucide="user-minus" class="h-6 w-6 text-red-500"></i></div></div>
                            <div id="card-docentes" class="bg-white p-6 rounded-xl shadow-md flex items-center justify-between"><div><p class="text-sm font-medium text-gray-500">Docentes Activos</p><p id="summary-docentes" class="text-3xl font-bold text-gray-800">0</p></div><div class="bg-indigo-100 p-3 rounded-full"><i data-lucide="briefcase" class="h-6 w-6 text-indigo-500"></i></div></div>
                            <div id="card-padres" class="bg-white p-6 rounded-xl shadow-md flex items-center justify-between"><div><p class="text-sm font-medium text-gray-500">Asistencia Padres</p><p id="summary-padres" class="text-3xl font-bold text-gray-800">0%</p></div><div class="bg-teal-100 p-3 rounded-full"><i data-lucide="users" class="h-6 w-6 text-teal-500"></i></div></div>
                            <div id="summary-matematicas-card" class="bg-white p-6 rounded-xl shadow-md flex items-center justify-between"><div><p class="text-sm font-medium text-gray-500">Prom. Matemáticas</p><p id="summary-matematicas" class="text-3xl font-bold text-gray-800">0.0</p></div><div class="bg-yellow-100 p-3 rounded-full"><i data-lucide="function-square" class="h-6 w-6 text-yellow-500"></i></div></div>
                            <div id="summary-espanol-card" class="bg-white p-6 rounded-xl shadow-md flex items-center justify-between"><div><p class="text-sm font-medium text-gray-500">Prom. Español</p><p id="summary-espanol" class="text-3xl font-bold text-gray-800">0.0</p></div><div class="bg-purple-100 p-3 rounded-full"><i data-lucide="pilcrow" class="h-6 w-6 text-purple-500"></i></div></div>
                            <div id="summary-ciencias-card" class="bg-white p-6 rounded-xl shadow-md flex items-center justify-between"><div><p class="text-sm font-medium text-gray-500">Prom. Ciencias</p><p id="summary-ciencias" class="text-3xl font-bold text-gray-800">0.0</p></div><div class="bg-green-100 p-3 rounded-full"><i data-lucide="flask-conical" class="h-6 w-6 text-green-500"></i></div></div>
                            <div id="summary-ingles-card" class="bg-white p-6 rounded-xl shadow-md flex items-center justify-between"><div><p class="text-sm font-medium text-gray-500">Prom. Inglés</p><p id="summary-ingles" class="text-3xl font-bold text-gray-800">0.0</p></div><div class="bg-blue-100 p-3 rounded-full"><i data-lucide="languages" class="h-6 w-6 text-blue-500"></i></div></div>
                        </div>
                    </section>

                    <section id="entregables" class="content-section hidden fade-in space-y-6">
                        <h2 class="text-3xl font-bold text-gray-800">Próximos Entregables</h2>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="bg-white p-6 rounded-xl shadow-md">
                                <p class="text-sm font-medium text-gray-500 flex items-center"><i data-lucide="bar-chart-3" class="h-5 w-5 mr-2 text-blue-500"></i> Próxima Estadística</p>
                                <p id="prox-estadistica-nombre" class="text-xl font-bold text-gray-800 mt-2 truncate" title="N/A">N/A</p>
                                <p id="prox-estadistica-fecha" class="text-lg font-semibold text-blue-600 mt-1">--</p>
                            </div>
                            <div class="bg-white p-6 rounded-xl shadow-md flex flex-col">
                                <p class="text-sm font-medium text-gray-500 flex items-center">
                                    <i data-lucide="book-marked" class="h-5 w-5 mr-2 text-purple-500"></i> Próximas Calificaciones
                                </p>
                                <div id="prox-calificacion-lista" class="mt-2 space-y-2 flex-1">
                                    <p class="text-gray-500 text-sm">No hay entregas de calificaciones pendientes.</p>
                                </div>
                            </div>
                            <div class="bg-white p-6 rounded-xl shadow-md">
                                <p class="text-sm font-medium text-gray-500 flex items-center"><i data-lucide="clipboard-list" class="h-5 w-5 mr-2 text-green-500"></i> Próxima Planeación</p>
                                <p id="prox-planeacion-nombre" class="text-xl font-bold text-gray-800 mt-2 truncate" title="N/A">N/A</p>
                                <p id="prox-planeacion-fecha" class="text-lg font-semibold text-green-600 mt-1">--</p>
                            </div>
                        </div>

                        <div class="bg-white p-6 rounded-xl shadow-md">
                            <h3 class="font-bold text-lg text-gray-700 mb-4">Calendario Completo de Entregables</h3>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Categoría</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Entregable</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Fecha Límite</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Días Restantes</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tabla-entregables-body" class="bg-white divide-y divide-gray-200">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </section>

                    <section id="estudiantes" class="content-section hidden fade-in">
                        <h2 class="text-3xl font-bold mb-6 text-gray-800">Estadísticas de Estudiantes</h2>
                        <div class="bg-white p-4 rounded-xl shadow-md mb-6"><div class="flex flex-wrap gap-4 items-center justify-between"><div class="flex flex-wrap gap-4 items-center"><h3 class="font-bold text-lg text-gray-700">Filtros:</h3><div><label for="student-grade-filter" class="text-sm font-medium text-gray-700 mr-2">Grado:</label><select id="student-grade-filter" class="rounded-md border-gray-300 shadow-sm"></select></div><div><label for="student-group-filter" class="text-sm font-medium text-gray-700 mr-2">Grupo:</label><select id="student-group-filter" class="rounded-md border-gray-300 shadow-sm"></select></div><div><label for="student-gender-filter" class="text-sm font-medium text-gray-700 mr-2">Género:</label><select id="student-gender-filter" class="rounded-md border-gray-300 shadow-sm"><option value="Todos">Todos</option><option value="Femenino">Femenino</option><option value="Masculino">Masculino</option></select></div><div><label for="student-bap-filter" class="text-sm font-medium text-gray-700 mr-2">BAP:</label><select id="student-bap-filter" class="rounded-md border-gray-300 shadow-sm"><option value="Todos">Todos</option><option value="Sí">Sí</option><option value="No">No</option></select></div></div><div class="text-right"><p class="text-sm font-medium text-gray-500">Total Estudiantes</p><p id="student-count-stats" class="text-2xl font-bold text-gray-800">0</p></div></div></div>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6"><div class="bg-white p-6 rounded-xl shadow-md"><h3 class="font-bold text-lg text-gray-700">Movimiento de Matrícula</h3><canvas id="matriculaChart" class="mt-4"></canvas></div><div class="bg-white p-6 rounded-xl shadow-md lg:col-span-2"><h3 id="asistencia-chart-title" class="font-bold text-lg text-gray-700">Análisis de Asistencia Mensual</h3><canvas id="asistenciaChart" class="mt-4"></canvas></div></div>
                    </section>
                    <section id="docentes" class="content-section hidden fade-in"><h2 class="text-3xl font-bold mb-6 text-gray-800">Estadísticas de Docentes</h2><div class="grid grid-cols-1 lg:grid-cols-2 gap-6"><div class="bg-white p-6 rounded-xl shadow-md"><h3 class="font-bold text-lg text-gray-700">Altas y Bajas (Último Semestre)</h3><canvas id="docentesChart" class="mt-4"></canvas></div></div></section>

                    <section id="formacion-docente" class="content-section hidden fade-in space-y-6">
    <h2 class="text-3xl font-bold text-gray-800">Formación Docente</h2>

    <div class="bg-white p-4 rounded-xl shadow-md">
        <label for="formacion-block-filter" class="text-sm font-medium text-gray-700 mr-2">Seleccionar Bloque para Resumen:</label>
        <select id="formacion-block-filter" class="rounded-md border-gray-300 shadow-sm"></select>
    </div>

    <div id="formacion-overview-container" class="space-y-6">

        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
           <div class="bg-white p-6 rounded-xl shadow-md">
    <p class="text-sm font-medium text-gray-500">Fase Gestión Más Frecuente</p>
    <p id="formacion-summary-mmr-gestion" class="text-3xl font-bold text-gray-800">N/A</p> </div>

<div class="bg-white p-6 rounded-xl shadow-md">
    <p class="text-sm font-medium text-gray-500">Fase Rigor Más Frecuente</p>
    <p id="formacion-summary-mmr-rigor" class="text-3xl font-bold text-gray-800">N/A</p> </div>
            <div class="bg-white p-6 rounded-xl shadow-md">
                <p class="text-sm font-medium text-gray-500">Total 1:1 (Bloque)</p>
                <p id="formacion-summary-1a1" class="text-3xl font-bold text-gray-800">0</p>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-md">
                <p class="text-sm font-medium text-gray-500">Total RSD (Bloque)</p>
                <p id="formacion-summary-rsd" class="text-3xl font-bold text-gray-800">0</p>
            </div>
        </div>

        <div class="bg-white p-6 rounded-xl shadow-md">
            <h3 id="nineBoxChartTitle" class="font-bold text-lg text-gray-700 mb-4">Distribución 9 Cajas (Bloque)</h3>
            <div class="flex items-center space-x-4">
                <div class="w-10 text-center text-xs font-medium text-gray-500 transform -rotate-90 whitespace-nowrap">Desempeño</div>
                <div class="flex-1 grid grid-cols-3 gap-1 border border-gray-300 p-1 rounded">
                    <div class="col-span-1 text-center text-xs font-medium text-gray-500">Bajo Potencial</div>
                    <div class="col-span-1 text-center text-xs font-medium text-gray-500">Medio Potencial</div>
                    <div class="col-span-1 text-center text-xs font-medium text-gray-500">Alto Potencial</div>

                    <div class="col-span-3 flex items-center">
                        <div class="w-10 text-right pr-2 text-xs font-medium text-gray-500">Alto</div>
                        <div class="flex-1 grid grid-cols-3 gap-1">
                            <div id="ninebox-high-low" class="h-20 bg-yellow-100 border border-yellow-300 rounded flex flex-col items-center justify-center text-center p-1"><span class="text-xs text-yellow-800 font-semibold">Profesional Alto (1C)</span><span class="text-2xl font-bold text-yellow-900">0</span></div>
                            <div id="ninebox-high-med" class="h-20 bg-green-100 border border-green-300 rounded flex flex-col items-center justify-center text-center p-1"><span class="text-xs text-green-800 font-semibold">Alto Rendimiento (1B)</span><span class="text-2xl font-bold text-green-900">0</span></div>
                            <div id="ninebox-high-high" class="h-20 bg-blue-100 border border-blue-300 rounded flex flex-col items-center justify-center text-center p-1"><span class="text-xs text-blue-800 font-semibold">Estrella (1A)</span><span class="text-2xl font-bold text-blue-900">0</span></div>
                        </div>
                    </div>

                     <div class="col-span-3 flex items-center">
                        <div class="w-10 text-right pr-2 text-xs font-medium text-gray-500">Medio</div>
                        <div class="flex-1 grid grid-cols-3 gap-1">
                            <div id="ninebox-med-low" class="h-20 bg-orange-100 border border-orange-300 rounded flex flex-col items-center justify-center text-center p-1"><span class="text-xs text-orange-800 font-semibold">Inconsistente (2C)</span><span class="text-2xl font-bold text-orange-900">0</span></div>
                            <div id="ninebox-med-med" class="h-20 bg-lime-100 border border-lime-300 rounded flex flex-col items-center justify-center text-center p-1"><span class="text-xs text-lime-800 font-semibold">Jugador Clave (2B)</span><span class="text-2xl font-bold text-lime-900">0</span></div>
                            <div id="ninebox-med-high" class="h-20 bg-teal-100 border border-teal-300 rounded flex flex-col items-center justify-center text-center p-1"><span class="text-xs text-teal-800 font-semibold">Alto Potencial (2A)</span><span class="text-2xl font-bold text-teal-900">0</span></div>
                        </div>
                    </div>

                     <div class="col-span-3 flex items-center">
                        <div class="w-10 text-right pr-2 text-xs font-medium text-gray-500">Bajo</div>
                        <div class="flex-1 grid grid-cols-3 gap-1">
                            <div id="ninebox-low-low" class="h-20 bg-red-100 border border-red-300 rounded flex flex-col items-center justify-center text-center p-1"><span class="text-xs text-red-800 font-semibold">Riesgo / Dilema (3C)</span><span class="text-2xl font-bold text-red-900">0</span></div>
                            <div id="ninebox-low-med" class="h-20 bg-rose-100 border border-rose-300 rounded flex flex-col items-center justify-center text-center p-1"><span class="text-xs text-rose-800 font-semibold">Enigma (3B)</span><span class="text-2xl font-bold text-rose-900">0</span></div>
                            <div id="ninebox-low-high" class="h-20 bg-purple-100 border border-purple-300 rounded flex flex-col items-center justify-center text-center p-1"><span class="text-xs text-purple-800 font-semibold">Diamante en Bruto (3A)</span><span class="text-2xl font-bold text-purple-900">0</span></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="text-center text-xs font-medium text-gray-500 mt-2 ml-10">Potencial</div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white p-6 rounded-xl shadow-md">
                <div>
                    <h3 id="mmrGestionChartTitle" class="font-bold text-lg text-gray-700">Distribución Fases - Gestión</h3>
                    <canvas id="mmrGestionChart" class="mt-4" style="max-height: 400px;"></canvas>
                </div>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-md">
                <div>
                    <h3 id="mmrRigorChartTitle" class="font-bold text-lg text-gray-700">Distribución Fases - Rigor</h3>
                    <canvas id="mmrRigorChart" class="mt-4" style="max-height: 400px;"></canvas>
                </div>
            </div>
        </div>
    </div> <hr class="my-6">

    <h3 class="text-2xl font-bold text-gray-800">Detalle por Docente</h3>
    <div class="bg-white p-4 rounded-xl shadow-md mb-6">
        <div class="flex flex-wrap gap-4 items-center">
            <h3 class="font-bold text-lg text-gray-700">Buscar Docente:</h3>
            <div>
                <label for="formacion-teacher-filter" class="text-sm font-medium text-gray-700 mr-2">Docente:</label>
                <select id="formacion-teacher-filter" class="rounded-md border-gray-300 shadow-sm"></select>
            </div>
            <div>
                <label for="formacion-block-filter-detail" class="text-sm font-medium text-gray-700 mr-2">Bloque:</label>
                <select id="formacion-block-filter-detail" class="rounded-md border-gray-300 shadow-sm"></select>
            </div>
        </div>
    </div>

    <div id="formacion-placeholder" class="text-center p-10 bg-white rounded-xl shadow-md">
        <i data-lucide="search" class="mx-auto h-12 w-12 text-gray-400"></i>
        <h3 class="mt-2 text-sm font-medium text-gray-900">Seleccione un docente</h3>
        <p class="mt-1 text-sm text-gray-500">Elija un docente y un bloque para ver sus datos de formación.</p>
    </div>

    <div id="formacion-detail-container" class="hidden space-y-6">
        <div class="bg-white p-6 rounded-xl shadow-md">
            <h3 id="formacion-docente-nombre" class="text-2xl font-bold text-gray-800 mb-4"></h3>
            <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4 mb-6">
                <div class="bg-indigo-50 p-6 rounded-xl shadow-sm border border-indigo-200 lg:col-span-2">
                    <p class="text-sm font-medium text-indigo-700">Última Clasificación 9 Cajas</p>
                    <p id="formacion-docente-9cajas" class="text-3xl font-bold text-indigo-900 mt-1">N/A</p>
                    <p class="text-xs text-gray-500 mt-1">*Último bloque registrado.</p>
                </div>
                <div class="bg-blue-50 p-4 rounded-xl">
                    <p class="text-sm font-medium text-blue-700">Fase MMR Gestión</p>
                    <p id="formacion-docente-mmr-gestion" class="text-2xl font-bold text-blue-900">N/A</p>
                </div>
                <div class="bg-green-50 p-4 rounded-xl">
                    <p class="text-sm font-medium text-green-700">Fase MMR Rigor</p>
                    <p id="formacion-docente-mmr-rigor" class="text-2xl font-bold text-green-900">N/A</p>
                </div>
                <div class="bg-yellow-50 p-4 rounded-xl">
                    <p class="text-sm font-medium text-yellow-700">Sesiones 1:1</p>
                    <p id="formacion-docente-1a1" class="text-2xl font-bold text-yellow-900">0</p>
                </div>
                <div class="bg-purple-50 p-4 rounded-xl">
                    <p class="text-sm font-medium text-purple-700">Sesiones RSD</p>
                    <p id="formacion-docente-rsd" class="text-2xl font-bold text-purple-900">0</p>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-gray-50 p-4 rounded-lg border">
                    <h4 class="font-semibold text-gray-700 mb-2">Detalle Fase Gestión Aula</h4>
                    <div id="formacion-docente-gestion-details" class="text-sm text-gray-600 space-y-2 prose prose-sm max-w-none">
                        <p>Seleccione un docente y bloque.</p>
                    </div>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg border">
                    <h4 class="font-semibold text-gray-700 mb-2">Detalle Fase Rigor Académico</h4>
                    <div id="formacion-docente-rigor-details" class="text-sm text-gray-600 space-y-2 prose prose-sm max-w-none">
                        <p>Seleccione un docente y bloque.</p>
                    </div>
                </div>
            </div>
        </div>
    </div> </section>
                    <section id="calificaciones" class="content-section hidden fade-in">
                        <h2 class="text-3xl font-bold mb-6 text-gray-800">Rendimiento Académico General</h2>
                        <div class="grid grid-cols-1 gap-6">
                            <div id="calificacionesMatematicas-container" class="bg-white p-6 rounded-xl shadow-md"><div class="flex flex-wrap justify-between items-center"><h3 class="font-bold text-lg text-gray-700">Promedio por Bloque: Matemáticas</h3><div class="mt-2 sm:mt-0"><span class="text-sm font-medium text-gray-500 mr-2">Nivel General:</span><span id="nivel-logro-matematicas" class="text-sm font-bold px-2 py-1 rounded-md"></span></div></div><canvas id="calificacionesMatematicasChart" class="mt-4"></canvas></div>
                            <div id="calificacionesEspanol-container" class="bg-white p-6 rounded-xl shadow-md"><div class="flex flex-wrap justify-between items-center"><h3 class="font-bold text-lg text-gray-700">Promedio por Bloque: Español</h3><div class="mt-2 sm:mt-0"><span class="text-sm font-medium text-gray-500 mr-2">Nivel General:</span><span id="nivel-logro-espanol" class="text-sm font-bold px-2 py-1 rounded-md"></span></div></div><canvas id="calificacionesEspanolChart" class="mt-4"></canvas></div>
                            <div id="calificacionesCiencias-container" class="bg-white p-6 rounded-xl shadow-md"><div class="flex flex-wrap justify-between items-center"><h3 class="font-bold text-lg text-gray-700">Promedio por Bloque: Ciencias</h3><div class="mt-2 sm:mt-0"><span class="text-sm font-medium text-gray-500 mr-2">Nivel General:</span><span id="nivel-logro-ciencias" class="text-sm font-bold px-2 py-1 rounded-md"></span></div></div><canvas id="calificacionesCienciasChart" class="mt-4"></canvas></div>
                            <div id="calificacionesIngles-container" class="bg-white p-6 rounded-xl shadow-md"><div class="flex flex-wrap justify-between items-center"><h3 class="font-bold text-lg text-gray-700">Promedio por Bloque: Inglés</h3><div class="mt-2 sm:mt-0"><span class="text-sm font-medium text-gray-500 mr-2">Nivel General:</span><span id="nivel-logro-ingles" class="text-sm font-bold px-2 py-1 rounded-md"></span></div></div><canvas id="calificacionesInglesChart" class="mt-4"></canvas></div>
                        </div>
                    </section>
                    <section id="calificaciones-grado" class="content-section hidden fade-in"><h2 class="text-3xl font-bold mb-6 text-gray-800">Calificaciones por Grado y Grupo</h2><div class="bg-white p-6 rounded-xl shadow-md"><div class="flex flex-wrap gap-4 mb-4 items-center justify-between"><div class="flex flex-wrap gap-4 items-center"><div><label for="grade-filter" class="text-sm font-medium text-gray-700 mr-2">Grado:</label><select id="grade-filter" class="rounded-md border-gray-300 shadow-sm"></select></div><div><label for="group-filter" class="text-sm font-medium text-gray-700 mr-2">Grupo:</label><select id="group-filter" class="rounded-md border-gray-300 shadow-sm"></select></div><div><label for="block-filter" class="text-sm font-medium text-gray-700 mr-2">Bloque:</label><select id="block-filter" class="rounded-md border-gray-300 shadow-sm"></select></div><div><label for="gender-filter-cal" class="text-sm font-medium text-gray-700 mr-2">Género:</label><select id="gender-filter-cal" class="rounded-md border-gray-300 shadow-sm"><option value="Todos">Todos</option><option value="Femenino">Femenino</option><option value="Masculino">Masculino</option></select></div></div><div class="text-right"><p class="text-sm font-medium text-gray-500">Estudiantes Filtrados</p><p id="student-count-grades" class="text-2xl font-bold text-gray-800">0</p></div></div><div class="grid grid-cols-1 lg:grid-cols-2 gap-6"><div><h3 class="font-bold text-lg text-gray-700 mb-2">Promedio por Materia</h3><canvas id="calificacionesGradoChart" class="mt-4"></canvas></div><div><h3 class="font-bold text-lg text-gray-700 mb-2">Distribución de Niveles de Logro</h3><canvas id="nivelLogroChart" class="mt-4"></canvas></div></div></div></section>
                    <section id="boletos-salida" class="content-section hidden fade-in"><h2 class="text-3xl font-bold mb-6 text-gray-800">Análisis de Boletos de Salida</h2><div class="bg-white p-6 rounded-xl shadow-md"><div class="flex flex-wrap gap-4 mb-4 items-center"><div><label for="boleto-block-filter" class="text-sm font-medium text-gray-700 mr-2">Bloque:</label><select id="boleto-block-filter" class="rounded-md border-gray-300 shadow-sm"></select></div><div><label for="boleto-grade-filter" class="text-sm font-medium text-gray-700 mr-2">Grado:</label><select id="boleto-grade-filter" class="rounded-md border-gray-300 shadow-sm"></select></div><div><label for="boleto-group-filter" class="text-sm font-medium text-gray-700 mr-2">Grupo:</label><select id="boleto-group-filter" class="rounded-md border-gray-300 shadow-sm"></select></div><div><label for="boleto-subject-filter" class="text-sm font-medium text-gray-700 mr-2">Materia:</label><select id="boleto-subject-filter" class="rounded-md border-gray-300 shadow-sm"></select></div></div><div id="boletos-chart-container"><canvas id="boletosSalidaChart"></canvas></div><div id="boletos-no-data" class="text-center p-10 hidden"><i data-lucide="info" class="mx-auto h-12 w-12 text-gray-400"></i><h3 class="mt-2 text-sm font-medium text-gray-900">Sin datos</h3><p class="mt-1 text-sm text-gray-500">No hay resultados para la selección actual.</p></div></div></section>
                    <section id="expediente-estudiante" class="content-section hidden fade-in">
                        <h2 class="text-3xl font-bold mb-6 text-gray-800">Expediente del Estudiante</h2>
                        <div class="bg-white p-4 rounded-xl shadow-md mb-6"><div class="flex flex-wrap gap-4 items-center"><h3 class="font-bold text-lg text-gray-700">Buscar Estudiante:</h3><div><label for="expediente-grade-filter" class="text-sm font-medium text-gray-700 mr-2">Grado:</label><select id="expediente-grade-filter" class="rounded-md border-gray-300 shadow-sm"></select></div><div><label for="expediente-group-filter" class="text-sm font-medium text-gray-700 mr-2">Grupo:</label><select id="expediente-group-filter" class="rounded-md border-gray-300 shadow-sm"></select></div><div><label for="expediente-student-filter" class="text-sm font-medium text-gray-700 mr-2">Estudiante:</label><select id="expediente-student-filter" class="rounded-md border-gray-300 shadow-sm"></select></div></div></div>
                        <div id="expediente-placeholder" class="text-center p-10 bg-white rounded-xl shadow-md"><i data-lucide="search" class="mx-auto h-12 w-12 text-gray-400"></i><h3 class="mt-2 text-sm font-medium text-gray-900">Seleccione un estudiante</h3><p class="mt-1 text-sm text-gray-500">Elija grado, grupo y estudiante para ver su expediente.</p></div>
                        <div id="expediente-container" class="hidden space-y-6">
                            <div class="bg-white p-6 rounded-xl shadow-md">
                                <div class="flex justify-between items-center">
                                    <h3 id="expediente-nombre" class="text-2xl font-bold text-gray-800"></h3>
                                    <button id="download-pdf-button" class="bg-green-500 text-white px-4 py-2 rounded shadow hover:bg-green-600 flex items-center space-x-2 transition-colors">
                                        <i data-lucide="download" class="h-5 w-5"></i>
                                        <span>Generar PDF</span>
                                    </button>
                                </div>
                                <div class="mt-4 grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-y-4 gap-x-2 text-center items-center"><div><p class="text-sm font-medium text-gray-500">Grado y Grupo</p><p id="expediente-grupo" class="text-lg font-semibold text-gray-700"></p></div><div><p class="text-sm font-medium text-gray-500">Género</p><p id="expediente-genero" class="text-lg font-semibold text-gray-700"></p></div><div><p class="text-sm font-medium text-gray-500">Clave Escolar</p><p id="expediente-clave" class="text-lg font-semibold text-gray-700"></p></div><div><p class="text-sm font-medium text-gray-500">Estatus</p><p id="expediente-estatus" class="text-lg font-semibold text-gray-700"></p></div><div><p class="text-sm font-medium text-gray-500">Diagnóstico BAP</p><p id="expediente-bap" class="text-lg font-semibold text-gray-700"></p></div></div>
                                <hr class="my-4">
                                <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-y-4 gap-x-2 text-center"><div><p class="text-sm font-medium text-gray-500">Promedio General</p><p id="expediente-promedio" class="text-lg font-semibold text-gray-700"></p></div><div><p class="text-sm font-medium text-gray-500">Nivel de Logro</p><p id="expediente-nivel-logro" class="text-base font-bold px-2 py-1 rounded-md inline-block align-middle"></p></div></div>
                                <hr class="my-4">
                                <div id="expediente-filter-container" class="flex justify-end items-center mb-4">
                                    <label for="expediente-block-filter" class="text-sm font-medium text-gray-700 mr-2">Filtrar por Bloque:</label>
                                    <select id="expediente-block-filter" class="rounded-md border-gray-300 shadow-sm"></select>
                                </div>
                                <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-y-4 gap-x-2 text-center">
                                    <div id="expediente-prom-mat-container">
                                        <p class="text-sm font-medium text-gray-500">Prom. Matemáticas</p>
                                        <div class="flex items-center justify-center mt-1 space-x-2"><i data-lucide="function-square" class="h-6 w-6 text-yellow-500"></i><p id="expediente-prom-mat" class="text-lg font-semibold text-gray-700"></p></div>
                                        <p id="expediente-nivel-mat" class="text-xs font-bold px-2 py-0.5 rounded-md inline-block mt-1 align-middle"></p>
                                    </div>
                                    <div id="expediente-prom-esp-container">
                                        <p class="text-sm font-medium text-gray-500">Prom. Español</p>
                                        <div class="flex items-center justify-center mt-1 space-x-2"><i data-lucide="pilcrow" class="h-6 w-6 text-purple-500"></i><p id="expediente-prom-esp" class="text-lg font-semibold text-gray-700"></p></div>
                                        <p id="expediente-nivel-esp" class="text-xs font-bold px-2 py-0.5 rounded-md inline-block mt-1 align-middle"></p>
                                    </div>
                                    <div id="expediente-prom-cie-container">
                                        <p class="text-sm font-medium text-gray-500">Prom. Ciencias</p>
                                        <div class="flex items-center justify-center mt-1 space-x-2"><i data-lucide="flask-conical" class="h-6 w-6 text-green-500"></i><p id="expediente-prom-cie" class="text-lg font-semibold text-gray-700"></p></div>
                                        <p id="expediente-nivel-cie" class="text-xs font-bold px-2 py-0.5 rounded-md inline-block mt-1 align-middle"></p>
                                    </div>
                                    <div id="expediente-prom-ing-container">
                                        <p class="text-sm font-medium text-gray-500">Prom. Inglés</p>
                                        <div class="flex items-center justify-center mt-1 space-x-2"><i data-lucide="languages" class="h-6 w-6 text-blue-500"></i><p id="expediente-prom-ing" class="text-lg font-semibold text-gray-700"></p></div>
                                        <p id="expediente-nivel-ing" class="text-xs font-bold px-2 py-0.5 rounded-md inline-block mt-1 align-middle"></p>
                                    </div>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <div class="bg-white p-6 rounded-xl shadow-md"><h3 class="font-bold text-lg text-gray-700">Comparativa de Materias</h3><canvas id="expedienteRadarChart" class="mt-4"></canvas></div>
                                <div class="bg-white p-6 rounded-xl shadow-md"><h3 class="font-bold text-lg text-gray-700">Evolución de Calificaciones por Bloque</h3><canvas id="expedienteCalificacionesChart" class="mt-4"></canvas></div>
                                <div class="bg-white p-6 rounded-xl shadow-md lg:col-span-2"><h3 class="font-bold text-lg text-gray-700">Historial de Asistencia Mensual</h3><canvas id="expedienteAsistenciaChart" class="mt-4"></canvas></div>
                            </div>
                        </div>
                    </section>
                    <section id="asistencia-padres" class="content-section hidden fade-in space-y-6">
                        <h2 class="text-3xl font-bold text-gray-800">Escuela para Padres</h2>

                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                            <div class="bg-white p-6 rounded-xl shadow-md flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-500">Asistencia Promedio</p>
                                    <p id="padres-promedio-asistencia" class="text-3xl font-bold text-gray-800">0%</p>
                                </div>
                                <div class="bg-teal-100 p-3 rounded-full"><i data-lucide="pie-chart" class="h-6 w-6 text-teal-500"></i></div>
                            </div>
                            <div class="bg-white p-6 rounded-xl shadow-md">
                                <p class="text-sm font-medium text-gray-500">Sesión con Mayor Asistencia 🏆</p>
                                <p id="padres-mejor-sesion" class="text-xl font-bold text-gray-800 mt-2 truncate" title="N/A">N/A</p>
                            </div>
                            <div class="bg-white p-6 rounded-xl shadow-md">
                                <p class="text-sm font-medium text-gray-500">Sesión con Menor Asistencia</p>
                                <p id="padres-peor-sesion" class="text-xl font-bold text-gray-800 mt-2 truncate" title="N/A">N/A</p>
                            </div>
                            <div class="bg-white p-6 rounded-xl shadow-md flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-500">Total de Asistencias</p>
                                    <p id="padres-total-asistentes" class="text-3xl font-bold text-gray-800">0</p>
                                </div>
                                <div class="bg-blue-100 p-3 rounded-full"><i data-lucide="users" class="h-6 w-6 text-blue-500"></i></div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="bg-white p-6 rounded-xl shadow-md">
                                <h3 class="font-bold text-lg text-gray-700">Asistencia por Sesión</h3>
                                <canvas id="asistenciaPadresChart" class="mt-4"></canvas>
                            </div>
                            <div class="bg-white p-6 rounded-xl shadow-md">
                                <h3 class="font-bold text-lg text-gray-700">Tendencia de Asistencia</h3>
                                <canvas id="asistenciaPadresTrendChart" class="mt-4"></canvas>
                            </div>
                        </div>

                        <div class="bg-white p-6 rounded-xl shadow-md">
                            <h3 class="font-bold text-lg text-gray-700 mb-4">Detalle de Sesiones</h3>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"># Sesión</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Título de la Sesión</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Asistentes / Esperados</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">% Asistencia</th>
                                        </tr>
                                    </thead>
                                    <tbody id="padres-sesiones-tabla" class="bg-white divide-y divide-gray-200">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </section>

                    <section id="desarrollo-profesional" class="content-section hidden fade-in space-y-6">
                        <h2 class="text-3xl font-bold text-gray-800">Desarrollo Profesional</h2>
                        <div class="bg-white p-6 rounded-xl shadow-md">
                            <h3 class="font-bold text-lg text-gray-700 mb-4">Sesiones Impartidas</h3>

                            <div id="desarrollo-profesional-placeholder" class="text-center p-10 hidden">
                                <i data-lucide="info" class="mx-auto h-12 w-12 text-gray-400"></i>
                                <h3 class="mt-2 text-sm font-medium text-gray-900">Sin datos</h3>
                                <p class="mt-1 text-sm text-gray-500">No se encontraron sesiones de desarrollo profesional con fecha.</p>
                            </div>

                            <div id="desarrollo-profesional-tabla-container" class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Bloque</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tema</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Brecha</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Objetivo</th>
                                        </tr>
                                    </thead>
                                    <tbody id="desarrollo-profesional-tabla-body" class="bg-white divide-y divide-gray-200">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </section>

                </div>
            </main>
        </div>
    </div>

    <script>
        const CLIENT_ID = '207428727335-bfsgio74gs2irr3o1va1ts1jspti0gsh.apps.googleusercontent.com'; // <-- REEMPLAZA ESTO
        const MASTER_SHEET_ID = '1HsjHb-zuhHrblvvLoH3jnIaUn9nTir85GTyL8-A60QA'; // <-- REEMPLAZA ESTO
        const API_KEY = 'AIzaSyAXZJv4EUDUgppHvWvtkuFGtz95ogAXkF8'; // <-- REEMPLAZA ESTO

        let SELECTED_SPREADSHEET_ID = null;
        const SCOPES = 'https://www.googleapis.com/auth/spreadsheets.readonly https://www.googleapis.com/auth/userinfo.email';

        const SHEET_RANGES = {
            permisos: 'Permisos!A:Z',
            alumnos: 'Alumnos!A:Z',
            calificaciones: 'Calificaciones!A:Z',
            asistencia: 'Asistencia!A:Z',
            boletos: 'Boletos!A:Z',
            docentes: 'Docentes!A:Z',
            asistenciaPadres: 'AsistenciaPadres!A:Z',
            matricula: 'Matricula!A:Z',
            entregables: 'Entregables!A:Z',
            desarrolloProfesional: 'DesarrolloProfesional!A:Z',
            palancas: 'Palancas!A:Z' // <-- RANGO AÑADIDO
        };
        const MESES_MAP = ["", "Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
        const SCHOOL_YEAR_MONTH_ORDER = ["Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre", "Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio"];

        let tokenClient;
        let gapiInited = false, gisInited = false;

        document.getElementById('login-button').onclick = handleAuthClick;
        document.getElementById('signout_button').onclick = handleSignoutClick;

        function gapiLoaded() { gapi.load('client', initializeGapiClient); }
        function gisLoaded() {
            console.log("GIS Client Cargado."); // Log
            tokenClient = google.accounts.oauth2.initTokenClient({ client_id: CLIENT_ID, scope: SCOPES, callback: '', });
            gisInited = true;
            maybeEnableButtons();
        }

        async function initializeGapiClient() {
            await gapi.client.init({
                apiKey: API_KEY,
                discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4'],
            });
            console.log("GAPI Client Inicializado."); // Log
            gapiInited = true;
            maybeEnableButtons();
        }

        async function loadSchoolList() {
            console.log("Intentando cargar lista de escuelas..."); // Log
            let attempts = 0;
            while ((typeof gapi === 'undefined' || !gapi?.client?.sheets?.spreadsheets) && attempts < 10) {
                 console.warn(`gapi.client.sheets no está listo (intento ${attempts + 1}). Esperando 500ms...`);
                 await new Promise(resolve => setTimeout(resolve, 500));
                 attempts++;
            }
            if (!gapi?.client?.sheets?.spreadsheets) {
                 console.error("ERROR CRÍTICO: La API de Google Sheets no se inicializó después de varios intentos.");
                 alert("Error: No se pudo conectar con la API de Google Sheets. Por favor, recarga la página.");
                 document.getElementById('school-selector').innerHTML = '<option>Error de conexión API</option>';
                 return;
            }
            try {
                console.log("API lista. Obteniendo datos de escuelas..."); // Log
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: MASTER_SHEET_ID,
                    range: 'Escuelas!A2:C',
                });
                const schoolSelector = document.getElementById('school-selector');
                const loginButton = document.getElementById('login-button');
                schoolSelector.innerHTML = '<option value="">-- Por favor, selecciona --</option>';
                const schools = response.result.values || [];
                if (schools.length > 0) {
                    schools.forEach(school => {
                        const schoolName = school[0];
                        const spreadsheetId = school[1];
                        const logoUrl = school[2];
                        if (schoolName && spreadsheetId) {
                            const option = document.createElement('option');
                            option.value = spreadsheetId;
                            option.textContent = schoolName;
                            if (logoUrl) {
                                option.dataset.logoUrl = logoUrl;
                            }
                            schoolSelector.appendChild(option);
                        }
                    });
                    schoolSelector.disabled = false;
                    loginButton.disabled = true;
                    loginButton.classList.add('opacity-50', 'cursor-not-allowed');
                    schoolSelector.addEventListener('change', () => {
                        if (schoolSelector.value) {
                            loginButton.disabled = false;
                            loginButton.classList.remove('opacity-50', 'cursor-not-allowed');
                        } else {
                            loginButton.disabled = true;
                            loginButton.classList.add('opacity-50', 'cursor-not-allowed');
                        }
                    });
                } else {
                    schoolSelector.innerHTML = '<option>No se encontraron escuelas</option>';
                }
            } catch (error) {
                console.error("Error DETALLADO al cargar la lista de escuelas:", error);
                document.getElementById('school-selector').innerHTML = '<option>Error al cargar</option>';
                alert("No se pudo cargar la lista de escuelas. Revisa que el ID de la Hoja Maestra y la Clave de API sean correctos y que la hoja sea pública o compartida.");
            }
        }

        function maybeEnableButtons() {
            console.log("Llamando a maybeEnableButtons. gapiInited:", gapiInited, "gisInited:", gisInited); // Log
            if (gapiInited && gisInited) {
                loadSchoolList();
                lucide.createIcons();
            }
        }

        function handleAuthClick() {
            const schoolSelector = document.getElementById('school-selector');
            const selectedOption = schoolSelector.options[schoolSelector.selectedIndex];
            const logoUrl = selectedOption.dataset.logoUrl;
            const schoolName = selectedOption.textContent;
            SELECTED_SPREADSHEET_ID = schoolSelector.value;
            if (!SELECTED_SPREADSHEET_ID) {
                alert('Por favor, selecciona una escuela antes de iniciar sesión.');
                return;
            }
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                    alert("Error de autenticación. Por favor, intenta de nuevo.");
                    console.error(resp);
                    return;
                }
                gapi.client.setToken(resp);
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app-wrapper').classList.remove('hidden');
                document.getElementById('signout_button').classList.remove('hidden');
                const sidebarLogo = document.getElementById('school-logo-sidebar');
                const defaultIcon = document.getElementById('default-icon');
                if (logoUrl && sidebarLogo) {
                    sidebarLogo.src = logoUrl;
                    sidebarLogo.classList.remove('hidden');
                    if (defaultIcon) defaultIcon.classList.add('hidden');
                } else {
                    if (sidebarLogo) sidebarLogo.classList.add('hidden');
                    if (defaultIcon) defaultIcon.classList.remove('hidden');
                }
                const schoolNameHeader = document.getElementById('school-name-header');
                if (schoolNameHeader) {
                    schoolNameHeader.textContent = schoolName;
                    schoolNameHeader.classList.remove('hidden');
                }
                const userInfoResponse = await fetch('https://www.googleapis.com/oauth2/v3/userinfo', {
                    headers: { 'Authorization': `Bearer ${gapi.client.getToken().access_token}` }
                });
                const userInfo = await userInfoResponse.json();
                const userInfoEl = document.getElementById('user-info');
                userInfoEl.textContent = userInfo.email;
                userInfoEl.classList.remove('hidden');
                await loadAndProcessData(userInfo.email);
            };
            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({ prompt: 'consent' });
            } else {
                tokenClient.requestAccessToken({ prompt: '' });
            }
        }

        function handleSignoutClick() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken('');
                const sidebarLogo = document.getElementById('school-logo-sidebar');
                const defaultIcon = document.getElementById('default-icon');
                if (sidebarLogo) {
                    sidebarLogo.src = '';
                    sidebarLogo.classList.add('hidden');
                }
                if (defaultIcon) {
                    defaultIcon.classList.remove('hidden');
                }
                const schoolNameHeader = document.getElementById('school-name-header');
                if (schoolNameHeader) {
                    schoolNameHeader.textContent = '';
                    schoolNameHeader.classList.add('hidden');
                }
                document.getElementById('app-wrapper').classList.add('hidden');
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('main-container').classList.add('hidden');
                document.getElementById('unauthorized-message').classList.add('hidden');
                document.getElementById('loading-indicator').classList.add('hidden');
                document.getElementById('signout_button').classList.add('hidden');
                document.getElementById('user-info').classList.add('hidden');
                document.querySelectorAll('.nav-link').forEach(link => link.style.display = 'none');
                SELECTED_SPREADSHEET_ID = null;
                const schoolSelector = document.getElementById('school-selector');
                if(schoolSelector) {
                    schoolSelector.selectedIndex = 0;
                }
                 const loginButton = document.getElementById('login-button');
                if(loginButton) {
                     loginButton.disabled = true;
                     loginButton.classList.add('opacity-50', 'cursor-not-allowed');
                }
            }
        }

        function sheetsArrayToJson(dataArray) { if (!dataArray || dataArray.length < 2) return []; const headers = dataArray[0]; const jsonData = []; for (let i = 1; i < dataArray.length; i++) { const row = dataArray[i]; if (row.length === 0 || row.every(cell => !cell || cell.trim() === '')) continue; const obj = {}; for (let j = 0; j < headers.length; j++) { obj[headers[j]] = row[j]; } jsonData.push(obj); } return jsonData; }

        async function loadAndProcessData(userEmail) {
            const loadingIndicator = document.getElementById('loading-indicator');
            const unauthorizedMessage = document.getElementById('unauthorized-message');
            loadingIndicator.classList.remove('hidden');
            document.getElementById('main-container').classList.add('hidden');
            unauthorizedMessage.classList.add('hidden');
            try {
                let attempts = 0;
                while ((typeof gapi === 'undefined' || !gapi?.client?.sheets?.spreadsheets?.values) && attempts < 10) {
                     console.warn(`gapi.client.sheets.values no está listo en loadAndProcessData (intento ${attempts + 1}). Esperando 500ms...`);
                     await new Promise(resolve => setTimeout(resolve, 500));
                     attempts++;
                }
                if (!gapi?.client?.sheets?.spreadsheets?.values) {
                     throw new Error("La API de Google Sheets no se inicializó correctamente para batchGet.");
                }
                const response = await gapi.client.sheets.spreadsheets.values.batchGet({
                    spreadsheetId: SELECTED_SPREADSHEET_ID,
                    ranges: Object.values(SHEET_RANGES),
                });
                const jsonData = {};
                Object.keys(SHEET_RANGES).forEach((key, index) => {
                    jsonData[key] = sheetsArrayToJson(response.result.valueRanges[index]?.values || []);
                });
                const permissionsList = jsonData.permisos || [];
                let userPermissions = permissionsList.find(p => p.Email && p.Email.toLowerCase() === userEmail.toLowerCase());
                if (!userPermissions) {
                    loadingIndicator.classList.add('hidden');
                    unauthorizedMessage.classList.remove('hidden');
                    console.warn(`Usuario ${userEmail} no encontrado en la hoja de Permisos.`);
                    handleSignoutClick();
                    alert('Acceso Denegado. Tu cuenta no tiene permisos para ver este tablero.');
                    return;
                }
                const data = (jsonData.alumnos.length === 0) ? getDemoData() : processRealData(jsonData);
                main(data, userPermissions);
                loadingIndicator.classList.add('hidden');
                document.getElementById('main-container').classList.remove('hidden');
            } catch (error) {
                console.error("Error al cargar datos o permisos desde la API:", error);
                loadingIndicator.innerHTML = `<i data-lucide="alert-triangle" class="mx-auto h-12 w-12 text-red-500"></i><h3 class="mt-2 text-sm font-medium text-gray-900">Error al cargar datos</h3><p class="mt-1 text-sm text-gray-500">No se pudo obtener la información. Revisa que la hoja de cálculo sea correcta y tengas permiso para verla.<br>(${error.message || 'Error desconocido'})</p>`;
                lucide.createIcons();
            }
        }

        function processRealData(jsonData) {
            const data = {
                resumenGeneral: {},
                resumenMensual: [],
                resumenPorBloque: [],
                estudiantes: {},
                docentes: {},
                asistenciaPadres: [],
                entregables: [],
                desarrolloProfesional: [],
                formacionDocente: { docentes: [], bloques: [] } // <-- OBJETO INICIALIZADO
            };
            const validAlumnos = jsonData.alumnos.filter(a => a.id && a.clave_escolar && a.nombre && a.nombre.trim() !== '');
            const validStudentKeys = new Set(validAlumnos.map(a => a.clave_escolar));
            const validCalificaciones = jsonData.calificaciones.filter(c => validStudentKeys.has(c.clave_escolar));
            const validAsistencia = jsonData.asistencia.filter(a => validStudentKeys.has(a.clave_escolar));
            const validBoletos = jsonData.boletos.filter(b => validStudentKeys.has(b.clave_escolar));

            data.listaEstudiantes = validAlumnos.map(alumno => {
                const clave = alumno.clave_escolar, id = alumno.id, calificaciones = {}, asistencia = {}, boletos = {};
                validCalificaciones.filter(c => c.clave_escolar === clave).forEach(c => { if (c.calificacion && c.bloque && c.materia) { const grade = parseFloat(String(c.calificacion).replace(',', '.')); if (!isNaN(grade)) { const subjectKey = c.materia.toLowerCase().substring(0, 1); if (!calificaciones[c.bloque]) calificaciones[c.bloque] = {}; calificaciones[c.bloque][subjectKey] = grade; } } });
                const studentAttendanceRecord = validAsistencia.find(row => row.clave_escolar === clave);
                if (studentAttendanceRecord) { for (const monthName in studentAttendanceRecord) { if (monthName.toLowerCase() !== 'clave_escolar' && studentAttendanceRecord[monthName]) { const monthNumber = MESES_MAP.findIndex(m => m.toLowerCase() === monthName.toLowerCase()); if (monthNumber > 0) { const percentage = parseFloat(String(studentAttendanceRecord[monthName]).replace('%', '')); if (!isNaN(percentage)) { asistencia[monthNumber] = percentage; } } } } }
                validBoletos.filter(b => b.clave_escolar === clave).forEach(b => { if (b.bloque && b.materia && b.fecha && b.calificacion) { if (!boletos[b.bloque]) boletos[b.bloque] = {}; if (!boletos[b.bloque][b.materia]) boletos[b.bloque][b.materia] = []; boletos[b.bloque][b.materia].push({ date: b.fecha, score: parseInt(b.calificacion) }); } });
                return { id, clave_escolar: clave, nombre: alumno.nombre, genero: alumno.genero, grado: alumno.grado, grupo: alumno.grupo, status: (String(alumno.status).toLowerCase() === 'baja') ? 'baja' : 'activo', motivoBaja: alumno.motivoBaja, bap: (String(alumno.bap).toLowerCase() === 'true') ? 'Sí' : 'No', calificaciones, asistencia, boletos };
            });

            const subjects = [...new Set(validCalificaciones.map(c => c.materia))], blocks = [...new Set(validCalificaciones.map(c => c.bloque))].sort(), subjectKeyMap = { "Matemáticas": "matematicas", "Español": "espanol", "Ciencias": "ciencias", "Inglés": "ingles" };
            data.calificaciones = { bloques: blocks };
            subjects.forEach(subject => { const subjectKey = subjectKeyMap[subject]; if (!subjectKey) return; data.calificaciones[subjectKey] = []; blocks.forEach(block => { const gradesForBlock = validCalificaciones.filter(c => c.bloque === block && c.materia === subject).map(c => parseFloat(String(c.calificacion).replace(',', '.'))).filter(g => !isNaN(g)); data.calificaciones[subjectKey].push(gradesForBlock.length > 0 ? gradesForBlock.reduce((a, b) => a + b, 0) / gradesForBlock.length : 0); }); });

            if (jsonData.matricula && jsonData.matricula.length > 0) {
                data.resumenMensual = jsonData.matricula.map(m => { const monthName = MESES_MAP[parseInt(m.mes)] || m.mes; const monthNumber = MESES_MAP.indexOf(monthName); let monthlyAttendanceTotal = 0; let studentCountForMonth = 0; if (monthNumber > 0) { data.listaEstudiantes.forEach(student => { if (student.status === 'activo' && student.asistencia && student.asistencia[monthNumber] !== undefined) { monthlyAttendanceTotal += student.asistencia[monthNumber]; studentCountForMonth++; } }); } const avgMonthlyAttendance = studentCountForMonth > 0 ? monthlyAttendanceTotal / studentCountForMonth : 0; return { periodo: monthName, matricula: parseInt(m.matricula) || 0, asistencia: avgMonthlyAttendance }; }).sort((a, b) => (SCHOOL_YEAR_MONTH_ORDER.indexOf(a.periodo) - SCHOOL_YEAR_MONTH_ORDER.indexOf(b.periodo)));
                data.resumenGeneral.matricula = data.resumenMensual[data.resumenMensual.length - 1]?.matricula || 0; data.estudiantes.meses = data.resumenMensual.map(m => m.periodo); data.estudiantes.matricula = data.resumenMensual.map(m => m.matricula);
            } else { data.resumenGeneral.matricula = data.listaEstudiantes.filter(s => s.status === 'activo').length; data.estudiantes.meses = []; data.estudiantes.matricula = []; }

            data.resumenPorBloque = blocks.map(block => { const blockSummary = { bloque: block }; subjects.forEach(subject => { const subjectKey = `prom_${subjectKeyMap[subject]}`; if (subjectKey && !subjectKey.endsWith('undefined')) { const gradesInBlock = validCalificaciones.filter(c => c.bloque === block && c.materia === subject).map(c => parseFloat(String(c.calificacion).replace(',', '.'))).filter(g => !isNaN(g)); blockSummary[subjectKey] = gradesInBlock.length > 0 ? gradesInBlock.reduce((a, b) => a + b, 0) / gradesInBlock.length : 0; } }); return blockSummary; });

            data.resumenGeneral.bajas = data.listaEstudiantes.filter(s => s.status === 'baja').length; data.resumenGeneral.alumnosBAP = data.listaEstudiantes.filter(s => s.bap === 'Sí' && s.status === 'activo').length;
            subjects.forEach(subject => { const subjectKey = `prom_${subjectKeyMap[subject]}`; const allGrades = validCalificaciones.filter(c => c.materia === subject).map(c => parseFloat(String(c.calificacion).replace(',', '.'))).filter(g => !isNaN(g)); data.resumenGeneral[subjectKey] = allGrades.length > 0 ? allGrades.reduce((a, b) => a + b, 0) / allGrades.length : 0; });

            const allActiveStudentAttendanceValues = [];
            data.listaEstudiantes.forEach(student => {
                if (student.status === 'activo' && student.asistencia) {
                    Object.values(student.asistencia).forEach(percentage => {
                        if (!isNaN(percentage)) {
                            allActiveStudentAttendanceValues.push(percentage);
                        }
                    });
                }
            });
            data.resumenGeneral.asistencia = allActiveStudentAttendanceValues.length > 0 ? allActiveStudentAttendanceValues.reduce((a, b) => a + b, 0) / allActiveStudentAttendanceValues.length : 0;

            if(jsonData.docentes && jsonData.docentes.length > 0) { data.docentes = { altas: jsonData.docentes.map(d => parseInt(d.altas) || 0), bajas: jsonData.docentes.map(d => parseInt(d.bajas) || 0), meses: jsonData.docentes.map(d => MESES_MAP[parseInt(d.mes)] || d.mes) }; data.resumenGeneral.docentes = jsonData.docentes.length; } else { data.docentes = {altas: [], bajas: [], meses: []}; data.resumenGeneral.docentes = 0; }

            if (jsonData.asistenciaPadres && jsonData.asistenciaPadres.length > 0) {
                data.asistenciaPadres = jsonData.asistenciaPadres
                    .filter(d => d.asistentes != null && String(d.asistentes).trim() !== '')
                    .map(d => ({
                        sesion: parseInt(d.sesion) || 0,
                        porcentaje_asistencia: parseFloat(String(d.porcentaje_asistencia).replace('%', '')) || 0,
                        fecha: d.fecha || 'N/A',
                        titulo_sesion: d.titulo_sesion || `Sesión ${d.sesion}`,
                        esperados: parseInt(d.esperados) || 0,
                        asistentes: parseInt(d.asistentes) || 0,
                    })).sort((a, b) => a.sesion - b.sesion);

                const allPercentages = data.asistenciaPadres.map(d => d.porcentaje_asistencia).filter(p => p > 0);
                if (allPercentages.length > 0) {
                    const avgParentAttendance = allPercentages.reduce((sum, current) => sum + current, 0) / allPercentages.length;
                    data.resumenGeneral.prom_asistencia_padres = avgParentAttendance;
                } else {
                    data.resumenGeneral.prom_asistencia_padres = 0;
                }
            } else {
                data.asistenciaPadres = [];
                data.resumenGeneral.prom_asistencia_padres = 0;
            }

            data.entregables = (jsonData.entregables || []).filter(e => e.Categoria && e.NombreEntregable && e.FechaLimite);

            if (jsonData.desarrolloProfesional && jsonData.desarrolloProfesional.length > 0) {
                data.desarrolloProfesional = jsonData.desarrolloProfesional
                    .filter(sesion => sesion.fecha && String(sesion.fecha).trim() !== '')
                    .map(sesion => {
                        const parts = String(sesion.fecha).split('/');
                        let fechaObj = null;
                        if (parts.length === 3) {
                            const day = parseInt(parts[0], 10);
                            const month = parseInt(parts[1], 10) - 1;
                            const year = parseInt(parts[2], 10);
                            if (!isNaN(day) && !isNaN(month) && !isNaN(year)) {
                                const fullYear = (year < 100) ? 2000 + year : year;
                                fechaObj = new Date(fullYear, month, day);
                            }
                        }
                        return {
                            bloque: sesion.bloque || 'N/A',
                            fecha: sesion.fecha,
                            fechaObj: fechaObj,
                            brecha: sesion.brecha || 'N/A',
                            tema: sesion.tema || 'N/A',
                            objetivo: sesion.objetivo || 'N/A'
                        };
                    })
                    .sort((a, b) => {
                        if (a.fechaObj && b.fechaObj) {
                            return b.fechaObj - a.fechaObj;
                        }
                        if (a.fechaObj) return -1;
                        if (b.fechaObj) return 1;
                        return 0;
                    });
            } else {
                data.desarrolloProfesional = [];
            }

            // ======================================================
            // =========== INICIO: PROCESAR DATOS PALANCAS ==========
            // ======================================================
            if (jsonData.palancas && jsonData.palancas.length > 0) {
                const bloquesDisponibles = new Set();
                const docentesData = jsonData.palancas
                    .filter(row => row['Nombre del Docente'] && row['Nombre del Docente'].trim() !== '') // Filtrar docentes sin nombre
                    .map(row => {
                        const docente = {
                            nombre: row['Nombre del Docente'],
                            bloques: {},
                            latest9Cajas: 'N/A'
                        };

                        let latest9CajasVal = 'N/A';

                        // Iterar por los 6 bloques
                        for (let i = 1; i <= 6; i++) {
                            const bloqueKey = `Bloque ${i}`;
                            const gestionKey = `Bloque ${i} - MMR Gestión`;
                            const rigorKey = `Bloque ${i} - MMR Rigor`;
                            const rsdKey = `Bloque ${i} - RSD`;
                            const oaoKey = `Bloque ${i} - 1:1`; // 1:1
                            const cajasKey = `Bloque ${i} - 9 Cajas`;

                            // Solo añadir el bloque si tiene al menos un dato
                            if (row[gestionKey] || row[rigorKey] || row[rsdKey] || row[oaoKey] || row[cajasKey]) {
                                bloquesDisponibles.add(bloqueKey);
                                docente.bloques[bloqueKey] = {
                                    gestion: row[gestionKey] || 'N/A',
                                    rigor: row[rigorKey] || 'N/A',
                                    rsd: parseInt(row[rsdKey]) || 0,
                                    oao: parseInt(row[oaoKey]) || 0, // 1:1
                                    cajas: row[cajasKey] || 'N/A'
                                };

                                // Actualizar el último valor de 9 Cajas encontrado
                                if (row[cajasKey] && row[cajasKey].trim() !== '') {
                                    latest9CajasVal = row[cajasKey];
                                }
                            }
                        }
                        docente.latest9Cajas = latest9CajasVal;
                        return docente;
                    });

                data.formacionDocente = {
                    docentes: docentesData.sort((a, b) => a.nombre.localeCompare(b.nombre)),
                    bloques: [...bloquesDisponibles].sort((a, b) => { // Ordenar bloques numéricamente
                         const numA = parseInt(a.replace('Bloque ', ''));
                         const numB = parseInt(b.replace('Bloque ', ''));
                         return numA - numB;
                     })
                };

            } else {
                data.formacionDocente = { docentes: [], bloques: [] };
            }
            // ======================================================
            // ============= FIN: PROCESAR DATOS PALANCAS ===========
            // ======================================================


            return data;
        }

        function main(data, permissions) {
            const nav = document.getElementById('main-nav');
            const navLinks = nav.querySelectorAll('.nav-link');
            let firstVisibleLink = null;
            const permissionMap = {
                'resumen': 'Resumen',
                'entregables': 'Entregables',
                'estudiantes': 'Estudiantes',
                'docentes': 'Docentes',
                'formacion-docente': 'Formación Docente', // <-- PERMISO AÑADIDO
                'calificaciones': 'Calificaciones',
                'calificaciones-grado': 'Calificaciones por Grado',
                'boletos-salida': 'Boletos de Salida',
                'expediente-estudiante': 'Expediente Estudiante',
                'asistencia-padres': 'Escuela para Padres',
                'desarrollo-profesional': 'Desarrollo Profesional'
            };
            navLinks.forEach(link => { const sectionName = link.getAttribute('href').substring(1); const permissionKey = permissionMap[sectionName]; if (permissions[permissionKey] === 'TRUE') { link.style.display = 'block'; if (!firstVisibleLink) { firstVisibleLink = link; } } else { link.style.display = 'none'; const sectionElement = document.getElementById(sectionName); if (sectionElement) { sectionElement.remove(); } } });
            if (permissions[permissionMap['estudiantes']] !== 'TRUE') { const cardBajas = document.getElementById('card-bajas'); if (cardBajas) cardBajas.style.display = 'none'; }
            if (permissions[permissionMap['docentes']] !== 'TRUE') { const cardDocentes = document.getElementById('card-docentes'); if (cardDocentes) cardDocentes.style.display = 'none'; }
            if (permissions[permissionMap['asistencia-padres']] !== 'TRUE') { const cardPadres = document.getElementById('card-padres'); if (cardPadres) cardPadres.style.display = 'none'; }
            navLinks.forEach(link => link.classList.remove('active-link'));
            if (firstVisibleLink) { firstVisibleLink.classList.add('active-link'); const firstVisibleSection = document.getElementById(firstVisibleLink.getAttribute('href').substring(1)); document.querySelectorAll('.content-section').forEach(s => s.classList.add('hidden')); if (firstVisibleSection) { firstVisibleSection.classList.remove('hidden'); } }

            Chart.register(ChartDataLabels);
            function getNivelDeLogro(promedio) { if (promedio > 9.5) return { nivel: 'Sobresaliente', color: 'bg-[#c0e6af] text-green-900' }; if (promedio >= 8.0) return { nivel: 'Buen desempeño', color: 'bg-[#ffe599] text-amber-800' }; if (promedio >= 7.0) return { nivel: 'Desempeño medio', color: 'bg-[#f9cb9c] text-orange-900' }; if (promedio >= 6.0) return { nivel: 'Bajo desempeño', color: 'bg-[#e06666] text-white' }; return { nivel: 'Foco Rojo', color: 'bg-[#990000] text-white' }; }
            const getEl = (id) => document.getElementById(id);
            const summaryMatricula = getEl('summary-matricula'), summaryBap = getEl('summary-bap'), summaryAsistencia = getEl('summary-asistencia'), summaryBajas = getEl('summary-bajas'), summaryDocentes = getEl('summary-docentes'), summaryMatematicas = getEl('summary-matematicas'), summaryEspanol = getEl('summary-espanol'), summaryCiencias = getEl('summary-ciencias'), summaryIngles = getEl('summary-ingles'), summaryPadres = getEl('summary-padres'), periodFilter = getEl('period-filter'), gradeFilter = getEl('grade-filter'), groupFilter = getEl('group-filter'), blockFilter = getEl('block-filter'), genderFilterCal = getEl('gender-filter-cal'), studentCountGrades = getEl('student-count-grades'), studentGradeFilter = getEl('student-grade-filter'), studentGroupFilter = getEl('student-group-filter'), studentGenderFilter = getEl('student-gender-filter'), studentBapFilter = getEl('student-bap-filter'), studentCountStats = getEl('student-count-stats'), asistenciaChartTitle = getEl('asistencia-chart-title'), boletoBlockFilter = getEl('boleto-block-filter'), boletoGradeFilter = getEl('boleto-grade-filter'), boletoGroupFilter = getEl('boleto-group-filter'), boletoSubjectFilter = getEl('boleto-subject-filter'), boletosChartContainer = getEl('boletos-chart-container'), boletosNoData = getEl('boletos-no-data'), expedienteGradeFilter = getEl('expediente-grade-filter'), expedienteGroupFilter = getEl('expediente-group-filter'), expedienteStudentFilter = getEl('expediente-student-filter'), expedienteContainer = getEl('expediente-container'), expedientePlaceholder = getEl('expediente-placeholder');

            let matriculaChartInstance, asistenciaChartInstance, calificacionesGradoChart, nivelLogroChartInstance, boletosSalidaChartInstance, expedienteAsistenciaChartInstance, expedienteCalificacionesChartInstance, expedienteRadarChartInstance;
            let mmrGestionChartInstance, mmrRigorChartInstance;

            const datalabelConfig = { anchor: 'end', align: 'top', formatter: (value) => value ? parseFloat(value).toFixed(1) : '', color: '#555', font: { weight: 'bold' } };

            // ================================================================
            // ===== INICIO: ESTRUCTURA DE DATOS PARA DESCRIPCIÓN DE FASES ====
            // ================================================================
             const phaseDescriptions = {
                 gestion: {
                     1: {
                         title: "Fase 1: Desarrollar rutinas y procedimientos esenciales",
                         subphases: {
                             1: "Rutinas y procedimientos 101: diseñar y dar a conocer.",
                             2: "Voz firme: postura y hablar con propósito."
                         }
                     },
                     2: {
                         title: "Fase 2: Poner en marcha y monitorear rutinas",
                         subphases: {
                             3: "Qué hacer.",
                             4: "Rutinas y procedimientos 201: corregirlas y perfeccionarlas.",
                             5: "Radar del profesor: detectar cuándo los estudiantes no están trabajando.",
                             6: "Restablecimiento de toda la clase."
                         }
                     },
                     3: {
                         title: "Fase 3: Involucrar a todos los estudiantes",
                         subphases: {
                             7: "Construir momentum.",
                             8: "Ritmo: crear la ilusión de velocidad.",
                             9: "Mantener a todos los estudiantes interesados.",
                             10: "Narrar lo positivo.",
                             11: "Correcciones individuales a los estudiantes."
                         }
                     },
                     4: {
                         title: "Fase 4: Preparar rutinas para el discurso",
                         subphases: {
                             12: "Trabajo comprometido en grupos pequeños."
                         }
                     },
                     5: { // Asumiendo que "Extiéndelo" es Fase 5
                         title: "Fase Extiéndelo: Gestión Aula",
                         subphases: {
                             0: "¡Ninguna! Enfocarse en rigor académico." // Usar 0 o un número no usado
                         }
                     }
                 },
                 rigor: {
                      1: {
                         title: "Fase 1: Planificar las clases",
                         subphases: {
                             1: "Planificar las clases de manera efectiva 101.",
                             2: "Internalizar las planificaciones de clases ya existentes."
                         }
                     },
                     2: {
                         title: "Fase 2: Práctica independiente",
                         subphases: {
                              3: "Escribir la respuesta ejemplar.",
                              4: "Práctica independiente: establecer rutinas diarias.",
                              5: "Monitoreo intensivo."
                         }
                     },
                     3: {
                         title: "Fase 3: Responder a las necesidades de aprendizaje",
                         subphases: {
                              6: "Hábitos de evidencia.",
                              7: "Verificar la comprensión a nivel de grupo.",
                              8: "Reenseñanza 101 – Modelar."
                         }
                     },
                     4: {
                         title: "Fase 4: Guiar el discurso de los estudiantes 101",
                         subphases: {
                              9: "Reenseñanza 201 – Discurso guiado.",
                              10: "Indicaciones universales.",
                              11: "Hábitos de discusión."
                         }
                     },
                     5: { // Asumiendo que "Extiéndelo" es Fase 5
                         title: "Fase Extiéndelo: Guiar el discurso de los estudiantes 201",
                         subphases: {
                             12: "Indicaciones estratégicas.",
                             13: "Volverse conceptual."
                         }
                     }
                 }
             };
            // ================================================================
            // ===== FIN: ESTRUCTURA DE DATOS PARA DESCRIPCIÓN DE FASES =======
            // ================================================================

            function manageVisibility() { const subjects = { matematicas: "Matemáticas", espanol: "Español", ciencias: "Ciencias", ingles: "Inglés" }; Object.entries(subjects).forEach(([key, name]) => { const hasData = data.calificaciones[key] && data.calificaciones[key].length > 0 && data.calificaciones[key].some(v => v > 0); const summaryCard = getEl(`summary-${key}-card`); const chartContainer = getEl(`calificaciones${name.replace('á','a').replace('ñ','n')}-container`); const expPromContainer = getEl(`expediente-prom-${key.substring(0,3)}-container`); if (summaryCard) summaryCard.style.display = hasData ? 'flex' : 'none'; if (chartContainer) chartContainer.style.display = hasData ? 'block' : 'none'; if (expPromContainer) expPromContainer.style.display = hasData ? 'block' : 'none'; }); }
            function populateFilter() { periodFilter.innerHTML = '<option value="General">General</option>'; const a = document.createElement("optgroup"); a.label = "Meses", (data.resumenMensual || []).forEach(b => { const c = document.createElement("option"); c.value = b.periodo, c.textContent = b.periodo, a.appendChild(c) }), periodFilter.appendChild(a); const b = document.createElement("optgroup"); b.label = "Bloques", (data.resumenPorBloque || []).forEach(a => { const c = document.createElement("option"); c.value = a.bloque, c.textContent = a.bloque, b.appendChild(c) }), periodFilter.appendChild(b); }
            function updateSummary(selectedPeriod) { const isGeneral = (!selectedPeriod || selectedPeriod === 'General'); let periodData = isGeneral ? data.resumenGeneral : (data.resumenMensual || []).find(item => item.periodo === selectedPeriod) || (data.resumenPorBloque || []).find(item => item.bloque === selectedPeriod); if (!periodData) { periodData = {}; } const fallbackAsistencia = isGeneral ? (data.resumenGeneral.asistencia || 0) : 0; summaryAsistencia.textContent = `${(periodData.asistencia || fallbackAsistencia).toFixed(1)}%`; summaryMatricula.textContent = periodData.matricula || (isGeneral ? data.resumenGeneral.matricula : 0) || 0; summaryBap.textContent = periodData.alumnosBAP || (isGeneral ? data.resumenGeneral.alumnosBAP : 0) || 0; summaryBajas.textContent = periodData.bajas || (isGeneral ? data.resumenGeneral.bajas : 0) || 0; summaryDocentes.textContent = periodData.docentes || (isGeneral ? data.resumenGeneral.docentes : 0) || 0; summaryPadres.textContent = `${((periodData.prom_asistencia_padres || (isGeneral ? data.resumenGeneral.prom_asistencia_padres : 0)) || 0).toFixed(1)}%`; summaryMatematicas.textContent = (periodData.prom_matematicas || 0).toFixed(1); summaryEspanol.textContent = (periodData.prom_espanol || 0).toFixed(1); summaryCiencias.textContent = (periodData.prom_ciencias || 0).toFixed(1); summaryIngles.textContent = (periodData.prom_ingles || 0).toFixed(1); }
            const allNavLinks = document.querySelectorAll('.nav-link'), allContentSections = document.querySelectorAll('.content-section'), sidebar = getEl("sidebar"), menuButton = getEl("menu-button"); allNavLinks.forEach(a => { a.addEventListener("click", b => { b.preventDefault(); const c = a.getAttribute("href").substring(1); allContentSections.forEach(s => s.classList.add("hidden")); const sectionEl = getEl(c); if(sectionEl) sectionEl.classList.remove("hidden"); allNavLinks.forEach(link => link.classList.remove("active-link", "bg-gray-700")); a.classList.add("active-link", "bg-gray-700"); window.innerWidth < 768 && sidebar.classList.add("-translate-x-full") }) }), menuButton.addEventListener("click", () => sidebar.classList.toggle("-translate-x-full"));
            function createGeneralCharts(){ if(getEl("docentesChart")) {new Chart(getEl("docentesChart"),{type:"bar",data:{labels:data.docentes.meses,datasets:[{label:"Altas",data:data.docentes.altas,backgroundColor:"rgba(59, 130, 246, 0.7)"},{label:"Bajas",data:data.docentes.bajas,backgroundColor:"rgba(239, 68, 68, 0.7)"}]},options:{responsive:!0,scales:{y:{beginAtZero:!0,ticks:{stepSize:1}}}}});} const createBarChart = (elementId, label, color) => { const canvas = getEl(elementId); if(!canvas) return; if(canvas.chart) canvas.chart.destroy(); const subjectKey = label.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace('ñ','n'); new Chart(canvas, { type: "bar", data: { labels: data.calificaciones.bloques, datasets: [{ label: `Promedio ${label}`, data: data.calificaciones[subjectKey], backgroundColor: `rgba(${color}, 0.7)` }] }, options: { responsive: true, scales: { y: { beginAtZero: false, min: 5, max: 10.5 } }, plugins: { legend: { display: false }, datalabels: datalabelConfig } } }); }; createBarChart("calificacionesMatematicasChart","Matemáticas","234, 179, 8"); createBarChart("calificacionesEspanolChart","Español","139, 92, 246"); createBarChart("calificacionesCienciasChart","Ciencias","22, 163, 74"); createBarChart("calificacionesInglesChart","Inglés","37, 99, 235"); const setupNivelLogroGeneral = (subjectKey, elementId) => { const promedioGeneral = data.resumenGeneral[`prom_${subjectKey}`]; const nivelElement = getEl(elementId); if (nivelElement && promedioGeneral !== undefined && promedioGeneral > 0) { const { nivel, color } = getNivelDeLogro(promedioGeneral); nivelElement.textContent = nivel; nivelElement.className = `text-sm font-bold px-2 py-1 rounded-md ${color}`; } else if (nivelElement) { nivelElement.textContent = 'N/A'; nivelElement.className = 'text-sm font-bold px-2 py-1 rounded-md bg-gray-100 text-gray-800'; } }; setupNivelLogroGeneral("matematicas", "nivel-logro-matematicas"); setupNivelLogroGeneral("espanol", "nivel-logro-espanol"); setupNivelLogroGeneral("ciencias", "nivel-logro-ciencias"); setupNivelLogroGeneral("ingles", "nivel-logro-ingles"); }
            function createStudentCharts() { if (getEl("matriculaChart")){if (matriculaChartInstance) matriculaChartInstance.destroy(); matriculaChartInstance = new Chart(getEl("matriculaChart"), { type: "line", data: { labels: data.estudiantes.meses, datasets: [{ label: 'Matrícula Mensual', data: data.estudiantes.matricula, borderColor: 'rgba(54, 162, 235, 1)', backgroundColor: 'rgba(54, 162, 235, 0.2)', fill: true, tension: 0.1 }] }, options: { responsive: true, plugins: { datalabels: { ...datalabelConfig, align: 'bottom' } } } });} if(getEl("asistenciaChart")) {if (asistenciaChartInstance) asistenciaChartInstance.destroy(); asistenciaChartInstance = new Chart(getEl("asistenciaChart"), { type: "bar", options: { responsive: !0, scales: { y: { beginAtZero: !1, min: 80, max: 100 } } } });} }
            function updateStudentCharts() { if (!getEl("asistenciaChart")) return; const a = studentGradeFilter.value, b = studentGroupFilter.value, c = studentGenderFilter.value, d = studentBapFilter.value; let e = data.listaEstudiantes; "Todos" !== a && (e = e.filter(b => b.grado === a)); "Todos" !== b && (e = e.filter(a => a.grupo === b)); "Todos" !== c && (e = e.filter(a => a.genero === c)); "Todos" !== d && (e = e.filter(a => a.bap === d)); studentCountStats.textContent = e.length; let h = "Análisis de Asistencia Mensual"; "Todos" !== b ? h = `Promedio del Grupo ${a} ${b}` : "Todos" !== a && (h = `Promedio del Grado ${a}`); asistenciaChartTitle.textContent = h; const j = SCHOOL_YEAR_MONTH_ORDER.map(monthName => { const monthNumber = MESES_MAP.indexOf(monthName); if(monthNumber === -1) return 0; let total = 0, count = 0; e.forEach(student => { if (student.status === 'activo' && student.asistencia[monthNumber] !== undefined) { total += student.asistencia[monthNumber]; count++; } }); return count > 0 ? (total / count).toFixed(1) : 0; }); asistenciaChartInstance.data.labels = SCHOOL_YEAR_MONTH_ORDER; asistenciaChartInstance.data.datasets = [{ label: "% de Asistencia", data: j, backgroundColor: "rgba(22, 163, 74, 0.6)", borderColor: "rgba(22, 163, 74, 1)", borderWidth: 1 }]; asistenciaChartInstance.update(); }
            function setupStudentFilters() { if (!studentGradeFilter) return; const grados = [...new Set(data.listaEstudiantes.map(a => a.grado))].sort((x, y) => x.localeCompare(y, undefined, { numeric: true })); studentGradeFilter.innerHTML = '<option value="Todos">Todos</option>'; grados.forEach(grado => { studentGradeFilter.innerHTML += `<option value="${grado}">${grado}</option>`; }); studentGroupFilter.innerHTML = '<option value="Todos">Todos</option>'; studentGradeFilter.addEventListener("change", () => { const selectedGrade = studentGradeFilter.value; studentGroupFilter.innerHTML = '<option value="Todos">Todos</option>'; if (selectedGrade !== "Todos") { studentGroupFilter.disabled = false; const grupos = [...new Set(data.listaEstudiantes.filter(b => b.grado === selectedGrade).map(a => a.grupo))].sort(); grupos.forEach(grupo => { studentGroupFilter.innerHTML += `<option value="${grupo}">${grupo}</option>`; }); } else { studentGroupFilter.disabled = true; } updateStudentCharts(); }); studentGroupFilter.addEventListener("change", updateStudentCharts); studentGenderFilter.addEventListener("change", updateStudentCharts); studentBapFilter.addEventListener("change", updateStudentCharts); studentGroupFilter.disabled = true; }
            function populateGradeFilter() { if (!gradeFilter) return; const grados = [...new Set(data.listaEstudiantes.map(a => a.grado))].sort((x, y) => x.localeCompare(y, undefined, { numeric: true })); gradeFilter.innerHTML = '<option value="Todos">Todos</option>'; grados.forEach(grado => { gradeFilter.innerHTML += `<option value="${grado}">${grado}</option>` }); }
            function populateGroupFilter(grado) { if (!groupFilter) return; groupFilter.innerHTML = '<option value="Todos">Todos</option>'; const grupos = [...new Set(data.listaEstudiantes.filter(b => b.grado === grado).map(a => a.grupo))].sort(); grupos.forEach(grupo => { groupFilter.innerHTML += `<option value="${grupo}">${grupo}</option>` }); }
            function populateBlockFilter(){if (!blockFilter) return; blockFilter.innerHTML='<option value="General">General</option>',data.calificaciones.bloques.forEach(a=>{const b=document.createElement("option");b.value=a,b.textContent=a,blockFilter.appendChild(b)})}
            function updateCalificacionesGradoCharts(grade, group, block, gender){ if (!getEl("calificacionesGradoChart")) return; updateCalificacionesGradoBarChart(grade, group, block, gender); updateNivelLogroChart(grade, group, block, gender); }
            function updateNivelLogroChart(grade, group, block, gender) { let filteredStudents; if (grade === 'Todos') { filteredStudents = data.listaEstudiantes.filter(s => s.status === 'activo'); } else { filteredStudents = data.listaEstudiantes.filter(s => s.grado === grade && s.status === 'activo'); } if (group !== 'Todos') { filteredStudents = filteredStudents.filter(s => s.grupo === group); } if (gender !== 'Todos') { filteredStudents = filteredStudents.filter(s => s.genero === gender); } studentCountGrades.textContent = filteredStudents.length; const levelsBySubject = { m: { "Sobresaliente": 0, "Buen desempeño": 0, "Desempeño medio": 0, "Bajo desempeño": 0, "Foco Rojo": 0 }, e: { "Sobresaliente": 0, "Buen desempeño": 0, "Desempeño medio": 0, "Bajo desempeño": 0, "Foco Rojo": 0 }, c: { "Sobresaliente": 0, "Buen desempeño": 0, "Desempeño medio": 0, "Bajo desempeño": 0, "Foco Rojo": 0 }, i: { "Sobresaliente": 0, "Buen desempeño": 0, "Desempeño medio": 0, "Bajo desempeño": 0, "Foco Rojo": 0 }}; const subjectNames = { m: "Matemáticas", e: "Español", c: "Ciencias", i: "Inglés" }; filteredStudents.forEach(student => { if (student.calificaciones) { if (block === 'General') { const studentAverages = { m: [], e: [], c: [], i: [] }; for (const blockName in student.calificaciones) { const blockGrades = student.calificaciones[blockName]; Object.keys(blockGrades).forEach(subjectKey => { if (studentAverages[subjectKey]) { studentAverages[subjectKey].push(blockGrades[subjectKey]); } }); } Object.keys(studentAverages).forEach(subjectKey => { if (studentAverages[subjectKey].length > 0) { const avg = studentAverages[subjectKey].reduce((a, b) => a + b, 0) / studentAverages[subjectKey].length; const level = getNivelDeLogro(avg).nivel; if(levelsBySubject[subjectKey]) levelsBySubject[subjectKey][level]++; } }); } else { const blockGrades = student.calificaciones[block]; if (blockGrades) { Object.keys(blockGrades).forEach(subjectKey => { const gradeValue = blockGrades[subjectKey]; if (gradeValue !== undefined && !isNaN(parseFloat(gradeValue)) && levelsBySubject[subjectKey]) { levelsBySubject[subjectKey][getNivelDeLogro(gradeValue).nivel]++; } }); } } } });
                 const levelOrder = ["Sobresaliente", "Buen desempeño", "Desempeño medio", "Bajo desempeño", "Foco Rojo"];
                 const levelColors = ["#c0e6af", "#ffe599", "#f9cb9c", "#e06666", "#990000"];
                 const chartLabels = Object.keys(subjectNames).filter(key => data.calificaciones[key.replace('m','matematicas').replace('e','espanol').replace('c','ciencias').replace('i','ingles')]).map(key => subjectNames[key]); const datasets = levelOrder.map((level, index) => ({ label: level, data: Object.keys(subjectNames).filter(key => data.calificaciones[key.replace('m','matematicas').replace('e','espanol').replace('c','ciencias').replace('i','ingles')]).map(key => levelsBySubject[key][level]), backgroundColor: levelColors[index] })); if (nivelLogroChartInstance) nivelLogroChartInstance.destroy(); nivelLogroChartInstance = new Chart(getEl("nivelLogroChart"), { type: "bar", data: { labels: chartLabels, datasets: datasets }, options: { responsive: !0, plugins: { legend: { position: "top" }, title: { display: true, text: `Niveles de Logro - ${grade === 'Todos' ? 'General' : grade} ${group !== "Todos" && grade !== 'Todos' ? "Grupo " + group : ""}` } }, scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true, title: { display: true, text: "Cantidad de Estudiantes" } } } } }); }
            function updateCalificacionesGradoBarChart(grade, group, block, gender) { let filteredStudents; if (grade === 'Todos') { filteredStudents = data.listaEstudiantes.filter(s => s.status === 'activo'); } else { filteredStudents = data.listaEstudiantes.filter(s => s.grado === grade && s.status === 'activo'); } if (group !== 'Todos') { filteredStudents = filteredStudents.filter(s => s.grupo === group); } if (gender !== 'Todos') { filteredStudents = filteredStudents.filter(s => s.genero === gender); } const subjectKeyMap = { "matematicas": "m", "espanol": "e", "ciencias": "c", "ingles": "i" }; const subjectNames = { "matematicas": "Matemáticas", "espanol": "Español", "ciencias": "Ciencias", "ingles": "Inglés" }; const colorMap = {matematicas: ['rgba(255, 206, 86, 0.6)', 'rgba(255, 206, 86, 1)'],espanol: ['rgba(153, 102, 255, 0.6)', 'rgba(153, 102, 255, 1)'],ciencias: ['rgba(75, 192, 192, 0.6)', 'rgba(75, 192, 192, 1)'],ingles: ['rgba(54, 162, 235, 0.6)', 'rgba(54, 162, 235, 1)']}; let chartLabels = [], chartDataValues = [], backgroundColors = [], borderColors = []; Object.keys(subjectKeyMap).forEach(subjectKey => { if (!data.calificaciones[subjectKey] || data.calificaciones[subjectKey].length === 0) return; const shortKey = subjectKeyMap[subjectKey]; let totalSum = 0, totalCount = 0; filteredStudents.forEach(student => { if (student.calificaciones) { if (block === 'General') { Object.values(student.calificaciones).forEach(blockGrades => { if (blockGrades[shortKey] !== undefined && !isNaN(parseFloat(blockGrades[shortKey]))) { totalSum += parseFloat(blockGrades[shortKey]); totalCount++; } }); } else { if (student.calificaciones[block] && student.calificaciones[block][shortKey] !== undefined && !isNaN(parseFloat(student.calificaciones[block][shortKey]))) { totalSum += parseFloat(student.calificaciones[block][shortKey]); totalCount++; } } } }); const avg = totalCount > 0 ? (totalSum / totalCount) : 0; chartLabels.push(subjectNames[subjectKey]); chartDataValues.push(avg.toFixed(2)); backgroundColors.push(colorMap[subjectKey][0]); borderColors.push(colorMap[subjectKey][1]); }); if (!calificacionesGradoChart) { calificacionesGradoChart = new Chart(getEl("calificacionesGradoChart"), { type: "bar", data: { labels: chartLabels, datasets: [{ label: "Promedio de Calificaciones", data: chartDataValues, backgroundColor: backgroundColors, borderColor: borderColors, borderWidth: 1 }] }, options: { responsive: !0, plugins: { legend: { display: !1 }, datalabels: datalabelConfig }, scales: { y: { beginAtZero: !1, min: 5, max: 10.5 } } } }); } else { calificacionesGradoChart.data.labels = chartLabels; calificacionesGradoChart.data.datasets[0].data = chartDataValues; calificacionesGradoChart.data.datasets[0].backgroundColor = backgroundColors; calificacionesGradoChart.data.datasets[0].borderColor = borderColors; calificacionesGradoChart.update(); } const titleText = `Promedio - ${grade === 'Todos' ? 'General' : grade} ${group === 'Todos' || grade === 'Todos' ? '' : 'Grupo ' + group} (${block})`; calificacionesGradoChart.options.plugins.title = { display: true, text: titleText }; calificacionesGradoChart.update(); }
            function setupBoletosFilters() { if (!boletoBlockFilter) return; boletoBlockFilter.innerHTML = "", data.calificaciones.bloques.forEach(a => { const b = document.createElement("option"); b.value = a, b.textContent = a, boletoBlockFilter.appendChild(b) }); const a = [...new Set(data.listaEstudiantes.map(a => a.grado))].sort((x,y)=>x.localeCompare(y, undefined, {numeric: true})); boletoGradeFilter.innerHTML = '<option value="Todos">Todos</option>', a.forEach(a => { boletoGradeFilter.innerHTML += `<option value="${a}">${a}</option>` }); const b = ["Matemáticas", "Español", "Ciencias", "Inglés"]; boletoSubjectFilter.innerHTML = '<option value="Todas">Todas</option>', b.sort().forEach(a => { boletoSubjectFilter.innerHTML += `<option value="${a}">${a}</option>` }), boletoGradeFilter.addEventListener("change", () => { const a = boletoGradeFilter.value; boletoGroupFilter.innerHTML = '<option value="Todos">Todos</option>', "Todos" !== a ? (boletoGroupFilter.disabled = !1, [...new Set(data.listaEstudiantes.filter(b => b.grado === a).map(a => a.grupo))].sort().forEach(a => { boletoGroupFilter.innerHTML += `<option value="${a}">${a}</option>` })) : boletoGroupFilter.disabled = !0, updateBoletosChart() }), boletoGroupFilter.disabled = !0, [boletoBlockFilter, boletoGroupFilter, boletoSubjectFilter].forEach(a => { a.addEventListener("change", updateBoletosChart) }) }
            function updateBoletosChart(){ if (!getEl('boletosSalidaChart')) return; const a=boletoBlockFilter.value,b=boletoGradeFilter.value,c=boletoGroupFilter.value,d=boletoSubjectFilter.value;let e=data.listaEstudiantes;"Todos"!==b&&(e=e.filter(a=>a.grado===b)),"Todos"!==c&&(e=e.filter(a=>a.grupo===c));const f={};let g=!1;e.forEach(b=>{if(b.boletos&&b.boletos[a]){const c="Todas"===d?Object.keys(b.boletos[a]):[d];c.forEach(c=>{b.boletos[a][c]&&b.boletos[a][c].forEach(b=>{g=!0,f[b.date]||(f[b.date]={1:0,2:0,3:0}),f[b.date][b.score]++})})}});if(!g)return boletosChartContainer.classList.add("hidden"),void boletosNoData.classList.remove("hidden");boletosChartContainer.classList.remove("hidden"),boletosNoData.classList.add("hidden");const h=Object.keys(f).sort((a,b)=>new Date(a)-new Date(b)),i=h.map(a=>f[a][1]),j=h.map(a=>f[a][2]),k=h.map(a=>f[a][3]);boletosSalidaChartInstance&&boletosSalidaChartInstance.destroy(),boletosSalidaChartInstance=new Chart(getEl("boletosSalidaChart"),{type:"bar",data:{labels:h,datasets:[{label:"Calificación 1 (Bajo)",data:i,backgroundColor:"rgba(239, 68, 68, 0.7)"},{label:"Calificación 2 (Medio)",data:j,backgroundColor:"rgba(245, 158, 11, 0.7)"},{label:"Calificación 3 (Alto)",data:k,backgroundColor:"rgba(22, 163, 74, 0.7)"}]},options:{responsive:!0,plugins:{legend:{position:"top"}},scales:{x:{stacked:!0,title:{display:!0,text:"Fecha de Clase"}},y:{stacked:!0,beginAtZero:!0,title:{display:!0,text:"Cantidad de Estudiantes"}}}}})}
            function setupExpedienteFilters(){if (!expedienteGradeFilter) return; const a=[...new Set(data.listaEstudiantes.map(a=>a.grado))].sort((x,y)=>x.localeCompare(y, undefined, {numeric: true}));expedienteGradeFilter.innerHTML='<option value="">Seleccione...</option>',a.forEach(a=>{expedienteGradeFilter.innerHTML+=`<option value="${a}">${a}</option>`}),expedienteGradeFilter.addEventListener("change",()=>{const a=expedienteGradeFilter.value;expedienteGroupFilter.innerHTML='<option value="">Seleccione...</option>',expedienteStudentFilter.innerHTML='<option value="">Seleccione...</option>',expedienteContainer.classList.add("hidden"),expedientePlaceholder.classList.remove("hidden"),a?(expedienteGroupFilter.disabled=!1,[...new Set(data.listaEstudiantes.filter(b=>b.grado===a).map(a=>a.grupo))].sort().forEach(a=>{expedienteGroupFilter.innerHTML+=`<option value="${a}">${a}</option>`})):expedienteGroupFilter.disabled=!0,expedienteStudentFilter.disabled=!0}),expedienteGroupFilter.addEventListener("change",()=>{const a=expedienteGradeFilter.value,b=expedienteGroupFilter.value;expedienteStudentFilter.innerHTML='<option value="">Seleccione...</option>',expedienteContainer.classList.add("hidden"),expedientePlaceholder.classList.remove("hidden"),a&&b?(expedienteStudentFilter.disabled=!1,data.listaEstudiantes.filter(c=>c.grado===a&&c.grupo===b).sort((a,b)=>a.nombre.localeCompare(b.nombre)).forEach(a=>{expedienteStudentFilter.innerHTML+=`<option value="${a.id}">${a.nombre}</option>`})):expedienteStudentFilter.disabled=!0}),expedienteStudentFilter.addEventListener("change",a=>{a.target.value?(updateExpedienteView(a.target.value),expedienteContainer.classList.remove("hidden"),expedientePlaceholder.classList.add("hidden")):(expedienteContainer.classList.add("hidden"),expedientePlaceholder.classList.remove("hidden"))}),expedienteGroupFilter.disabled=!0,expedienteStudentFilter.disabled=!0}
            function updateExpedienteView(a){ const b=data.listaEstudiantes.find(b=>b.id==a); if(!b)return; getEl("expediente-nombre").textContent=b.nombre,getEl("expediente-grupo").textContent=`${b.grado} - ${b.grupo}`,getEl("expediente-genero").textContent=b.genero; const c=getEl("expediente-estatus");c.textContent=b.status.charAt(0).toUpperCase()+b.status.slice(1),c.className=`text-lg font-semibold ${"activo"===b.status?"text-green-600":"text-red-600"}`,getEl("expediente-bap").textContent=b.bap||"No", getEl("expediente-clave").textContent = b.clave_escolar || b.id || 'N/A'; let d=0,e=0;if(b.calificaciones&&Object.keys(b.calificaciones).length>0){for(const a in b.calificaciones){const c=b.calificaciones[a];for(const key in c) {d+=(c[key]||0),e++}}}const f=e>0?d/e:0;getEl("expediente-promedio").textContent=f.toFixed(2); const g=getNivelDeLogro(f),h=getEl("expediente-nivel-logro");h.textContent=g.nivel,h.className=`text-base font-bold px-2 py-1 rounded-md inline-block align-middle ${g.color}`; const i=getEl("expediente-block-filter");i.innerHTML='<option value="General">General</option>';const j=Object.keys(b.calificaciones||{}).sort();j.forEach(a=>{const b=document.createElement("option");b.value=a,b.textContent=a,i.appendChild(b)}); const initialAverages = updateExpedienteSubjectAverages(b,"General"); updateExpedienteRadarChart(initialAverages, "General"); const studentMonths = Object.keys(b.asistencia).sort((a,b) => parseInt(a)-parseInt(b)).map(num => MESES_MAP[num]); const studentAttendance = Object.keys(b.asistencia).sort((a,b) => parseInt(a)-parseInt(b)).map(key => b.asistencia[key]); if(expedienteAsistenciaChartInstance)expedienteAsistenciaChartInstance.destroy(); expedienteAsistenciaChartInstance=new Chart(getEl("expedienteAsistenciaChart"),{type:"bar",options:{responsive:!0,plugins:{datalabels:{...datalabelConfig, formatter: (v) => v ? `${v}%` : ''}},scales:{y:{beginAtZero:!1,min:70,max:100.5}}}}); expedienteAsistenciaChartInstance.data={labels:studentMonths,datasets:[{label:"% de Asistencia",data:studentAttendance,backgroundColor:"rgba(22, 163, 74, 0.6)",borderColor:"rgba(22, 163, 74, 1)",borderWidth:1}]},expedienteAsistenciaChartInstance.update(); const m=data.calificaciones.bloques,n=m.map(a=>b.calificaciones[a]?.m||null),o=m.map(a=>b.calificaciones[a]?.e||null),p=m.map(a=>b.calificaciones[a]?.c||null),q=m.map(a=>b.calificaciones[a]?.i||null); if(expedienteCalificacionesChartInstance)expedienteCalificacionesChartInstance.destroy(); expedienteCalificacionesChartInstance=new Chart(getEl("expedienteCalificacionesChart"),{type:"bar",data:{labels:m,datasets:[{label:"Matemáticas",data:n,backgroundColor:"rgba(234, 179, 8, 0.7)"},{label:"Español",data:o,backgroundColor:"rgba(139, 92, 246, 0.7)"},{label:"Ciencias",data:p,backgroundColor:"rgba(22, 163, 74, 0.7)"},{label:"Inglés",data:q,backgroundColor:"rgba(37, 99, 235, 0.7)"}]}, options:{responsive:!0,plugins:{datalabels: datalabelConfig},scales:{y:{beginAtZero:!0,min:0,max:10.5}}}}); expedienteCalificacionesChartInstance.update() }
            function updateExpedienteSubjectAverages(a,b){if(!a)return;let c={m:NaN,e:NaN,c:NaN,i:NaN};if(a.calificaciones&&Object.keys(a.calificaciones).length>0)if("General"===b){const b={m:[],e:[],c:[],i:[]};for(const d in a.calificaciones){const e=a.calificaciones[d];Object.keys(e).forEach(a=>{b[a]&&b[a].push(e[a])})} Object.keys(b).forEach(a=>{b[a].length>0&&(c[a]=b[a].reduce((a,b)=>a+b,0)/b[a].length)})}else{const d=a.calificaciones[b]||{};c.m=d.m,c.e=d.e,c.c=d.c,c.i=d.i} const d=c.m,e=getNivelDeLogro(d);getEl("expediente-prom-mat").textContent=isNaN(d)?"N/A":d.toFixed(2),getEl("expediente-nivel-mat").textContent=isNaN(d)?"":e.nivel,getEl("expediente-nivel-mat").className=`text-xs font-bold px-2 py-0.5 rounded-md inline-block mt-1 align-middle ${isNaN(d)?"":e.color}`;const f=c.e,g=getNivelDeLogro(f);getEl("expediente-prom-esp").textContent=isNaN(f)?"N/A":f.toFixed(2),getEl("expediente-nivel-esp").textContent=isNaN(f)?"":g.nivel,getEl("expediente-nivel-esp").className=`text-xs font-bold px-2 py-0.5 rounded-md inline-block mt-1 align-middle ${isNaN(f)?"":g.color}`;const h=c.c,i=getNivelDeLogro(h);getEl("expediente-prom-cie").textContent=isNaN(h)?"N/A":h.toFixed(2),getEl("expediente-nivel-cie").textContent=isNaN(h)?"":i.nivel,getEl("expediente-nivel-cie").className=`text-xs font-bold px-2 py-0.5 rounded-md inline-block mt-1 align-middle ${isNaN(h)?"":i.color}`;const j=c.i,k=getNivelDeLogro(j);getEl("expediente-prom-ing").textContent=isNaN(j)?"N/A":j.toFixed(2),getEl("expediente-nivel-ing").textContent=isNaN(j)?"":k.nivel,getEl("expediente-nivel-ing").className=`text-xs font-bold px-2 py-0.5 rounded-md inline-block mt-1 align-middle ${isNaN(j)?"":k.color}`; return c;}
            function updateExpedienteRadarChart(averages, blockName) { if(!getEl("expedienteRadarChart")) return; if (expedienteRadarChartInstance) expedienteRadarChartInstance.destroy(); const subjectMap = { m: 'Matemáticas', e: 'Español', c: 'Ciencias', i: 'Inglés' }; const labels = [], dataPoints = []; Object.keys(subjectMap).forEach(key => { if (!isNaN(averages[key])) { labels.push(subjectMap[key]); dataPoints.push(averages[key]); } }); expedienteRadarChartInstance = new Chart(getEl("expedienteRadarChart"), { type: 'radar', data: { labels: labels, datasets: [{ label: `Promedio (${blockName})`, data: dataPoints, backgroundColor: 'rgba(54, 162, 235, 0.2)', borderColor: 'rgba(54, 162, 235, 1)', borderWidth: 2 }] }, options: { responsive: true, scales: { r: { beginAtZero: true, min: 0, max: 10, ticks: { stepSize: 2 } } }, plugins: { legend: { position: 'top' }, datalabels: { color: '#36A2EB', font: {weight: 'bold'}, formatter: (v) => parseFloat(v).toFixed(1) } } } }); }

            function createAsistenciaPadresSection(data) {
                const section = getEl('asistencia-padres');
                if (!section) return;
                if (!data.asistenciaPadres || data.asistenciaPadres.length === 0) {
                    section.innerHTML = '<h2 class="text-3xl font-bold mb-6 text-gray-800">Escuela para Padres</h2><p class="text-center text-gray-500 bg-white p-10 rounded-xl shadow-md">No hay datos de asistencia de padres disponibles.</p>';
                    return;
                }
                const sesiones = data.asistenciaPadres;
                const totalAsistencias = sesiones.reduce((sum, s) => sum + s.asistentes, 0);
                const promedioAsistencia = data.resumenGeneral.prom_asistencia_padres || 0;
                let mejorSesion = { porcentaje_asistencia: -1, titulo_sesion: 'N/A' };
                let peorSesion = { porcentaje_asistencia: 101, titulo_sesion: 'N/A' };
                sesiones.forEach(s => {
                    if (s.porcentaje_asistencia > mejorSesion.porcentaje_asistencia) mejorSesion = s;
                    if (s.porcentaje_asistencia < peorSesion.porcentaje_asistencia) peorSesion = s;
                });
                getEl('padres-promedio-asistencia').textContent = `${promedioAsistencia.toFixed(1)}%`;
                getEl('padres-total-asistentes').textContent = totalAsistencias;
                const mejorSesionEl = getEl('padres-mejor-sesion');
                mejorSesionEl.textContent = `${mejorSesion.titulo_sesion} (${mejorSesion.porcentaje_asistencia.toFixed(1)}%)`;
                mejorSesionEl.title = `${mejorSesion.titulo_sesion} (${mejorSesion.porcentaje_asistencia.toFixed(1)}%)`;
                const peorSesionEl = getEl('padres-peor-sesion');
                peorSesionEl.textContent = `${peorSesion.titulo_sesion} (${peorSesion.porcentaje_asistencia.toFixed(1)}%)`;
                peorSesionEl.title = `${peorSesion.titulo_sesion} (${peorSesion.porcentaje_asistencia.toFixed(1)}%)`;
                const barChartCanvas = getEl('asistenciaPadresChart');
                if (barChartCanvas) { if (barChartCanvas.chart) barChartCanvas.chart.destroy(); barChartCanvas.chart = new Chart(barChartCanvas, { type: 'bar', data: { labels: sesiones.map(s => `Sesión ${s.sesion}: ${s.titulo_sesion}`), datasets: [{ label: '% de Asistencia', data: sesiones.map(s => s.porcentaje_asistencia), backgroundColor: 'rgba(20, 184, 166, 0.7)', borderColor: 'rgba(15, 118, 110, 1)', borderWidth: 1 }] }, options: { responsive: true, scales: { y: { beginAtZero: false, min: 50, max: 100, ticks: { callback: (val) => val + '%' } } }, plugins: { legend: { display: false }, tooltip: { callbacks: { afterLabel: function(context) { const sesionData = sesiones[context.dataIndex]; return `Fecha: ${sesionData.fecha}\n${sesionData.asistentes} de ${sesionData.esperados} padres asistieron.`; } } } } } }); }
                const trendChartCanvas = getEl('asistenciaPadresTrendChart');
                if (trendChartCanvas) { if (trendChartCanvas.chart) trendChartCanvas.chart.destroy(); trendChartCanvas.chart = new Chart(trendChartCanvas, { type: 'bar', data: { labels: sesiones.map(s => `Sesión ${s.sesion}`), datasets: [{ label: 'Tendencia de Asistencia (%)', data: sesiones.map(s => s.porcentaje_asistencia), backgroundColor: 'rgba(59, 130, 246, 0.7)', borderColor: 'rgba(59, 130, 246, 1)', borderWidth: 1 }] }, options: { responsive: true, scales: { y: { beginAtZero: false, min: 50, max: 100, ticks: { callback: (val) => val + '%' } } }, plugins: { legend: { display: false } } } }); }
                const tablaBody = getEl('padres-sesiones-tabla');
                if(tablaBody) { tablaBody.innerHTML = ''; sesiones.forEach(s => { const row = `<tr class="hover:bg-gray-50"><td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${s.sesion}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${s.titulo_sesion}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${s.fecha}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${s.asistentes} / ${s.esperados}</td><td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-800">${s.porcentaje_asistencia.toFixed(1)}%</td></tr>`; tablaBody.innerHTML += row; }); }
            }

            function createEntregablesSection(data) {
                const section = getEl('entregables');
                if (!section) return;
                if (!data.entregables || data.entregables.length === 0) {
                    section.innerHTML = '<h2 class="text-3xl font-bold mb-6 text-gray-800">Entregables</h2><p class="text-center text-gray-500 bg-white p-10 rounded-xl shadow-md">No hay fechas de entregables configuradas.</p>';
                    return;
                }
                const hoy = new Date();
                hoy.setUTCHours(0, 0, 0, 0);
                const entregables = data.entregables.map(e => {
                    const parts = String(e.FechaLimite).split('-');
                    let fechaObj = new Date(Date.UTC(1970, 0, 1));
                    if (parts.length === 3) {
                        const day = parseInt(parts[0], 10);
                        const month = parseInt(parts[1], 10) - 1;
                        const year = parseInt(parts[2], 10);
                        if (!isNaN(day) && !isNaN(month) && !isNaN(year) && month >= 0 && month <= 11 && day > 0 && day <= 31) {
                            fechaObj = new Date(Date.UTC(year, month, day));
                        } else {
                            console.warn(`Fecha inválida encontrada en Entregables: ${e.FechaLimite}`);
                        }
                    } else {
                        console.warn(`Formato de fecha inesperado en Entregables: ${e.FechaLimite}. Se esperaba DD-MM-AAAA.`);
                    }
                    return { ...e, fechaObj: fechaObj };
                }).filter(e => e.fechaObj && !isNaN(e.fechaObj) && e.fechaObj.getUTCFullYear() > 1970);
                const futuros = entregables
                    .filter(e => e.fechaObj >= hoy)
                    .sort((a, b) => a.fechaObj - b.fechaObj);
                const optionsCompleta = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', timeZone: 'UTC' };
                const optionsCorta = { month: 'short', day: 'numeric', timeZone: 'UTC' };
                const proxEst = futuros.find(e => e.Categoria === 'Estadísticas');
                const proxEstNombreEl = getEl('prox-estadistica-nombre');
                const proxEstFechaEl = getEl('prox-estadistica-fecha');
                if (proxEst && proxEstNombreEl) {
                    proxEstNombreEl.textContent = proxEst.NombreEntregable;
                    proxEstNombreEl.title = proxEst.NombreEntregable;
                    proxEstFechaEl.textContent = proxEst.fechaObj.toLocaleDateString('es-ES', optionsCompleta);
                    proxEstFechaEl.className = "text-lg font-semibold text-blue-600 mt-1";
                } else if (proxEstNombreEl) {
                    proxEstNombreEl.textContent = 'N/A';
                    proxEstNombreEl.title = 'N/A';
                    proxEstFechaEl.textContent = 'No hay pendientes';
                    proxEstFechaEl.className = "text-base font-medium text-gray-500 mt-1";
                }
                const proxPlan = futuros.find(e => e.Categoria === 'Planeación');
                const proxPlanNombreEl = getEl('prox-planeacion-nombre');
                const proxPlanFechaEl = getEl('prox-planeacion-fecha');
                if (proxPlan && proxPlanNombreEl) {
                    proxPlanNombreEl.textContent = proxPlan.NombreEntregable;
                    proxPlanNombreEl.title = proxPlan.NombreEntregable;
                    proxPlanFechaEl.textContent = proxPlan.fechaObj.toLocaleDateString('es-ES', optionsCompleta);
                    proxPlanFechaEl.className = "text-lg font-semibold text-green-600 mt-1";
                } else if (proxPlanNombreEl) {
                    proxPlanNombreEl.textContent = 'N/A';
                    proxPlanNombreEl.title = 'N/A';
                    proxPlanFechaEl.textContent = 'No hay pendientes';
                    proxPlanFechaEl.className = "text-base font-medium text-gray-500 mt-1";
                }
                const listaCalContainer = getEl('prox-calificacion-lista');
                const proxCals = futuros.filter(e => e.Categoria === 'Calificaciones').slice(0, 4);
                if (listaCalContainer) {
                    if (proxCals.length > 0) {
                        listaCalContainer.innerHTML = '';
                        proxCals.forEach(cal => {
                            const htmlItem = `
                                <div class="flex justify-between items-baseline text-sm">
                                    <span class="font-medium text-gray-700 truncate mr-2" title="${cal.NombreEntregable}">${cal.NombreEntregable}</span>
                                    <span class="font-bold text-purple-600 flex-shrink-0 whitespace-nowrap">${cal.fechaObj.toLocaleDateString('es-ES', optionsCorta)}</span>
                                </div>`;
                            listaCalContainer.innerHTML += htmlItem;
                        });
                    } else {
                        listaCalContainer.innerHTML = '<p class="text-gray-500 text-sm">No hay entregas de calificaciones pendientes.</p>';
                    }
                }
                const tablaBody = getEl('tabla-entregables-body');
                if (!tablaBody) return;
                tablaBody.innerHTML = '';
                if (futuros.length === 0) {
                    tablaBody.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">¡Felicidades! No hay entregables pendientes.</td></tr>';
                    return;
                }
                futuros.forEach(e => {
                    const fechaLimiteMedianoche = new Date(e.fechaObj);
                    const diffTime = fechaLimiteMedianoche - hoy;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    let diasRestantesStr = `${diffDays} día${diffDays !== 1 ? 's' : ''}`;
                    let colorFila = 'hover:bg-gray-50';
                    let colorTextoDias = 'text-gray-800';
                    if (diffDays === 0) {
                        diasRestantesStr = '¡Hoy!';
                        colorFila = 'bg-yellow-100 hover:bg-yellow-200';
                        colorTextoDias = 'text-yellow-800 font-bold';
                    } else if (diffDays <= 3 && diffDays > 0) {
                        colorFila = 'bg-red-50 hover:bg-red-100';
                        colorTextoDias = 'text-red-700 font-semibold';
                    } else if (diffDays < 0) {
                         diasRestantesStr = 'Vencido';
                         colorFila = 'bg-gray-100 opacity-70';
                         colorTextoDias = 'text-gray-500';
                    }
                    const row = `
                        <tr class="${colorFila}">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${e.Categoria}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${e.NombreEntregable}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${e.fechaObj.toLocaleDateString('es-ES', optionsCompleta)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold ${colorTextoDias}">${diasRestantesStr}</td>
                        </tr>`;
                    tablaBody.innerHTML += row;
                });
                lucide.createIcons();
            }

            function createDesarrolloProfesionalSection(data) {
                const section = getEl('desarrollo-profesional');
                if (!section) return;
                const tablaBody = getEl('desarrollo-profesional-tabla-body');
                const placeholder = getEl('desarrollo-profesional-placeholder');
                const tablaContainer = getEl('desarrollo-profesional-tabla-container');
                if (!tablaBody || !placeholder || !tablaContainer) {
                    console.error("Faltan elementos HTML para la sección Desarrollo Profesional.");
                    return;
                }
                if (!data.desarrolloProfesional || data.desarrolloProfesional.length === 0) {
                    placeholder.classList.remove('hidden');
                    tablaContainer.classList.add('hidden');
                    return;
                }
                placeholder.classList.add('hidden');
                tablaContainer.classList.remove('hidden');
                tablaBody.innerHTML = '';
                data.desarrolloProfesional.forEach(sesion => {
                    const row = `
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${sesion.fecha}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${sesion.bloque}</td>
                            <td class="px-6 py-4 text-sm font-medium text-gray-900">${sesion.tema}</td>
                            <td class="px-6 py-4 text-sm text-gray-500">${sesion.brecha}</td>
                            <td class="px-6 py-4 text-sm text-gray-500">${sesion.objetivo}</td>
                        </tr>
                    `;
                    tablaBody.innerHTML += row;
                });
                lucide.createIcons();
            }

            // ======================================================
// ======== INICIO: FUNCIÓN FORMACIÓN DOCENTE (CORREGIDA)
// ======================================================
function createFormacionDocenteSection(data) {
    const section = getEl('formacion-docente');
    if (!section || !data.formacionDocente || !data.formacionDocente.docentes || data.formacionDocente.docentes.length === 0) {
        if (section) {
            section.innerHTML = '<h2 class="text-3xl font-bold mb-6 text-gray-800">Formación Docente</h2><p class="text-center text-gray-500 bg-white p-10 rounded-xl shadow-md">No hay datos de formación docente (Pestaña "Palancas") disponibles.</p>';
        }
        console.warn("No hay datos de formación docente o falta el elemento HTML.");
        return;
    }

    const { docentes, bloques } = data.formacionDocente;

    // --- Obtener referencias a elementos HTML ---
    // NOTA: Solo obtenemos los filtros, los contenedores dinámicos se obtendrán dentro de las funciones
    const overviewBlockFilter = getEl('formacion-block-filter');
    const detailBlockFilter = getEl('formacion-block-filter-detail');
    const teacherFilter = getEl('formacion-teacher-filter');

    // Verificar si los elementos DE FILTRO existen
    if (!overviewBlockFilter || !detailBlockFilter || !teacherFilter) {
        console.error("Faltan elementos HTML esenciales (filtros) para la sección Formación Docente.");
        section.innerHTML = '<h2 class="text-3xl font-bold mb-6 text-gray-800">Formación Docente</h2><p class="text-center text-red-500 bg-white p-10 rounded-xl shadow-md">Error interno: Faltan elementos de la interfaz. Contacta al administrador.</p>';
        return;
    }


    // --- Helper para parsear fases ---
    const parsePhase = (phaseStr) => {
        const num = parseFloat(phaseStr);
        return isNaN(num) ? null : num;
    };

    // --- Función para actualizar Resumen General (Overview) ---
    // --- Función para actualizar Resumen General (Overview) (CORREGIDA PARA TEXTO) ---
function updateFormacionOverview(selectedBlock) {
    // Arrays para guardar las fases COMO TEXTO
    let phasesGestionText = [];
    let phasesRigorText = [];
    let total1a1 = 0;
    let totalRSD = 0;

    let nineBoxGridData = {
        'high-high': 0, 'high-med': 0, 'high-low': 0,
        'med-high': 0, 'med-med': 0, 'med-low': 0,
        'low-high': 0, 'low-med': 0, 'low-low': 0,
        'unknown': 0
    };

    docentes.forEach(docente => {
        const blockData = docente.bloques[selectedBlock];
        if (blockData) {
            // Guardamos el texto original, o 'N/A' si está vacío/nulo
            const phaseGText = (blockData.gestion && String(blockData.gestion).trim()) ? String(blockData.gestion).trim() : 'N/A';
            const phaseRText = (blockData.rigor && String(blockData.rigor).trim()) ? String(blockData.rigor).trim() : 'N/A';
            phasesGestionText.push(phaseGText);
            phasesRigorText.push(phaseRText);

            // Cálculos de 1a1, RSD y 9 Cajas (sin cambios)
            total1a1 += blockData.oao || 0;
            totalRSD += blockData.rsd || 0;
            const caja = (blockData.cajas || 'N/A').trim().toLowerCase();
            if (caja === '1a') { nineBoxGridData['high-high']++; }
            else if (caja === '1b') { nineBoxGridData['high-med']++; }
            else if (caja === '1c') { nineBoxGridData['high-low']++; }
            else if (caja === '2a') { nineBoxGridData['med-high']++; }
            else if (caja === '2b') { nineBoxGridData['med-med']++; }
            else if (caja === '2c') { nineBoxGridData['med-low']++; }
            else if (caja === '3a') { nineBoxGridData['low-high']++; }
            else if (caja === '3b') { nineBoxGridData['low-med']++; }
            else if (caja === '3c') { nineBoxGridData['low-low']++; }
            else if (caja !== 'n/a' && caja !== '') { nineBoxGridData['unknown']++; }
        } else {
             // Si no hay datos del bloque para el docente, añadir N/A
             phasesGestionText.push('N/A');
             phasesRigorText.push('N/A');
        }
    });

    // --- INICIO: Nuevo código para calcular y mostrar la MODA (adaptado para texto) ---

    // Función para calcular la moda (fase más frecuente como texto)
    const calculateModeText = (phaseTexts) => {
        // Filtramos valores no útiles como 'N/A' o vacíos ANTES de contar
        const validPhases = phaseTexts.filter(phase => phase && phase !== 'N/A' && phase.trim() !== '');

        if (validPhases.length === 0) return 'N/A'; // Si no hay fases válidas

        const frequency = {};
        let maxFreq = 0;
        let modes = [];

        // Contar la frecuencia de cada fase (texto)
        validPhases.forEach(phase => {
            frequency[phase] = (frequency[phase] || 0) + 1;
            if (frequency[phase] > maxFreq) {
                maxFreq = frequency[phase];
            }
        });

        // Encontrar todas las fases con la frecuencia máxima
        for (const phase in frequency) {
            if (frequency[phase] === maxFreq) {
                modes.push(phase);
            }
        }

        // Si hay una moda, devolverla. Si hay empate, podrías unir las fases empatadas.
        // Aquí mostramos solo la primera encontrada (puedes ajustar si prefieres mostrar empates)
        // Ej: modes.join(', ') para mostrar "Fase 2.1, Fase 2.3" si empatan.
        return modes.length > 0 ? modes[0] : 'N/A';
    };

    // Calcular la moda para Gestión y Rigor usando los textos
    const modeGestionText = calculateModeText(phasesGestionText);
    const modeRigorText = calculateModeText(phasesRigorText);

    // Actualizar las tarjetas con la moda (texto)
    getEl('formacion-summary-mmr-gestion').textContent = modeGestionText;
    getEl('formacion-summary-mmr-rigor').textContent = modeRigorText;

    // --- FIN: Nuevo código para calcular y mostrar la MODA ---

    // Mantenemos las líneas para 1a1 y RSD como estaban
    getEl('formacion-summary-1a1').textContent = total1a1;
    getEl('formacion-summary-rsd').textContent = totalRSD;

    // Actualizar Matriz 9 Cajas (sin cambios)
    const nineBoxTitle = getEl('nineBoxChartTitle');
    if (nineBoxTitle) { nineBoxTitle.textContent = `Distribución 9 Cajas (${selectedBlock})`; }
    for (const key in nineBoxGridData) {
        if (key !== 'unknown') {
            const cellElement = getEl(`ninebox-${key}`);
            if (cellElement) { const countSpan = cellElement.querySelector('span:last-child'); if (countSpan) { countSpan.textContent = nineBoxGridData[key]; } }
        }
    }
}


    // --- Gráficas de Barras Horizontales por Fase ---
    function updateMMRDistributionCharts(selectedBlock) {
        const { docentes } = data.formacionDocente;
        const gestionCounts = {};
        const rigorCounts = {};

        docentes.forEach(docente => {
            const blockData = docente.bloques[selectedBlock];
            let faseG = 'N/A';
            let faseR = 'N/A';

            if (blockData) {
                faseG = String(blockData.gestion).trim() || 'N/A';
                faseR = String(blockData.rigor).trim() || 'N/A';
            }
            
            if (!isNaN(faseG) && faseG !== 'N/A' && !faseG.includes('.')) faseG = parseFloat(faseG).toFixed(1);
            if (!isNaN(faseR) && faseR !== 'N/A' && !faseR.includes('.')) faseR = parseFloat(faseR).toFixed(1);

            gestionCounts[faseG] = (gestionCounts[faseG] || 0) + 1;
            rigorCounts[faseR] = (rigorCounts[faseR] || 0) + 1;
        });

        const createOrUpdateChart = (canvasId, titleId, chartInstance, counts, title) => {
            const canvas = getEl(canvasId);
            if (!canvas) {
                console.warn(`Canvas no encontrado: ${canvasId}`);
                return null;
            }

            const titleEl = getEl(titleId);
            if(titleEl) titleEl.textContent = `${title} (${selectedBlock})`;

            const sortedLabels = Object.keys(counts).sort((a, b) => {
                if (a === 'N/A') return 1;
                if (b === 'N/A') return -1;
                const numA = parseFloat(a) || 0;
                const numB = parseFloat(b) || 0;
                if (numA === 0 && numB === 0) return a.localeCompare(b);
                return numA - numB;
            });
            
            const dataValues = sortedLabels.map(label => counts[label]);

            const chartOptions = {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    title: { display: false },
                    datalabels: {
                        anchor: 'end',
                        align: 'right',
                        padding: { right: 6 },
                        color: '#1F2937',
                        font: { weight: 'bold' },
                        formatter: (value) => value
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Cantidad de Docentes'
                        },
                        ticks: {
                            stepSize: 1
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Fase MMR'
                        }
                    }
                }
            };

            if (chartInstance) {
                chartInstance.destroy();
            }
            
            return new Chart(canvas, {
                type: 'bar',
                data: {
                    labels: sortedLabels,
                    datasets: [{
                        label: 'Cantidad de Docentes',
                        data: dataValues,
                        backgroundColor: 'rgba(59, 130, 246, 0.7)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 1
                    }]
                },
                options: chartOptions
            });
        };

        window.mmrGestionChartInstance = createOrUpdateChart(
            'mmrGestionChart', 
            'mmrGestionChartTitle', 
            window.mmrGestionChartInstance, 
            gestionCounts, 
            'Distribución Fases - Gestión'
        );
        
        window.mmrRigorChartInstance = createOrUpdateChart(
            'mmrRigorChart', 
            'mmrRigorChartTitle', 
            window.mmrRigorChartInstance, 
            rigorCounts, 
            'Distribución Fases - Rigor'
        );
    }


    // --- Función para actualizar Vista de Detalle por Docente (MODIFICADA) ---
    function updateFormacionDetailView(docenteNombre, selectedBlock) {
        const docente = docentes.find(d => d.nombre === docenteNombre);
        
        // --- INICIO DE LA CORRECCIÓN ---
        // Volvemos a buscar los elementos del DOM CADA VEZ que se ejecuta la función
        const placeholder = getEl('formacion-placeholder');
        const detailContainer = getEl('formacion-detail-container');
        const nombreEl = getEl('formacion-docente-nombre');
        const cajasEl = getEl('formacion-docente-9cajas');
        const gestionEl = getEl('formacion-docente-mmr-gestion');
        const rigorEl = getEl('formacion-docente-mmr-rigor');
        const oaoEl = getEl('formacion-docente-1a1');
        const rsdEl = getEl('formacion-docente-rsd');
        const gestionDetailsEl = getEl('formacion-docente-gestion-details');
        const rigorDetailsEl = getEl('formacion-docente-rigor-details');
        // --- FIN DE LA CORRECCIÓN ---

        if (!placeholder || !detailContainer || !nombreEl || !cajasEl || !gestionEl || !rigorEl || !oaoEl || !rsdEl || !gestionDetailsEl || !rigorDetailsEl) {
            console.error("Faltan elementos HTML para el detalle del docente (fueron buscados en updateFormacionDetailView).");
            return;
        }

        if (!docente) {
            placeholder.classList.remove('hidden');
            detailContainer.classList.add('hidden');
            return;
        }

        placeholder.classList.add('hidden');
        detailContainer.classList.remove('hidden');

        const blockData = docente.bloques[selectedBlock];

        nombreEl.textContent = docente.nombre;
        cajasEl.textContent = docente.latest9Cajas || 'N/A';

        if (blockData) {
            gestionEl.textContent = blockData.gestion || 'N/A';
            rigorEl.textContent = blockData.rigor || 'N/A';
            oaoEl.textContent = blockData.oao || 0;
            rsdEl.textContent = blockData.rsd || 0;
        } else {
            gestionEl.textContent = 'N/A';
            rigorEl.textContent = 'N/A';
            oaoEl.textContent = 0;
            rsdEl.textContent = 0;
        }

        const displayPhaseDetails = (phaseString, type, element) => {
            element.innerHTML = '';
            if (!phaseString || phaseString === 'N/A') {
                element.innerHTML = '<p>No hay datos de fase disponibles para este bloque.</p>';
                return;
            }

            const match = phaseString.toString().match(/(\d+(\.\d+)?)/);
            if (!match) {
                element.innerHTML = `<p>Valor de fase no reconocido: "${phaseString}"</p>`;
                return;
            }

            const numberString = match[0];
            const parts = numberString.split('.');
            const mainPhaseNum = parseInt(parts[0]);
            const subPhaseNum = parts.length > 1 ? parseInt(parts[1]) : null;
            const phaseData = phaseDescriptions[type]?.[mainPhaseNum];

            if (phaseData) {
                const titleEl = document.createElement('p');
                titleEl.className = 'font-semibold mb-1';
                titleEl.textContent = phaseData.title;
                element.appendChild(titleEl);

                const ul = document.createElement('ul');
                ul.className = 'list-disc pl-5 space-y-1';
                for (const num in phaseData.subphases) {
                    const li = document.createElement('li');
                    li.textContent = `${num}. ${phaseData.subphases[num]}`;
                    if (subPhaseNum !== null && parseInt(num) === subPhaseNum) {
                        li.classList.add('current-subphase');
                    }
                    ul.appendChild(li);
                }
                element.appendChild(ul);
            } else {
                element.innerHTML = `<p>Descripción no encontrada para la fase ${phaseString}.</p>`;
            }
        };

        displayPhaseDetails(blockData?.gestion, 'gestion', gestionDetailsEl);
        displayPhaseDetails(blockData?.rigor, 'rigor', rigorDetailsEl);
    }

    // --- Inicialización y Event Listeners ---
    const allBlocks = data.formacionDocente.bloques;
    if (allBlocks.length === 0) {
        console.warn("No se encontraron bloques en los datos de formación docente.");
        overviewBlockFilter.innerHTML = '<option value="">Sin Bloques</option>';
        detailBlockFilter.innerHTML = '<option value="">Sin Bloques</option>';
        teacherFilter.innerHTML = '<option value="">Sin Docentes</option>';
        overviewBlockFilter.disabled = true;
        detailBlockFilter.disabled = true;
        teacherFilter.disabled = true;
        
        const placeholder = getEl('formacion-placeholder');
        const detailContainer = getEl('formacion-detail-container');
        if(placeholder) placeholder.classList.remove('hidden');
        if(detailContainer) detailContainer.classList.add('hidden');
        
        getEl('formacion-overview-container').classList.add('hidden');
        return;
    }

    overviewBlockFilter.innerHTML = '';
    detailBlockFilter.innerHTML = '';
    allBlocks.forEach(b => {
        overviewBlockFilter.innerHTML += `<option value="${b}">${b}</option>`;
        detailBlockFilter.innerHTML += `<option value="${b}">${b}</option>`;
    });

    let defaultBlock = "Bloque 1";
    if (!allBlocks.includes(defaultBlock)) {
        defaultBlock = allBlocks.length > 0 ? allBlocks[0] : "";
    }

    if (defaultBlock) {
        overviewBlockFilter.value = defaultBlock;
        detailBlockFilter.value = defaultBlock;
    } else {
        console.warn("No se pudo establecer un bloque por defecto para Formación Docente.");
    }

    teacherFilter.innerHTML = '<option value="">Seleccione un docente...</option>';
    docentes.forEach(d => {
        teacherFilter.innerHTML += `<option value="${d.nombre}">${d.nombre}</option>`;
    });

    // Listeners
    overviewBlockFilter.addEventListener('change', (e) => {
        const selectedBlock = e.target.value;
        updateFormacionOverview(selectedBlock);
        updateMMRDistributionCharts(selectedBlock);
    });

    teacherFilter.addEventListener('change', (e) => {
        const teacher = e.target.value;
        const block = detailBlockFilter.value;
        if (teacher) {
            updateFormacionDetailView(teacher, block);
        } else {
            // --- INICIO DE LA CORRECCIÓN ---
            // Volvemos a buscar los elementos para ocultarlos
            const placeholder = getEl('formacion-placeholder');
            const detailContainer = getEl('formacion-detail-container');
            const gestionDetailsEl = getEl('formacion-docente-gestion-details');
            const rigorDetailsEl = getEl('formacion-docente-rigor-details');

            if(placeholder) placeholder.classList.remove('hidden');
            if(detailContainer) detailContainer.classList.add('hidden');
            if(gestionDetailsEl) gestionDetailsEl.innerHTML = '<p>Seleccione un docente y bloque.</p>';
            if(rigorDetailsEl) rigorDetailsEl.innerHTML = '<p>Seleccione un docente y bloque.</p>';
            // --- FIN DE LA CORRECCIÓN ---
        }
    });

    detailBlockFilter.addEventListener('change', (e) => {
        const teacher = teacherFilter.value;
        const block = e.target.value;
        if (teacher) {
            updateFormacionDetailView(teacher, block);
        }
    });

    // Carga inicial
    const initialBlock = overviewBlockFilter.value;
    updateFormacionOverview(initialBlock);
    updateMMRDistributionCharts(initialBlock);

    // Asegurarse de que el placeholder esté visible al inicio
    const placeholder = getEl('formacion-placeholder');
    const detailContainer = getEl('formacion-detail-container');
    if (!teacherFilter.value) {
        if(placeholder) placeholder.classList.remove('hidden');
        if(detailContainer) detailContainer.classList.add('hidden');
    }
}
// ======================================================
// =========== FIN: FUNCIÓN FORMACIÓN DOCENTE ===========
// ======================================================

            periodFilter.addEventListener('change', (e) => updateSummary(e.target.value));
            if(gradeFilter) gradeFilter.addEventListener('change', e => { const selectedGrade = e.target.value; if (selectedGrade === 'Todos') { groupFilter.innerHTML = '<option value="Todos">Todos</option>'; groupFilter.disabled = true; } else { groupFilter.disabled = false; populateGroupFilter(selectedGrade); } updateCalificacionesGradoCharts(selectedGrade, groupFilter.value, blockFilter.value, genderFilterCal.value); });
            if(groupFilter) groupFilter.addEventListener('change', e => { updateCalificacionesGradoCharts(gradeFilter.value, e.target.value, blockFilter.value, genderFilterCal.value); });
            if(blockFilter) blockFilter.addEventListener('change', e => { updateCalificacionesGradoCharts(gradeFilter.value, groupFilter.value, e.target.value, genderFilterCal.value); });
            if(genderFilterCal) genderFilterCal.addEventListener('change', e => { updateCalificacionesGradoCharts(gradeFilter.value, groupFilter.value, blockFilter.value, e.target.value); });
            if(getEl('expediente-block-filter')) getEl('expediente-block-filter').addEventListener('change', () => { const studentId = getEl('expediente-student-filter').value; if(studentId){ const student = data.listaEstudiantes.find(s => s.id == studentId); const selectedBlock = getEl('expediente-block-filter').value; const newAverages = updateExpedienteSubjectAverages(student, selectedBlock); updateExpedienteRadarChart(newAverages, selectedBlock); }});
            async function generateStudentPDF() { const studentName = getEl('expediente-nombre').textContent || "Estudiante"; const fileName = `Expediente-${studentName.replace(/ /g, '_')}.pdf`; const downloadButton = getEl('download-pdf-button'); const contentToCapture = getEl('expediente-container'); downloadButton.style.visibility = 'hidden'; try { const canvas = await html2canvas(contentToCapture, { scale: 2, backgroundColor: '#ffffff', onclone: (clonedDoc) => { const filterContainer = clonedDoc.getElementById('expediente-filter-container'); if (filterContainer) { const selectedBlock = document.getElementById('expediente-block-filter').value; filterContainer.innerHTML = `<p class="text-right text-sm text-gray-600 font-medium mb-4">Mostrando resultados para: <strong>${selectedBlock}</strong></p>`; } Array.from(clonedDoc.getElementsByTagName('canvas')).forEach(canvasEl => { if (canvasEl.__chartjs__) { canvasEl.__chartjs__.options.animation = false; } }); } }); const imgData = canvas.toDataURL('image/png'); const { jsPDF } = window.jspdf; const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' }); const pageHeight = pdf.internal.pageSize.getHeight() - 20; const pageWidth = pdf.internal.pageSize.getWidth() - 20; const imgRatio = canvas.width / canvas.height; let finalWidth = pageWidth; let finalHeight = finalWidth / imgRatio; if (finalHeight > pageHeight) { finalHeight = pageHeight; finalWidth = finalHeight * imgRatio; } const x = (pdf.internal.pageSize.getWidth() - finalWidth) / 2; const y = 10; pdf.addImage(imgData, 'PNG', x, y, finalWidth, finalHeight); pdf.save(fileName); } catch (error) { console.error("Error al generar el PDF:", error); alert("Hubo un error al generar el PDF. Revisa la consola para más detalles."); } finally { downloadButton.style.visibility = 'visible'; } }
            if(getEl('download-pdf-button')) getEl('download-pdf-button').addEventListener('click', generateStudentPDF);

            lucide.createIcons();
            populateFilter();
            updateSummary('General');
            createGeneralCharts();
            createStudentCharts();
            setupStudentFilters();
            updateStudentCharts();
            populateGradeFilter();
            if (data.listaEstudiantes.length > 0 && gradeFilter) { const initialGrade = gradeFilter.value; if (initialGrade === 'Todos') { groupFilter.innerHTML = '<option value="Todos">Todos</option>'; groupFilter.disabled = true; } else { populateGroupFilter(initialGrade); groupFilter.disabled=false; } updateCalificacionesGradoCharts(initialGrade, groupFilter.value, 'General', genderFilterCal.value); } else if (groupFilter) { groupFilter.disabled = true;}
            populateBlockFilter();
            setupBoletosFilters();
            updateBoletosChart();
            setupExpedienteFilters();
            createAsistenciaPadresSection(data);
            createEntregablesSection(data);
            createDesarrolloProfesionalSection(data);
            createFormacionDocenteSection(data); // <-- LLAMADA AÑADIDA
            manageVisibility();
        }

        // --- Demo Data ---
        function getDemoData() {
             return {
                 resumenGeneral: { matricula: 452, asistencia: 92.1, bajas: 15, docentes: 28, prom_matematicas: 8.4, prom_espanol: 8.9, prom_ciencias: 8.1, prom_ingles: 9.3, alumnosBAP: 2, prom_asistencia_padres: 86.3 },
                 resumenMensual: [ { periodo: "Enero", matricula: 435, bajas: 2, asistencia: 95.5, prom_matematicas: 8.2, prom_espanol: 8.8, prom_ciencias: 7.5, prom_ingles: 9, prom_asistencia_padres: 85 }, { periodo: "Febrero", matricula: 440, bajas: 1, asistencia: 96, prom_matematicas: 7.9, prom_espanol: 8.5, prom_ciencias: 8, prom_ingles: 9.2, prom_asistencia_padres: 90 }],
                 resumenPorBloque: [ { bloque: "Bloque 1", matricula: 425, bajas: 1, asistencia: 96, prom_matematicas: 8.2, prom_espanol: 8.8, prom_ciencias: 7.5, prom_ingles: 9, prom_asistencia_padres: 85 }, { bloque: "Bloque 2", matricula: 438, bajas: 1, asistencia: 95, prom_matematicas: 7.9, prom_espanol: 8.5, prom_ciencias: 8, prom_ingles: 9.2, prom_asistencia_padres: 90 }],
                 listaEstudiantes: [ { id: 1, clave_escolar: 'DEMO-001', nombre: "Ana García (Demo)", genero: "Femenino", grado: "1ro", grupo: "A", status: "activo", motivoBaja: null, bap: "Sí", asistencia: { 9: 98, 10: 95 }, calificaciones: { "Bloque 1": { m: 9.6, e: 9, c: 8, i: 9 }, "Bloque 2": { m: 9.8, e: 9, c: 8, i: 10 } }, boletos: { "Bloque 1": { Matemáticas: [{ date: "2025-09-18", score: 3 }] } } }, { id: 2, clave_escolar: 'DEMO-002', nombre: "Luis Rodríguez (Demo)", genero: "Masculino", grado: "1ro", grupo: "A", status: "activo", motivoBaja: null, bap: "No", asistencia: { 9: 95, 10: 100 }, calificaciones: { "Bloque 1": { m: 8.5, e: 9, c: 8, i: 9 }, "Bloque 2": { m: 9, e: 9, c: 9, i: 9 } }, boletos: {} } ],
                 docentes: { altas: [2, 1, 3, 1, 0, 1], bajas: [1, 0, 1, 0, 1, 0], meses: ["Mar", "Abr", "May", "Jun", "Jul", "Ago"] },
                 calificaciones: { matematicas: [8.2, 7.9], espanol: [8.8, 8.5], ciencias: [7.5, 8], ingles: [9, 9.2], bloques: ["Bloque 1", "Bloque 2"] },
                 asistenciaPadres: [ { sesion: 1, porcentaje_asistencia: 85.0, fecha: "15-09-2025", titulo_sesion: "Crianza Positiva (Demo)", esperados: 200, asistentes: 170 }, { sesion: 2, porcentaje_asistencia: 92.5, fecha: "20-10-2025", titulo_sesion: "Seguridad en Internet (Demo)", esperados: 200, asistentes: 185 }, { sesion: 3, porcentaje_asistencia: 80.0, fecha: "18-11-2025", titulo_sesion: "Apoyo en Tareas (Demo)", esperados: 200, asistentes: 160 } ],
                 estudiantes: {meses: ["Agosto", "Septiembre"], matricula: [450, 452]},
                 entregables: [
                     { Categoria: "Estadísticas", NombreEntregable: "Reporte Asistencia Sep (Demo)", FechaLimite: "05-10-2025" },
                     { Categoria: "Calificaciones", NombreEntregable: "Carga Mat B1 (Demo)", FechaLimite: "18-10-2025" },
                     { Categoria: "Calificaciones", NombreEntregable: "Carga Esp B1 (Demo)", FechaLimite: "19-10-2025" },
                     { Categoria: "Calificaciones", NombreEntregable: "Carga Cie B1 (Demo)", FechaLimite: "20-10-2025" },
                     { Categoria: "Calificaciones", NombreEntregable: "Carga Ing B1 (Demo)", FechaLimite: "21-10-2025" },
                     { Categoria: "Planeación", NombreEntregable: "Entrega Plan Nov (Demo)", FechaLimite: "28-10-2025" },
                     { Categoria: "Estadísticas", NombreEntregable: "Reporte Asistencia Oct (Demo)", FechaLimite: "05-11-2025" },
                      { Categoria: "Calificaciones", NombreEntregable: "Carga Mat B2 (Demo)", FechaLimite: "15-12-2025" }
                 ],
                 desarrolloProfesional: [
                     {
                         bloque: "Bloque 1 (Demo)",
                         fecha: "15/09/2025",
                         fechaObj: new Date(2025, 8, 15),
                         brecha: "Uso de IA",
                         tema: "IA en el Aula (Demo)",
                         objetivo: "Implementar ChatGPT para planeación"
                     },
                     {
                         bloque: "Bloque 1 (Demo)",
                         fecha: "22/09/2025",
                         fechaObj: new Date(2025, 8, 22),
                         brecha: "Evaluación",
                         tema: "Nuevas Herramientas de Evaluación (Demo)",
                         objetivo: "Probar 2 nuevas herramientas"
                     },
                     { // Ejemplo sin tema
                         bloque: "Bloque 2 (Demo)",
                         fecha: "10/10/2025",
                         fechaObj: new Date(2025, 9, 10),
                         brecha: "Planificación",
                         tema: "", // Tema vacío
                         objetivo: "Revisar planes anuales"
                     }
                 ],
                 // DATOS DEMO PARA FORMACIÓN DOCENTE
                 formacionDocente: {
                    bloques: ["Bloque 1", "Bloque 2"],
                    docentes: [
                        { nombre: "Docente Alfa (Demo)", bloques: { "Bloque 1": { gestion: "2.1", rigor: "2.0", oao: 4, rsd: 3, cajas: "2A" }, "Bloque 2": { gestion: "2.3", rigor: "2.2", oao: 3, rsd: 4, cajas: "1A" } }, latest9Cajas: "1A" },
                        { nombre: "Docente Beta (Demo)", bloques: { "Bloque 1": { gestion: "1.5", rigor: "1.8", oao: 2, rsd: 2, cajas: "3C" }, "Bloque 2": { gestion: "1.8", rigor: "2.0", oao: 4, rsd: 3, cajas: "2A" } }, latest9Cajas: "2A" },
                        { nombre: "Docente Gamma (Demo)", bloques: { "Bloque 1": { gestion: "3.0", rigor: "2.8", oao: 5, rsd: 4, cajas: "1A"} }, latest9Cajas: "1A" } // Solo tiene datos B1
                    ]
                 }
             };
         }

        // === Fin del código JavaScript ===

    </script>
</body>
</html>
