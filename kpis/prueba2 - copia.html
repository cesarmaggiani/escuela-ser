<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tablero de Control Escolar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; }
        .sidebar { transition: transform 0.3s ease-in-out; }
        .main-content { transition: margin-left 0.3s ease-in-out; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        #menu-button { transition: transform 0.3s; }
        .active-link {
            background-color: #4a5568;
            color: #ffffff;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="login-screen" class="fixed inset-0 flex items-center justify-center bg-gray-100 z-50">
        <div class="bg-white p-8 md:p-12 rounded-xl shadow-2xl text-center w-full max-w-md mx-4">
            <div class="flex justify-center items-center mb-4">
                <i data-lucide="bar-chart-3" class="h-10 w-10 text-blue-600"></i>
            </div>
            <h1 class="text-3xl font-bold text-gray-800 mb-2">Control Escolar</h1>
            <p class="text-gray-600 mb-8">Inicia sesión para acceder al tablero.</p>

            <div class="mb-6 w-full">
                <label for="school-selector" class="block text-sm font-medium text-gray-700 mb-2 text-left">Selecciona tu escuela:</label>
                <select id="school-selector" name="school" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" disabled>
                    <option selected>Cargando escuelas...</option>
                </select>
            </div>
            <button id="login-button" class="bg-blue-600 text-white w-full flex items-center justify-center px-4 py-3 rounded-lg shadow-md hover:bg-blue-700 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                <svg class="w-6 h-6 mr-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><defs><path id="a" d="M44.5 20H24v8.5h11.8C34.7 33.9 30.1 37 24 37c-7.2 0-13-5.8-13-13s5.8-13 13-13c3.1 0 5.9 1.1 8.1 2.9l6.4-6.4C34.6 4.1 29.6 2 24 2 11.8 2 2 11.8 2 24s9.8 22 22 22c11 0 21-8 21-22 0-1.3-.2-2.7-.5-4z"/></defs><clipPath id="b"><use xlink:href="#a" overflow="visible"/></clipPath><path clip-path="url(#b)" fill="#FBBC05" d="M0 37V11l17 13z"/><path clip-path="url(#b)" fill="#EA4335" d="M0 11l17 13 7-6.1L48 14V0H0z"/><path clip-path="url(#b)" fill="#34A853" d="M0 37l30-23.5 7.9 1L48 0v48H0z"/><path clip-path="url(#b)" fill="#4285F4" d="M48 48L17 24l-4-3 35-10z"/></svg>
                <span class="font-semibold">Iniciar Sesión con Google</span>
            </button>
        </div>
    </div>
    
    <div id="app-wrapper" class="flex h-screen w-full hidden">
        <aside id="sidebar" class="bg-gray-800 text-white w-64 space-y-6 py-7 px-2 absolute inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0 transition duration-200 ease-in-out z-20">
            <a href="#" class="text-white flex items-center space-x-3 px-4">
                <i data-lucide="bar-chart-3" id="default-icon" class="h-8 w-8"></i>
                <img id="school-logo-sidebar" src="" alt="Logo Escuela" class="h-10 w-10 object-contain hidden rounded-md">
                
                <span class="text-2xl font-extrabold">Control Escolar</span>
            </a>
            <nav id="main-nav">
                <a href="#resumen" class="block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700 nav-link active-link"><i data-lucide="home" class="inline-block w-5 h-5 mr-2"></i> Resumen</a>
                <a href="#estudiantes" class="block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700 nav-link"><i data-lucide="users" class="inline-block w-5 h-5 mr-2"></i> Estudiantes</a>
                <a href="#docentes" class="block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700 nav-link"><i data-lucide="briefcase" class="inline-block w-5 h-5 mr-2"></i> Docentes</a>
                <a href="#calificaciones" class="block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700 nav-link"><i data-lucide="book-marked" class="inline-block w-5 h-5 mr-2"></i> Calificaciones</a>
                <a href="#calificaciones-grado" class="block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700 nav-link"><i data-lucide="graduation-cap" class="inline-block w-5 h-5 mr-2"></i> Calificaciones por Grado</a>
                <a href="#boletos-salida" class="block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700 nav-link"><i data-lucide="ticket" class="inline-block w-5 h-5 mr-2"></i> Boletos de Salida</a>
                <a href="#expediente-estudiante" class="block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700 nav-link"><i data-lucide="contact-2" class="inline-block w-5 h-5 mr-2"></i> Expediente Estudiante</a>
                <a href="#asistencia-padres" class="block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700 nav-link"><i data-lucide="users" class="inline-block w-5 h-5 mr-2"></i> Escuela para Padres</a>
            </nav>
        </aside>
    
        <div class="flex-1 flex flex-col overflow-hidden">
            <header class="flex justify-between items-center py-4 px-6 bg-white border-b-2">
                <button id="menu-button" class="text-gray-500 focus:outline-none md:hidden"><i data-lucide="menu" class="h-6 w-6"></i></button>
                <div class="flex items-center space-x-4 ml-auto">
                    <span id="user-info" class="text-gray-600 hidden"></span>
                    <button id="signout_button" class="bg-red-500 text-white px-4 py-2 rounded shadow hover:bg-red-600 hidden">Cerrar Sesión</button>
                </div>
            </header>
            
            <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-4 md:p-6">
                <div id="loading-indicator" class="text-center p-10 hidden">
                    <i data-lucide="loader-2" class="mx-auto h-12 w-12 text-gray-400 animate-spin"></i>
                    <h3 class="mt-2 text-sm font-medium text-gray-900">Cargando datos...</h3>
                    <p class="mt-1 text-sm text-gray-500">Obteniendo la información desde Google Sheets.</p>
                </div>
                
                <div id="unauthorized-message" class="text-center p-10 hidden">
                    <i data-lucide="lock" class="mx-auto h-12 w-12 text-red-500"></i>
                    <h3 class="mt-2 text-sm font-medium text-gray-900">Acceso Denegado</h3>
                    <p class="mt-1 text-sm text-gray-500">Tu cuenta no tiene permisos para ver este tablero. Por favor, contacta al administrador.</p>
                </div>
    
                <div id="main-container" class="container mx-auto hidden">
                    <section id="resumen" class="content-section fade-in">
                        <div class="flex flex-wrap justify-between items-center mb-6"><h2 class="text-3xl font-bold text-gray-800">Resumen General</h2><div class="mt-4 sm:mt-0"><label for="period-filter" class="text-sm font-medium text-gray-700 mr-2">Filtrar por:</label><select id="period-filter" class="rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"></select></div></div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 xl:grid-cols-5 gap-6">
                            <div class="bg-white p-6 rounded-xl shadow-md flex items-center justify-between"><div><p class="text-sm font-medium text-gray-500">Matrícula Total</p><p id="summary-matricula" class="text-3xl font-bold text-gray-800">0</p></div><div class="bg-blue-100 p-3 rounded-full"><i data-lucide="user-check" class="h-6 w-6 text-blue-500"></i></div></div>
                            <div class="bg-white p-6 rounded-xl shadow-md flex items-center justify-between"><div><p class="text-sm font-medium text-gray-500">Alumnos BAP</p><p id="summary-bap" class="text-3xl font-bold text-gray-800">0</p></div><div class="bg-orange-100 p-3 rounded-full"><i data-lucide="heart" class="h-6 w-6 text-orange-500"></i></div></div>
                            <div class="bg-white p-6 rounded-xl shadow-md flex items-center justify-between"><div><p class="text-sm font-medium text-gray-500">Asistencia Promedio</p><p id="summary-asistencia" class="text-3xl font-bold text-gray-800">0%</p></div><div class="bg-green-100 p-3 rounded-full"><i data-lucide="calendar-check-2" class="h-6 w-6 text-green-500"></i></div></div>
                            <div id="card-bajas" class="bg-white p-6 rounded-xl shadow-md flex items-center justify-between"><div><p class="text-sm font-medium text-gray-500">Bajas de Estudiantes</p><p id="summary-bajas" class="text-3xl font-bold text-gray-800">0</p></div><div class="bg-red-100 p-3 rounded-full"><i data-lucide="user-minus" class="h-6 w-6 text-red-500"></i></div></div>
                            <div id="card-docentes" class="bg-white p-6 rounded-xl shadow-md flex items-center justify-between"><div><p class="text-sm font-medium text-gray-500">Docentes Activos</p><p id="summary-docentes" class="text-3xl font-bold text-gray-800">0</p></div><div class="bg-indigo-100 p-3 rounded-full"><i data-lucide="briefcase" class="h-6 w-6 text-indigo-500"></i></div></div>
                            <div id="card-padres" class="bg-white p-6 rounded-xl shadow-md flex items-center justify-between"><div><p class="text-sm font-medium text-gray-500">Asistencia Padres</p><p id="summary-padres" class="text-3xl font-bold text-gray-800">0%</p></div><div class="bg-teal-100 p-3 rounded-full"><i data-lucide="users" class="h-6 w-6 text-teal-500"></i></div></div>
                            <div id="summary-matematicas-card" class="bg-white p-6 rounded-xl shadow-md flex items-center justify-between"><div><p class="text-sm font-medium text-gray-500">Prom. Matemáticas</p><p id="summary-matematicas" class="text-3xl font-bold text-gray-800">0.0</p></div><div class="bg-yellow-100 p-3 rounded-full"><i data-lucide="function-square" class="h-6 w-6 text-yellow-500"></i></div></div>
                            <div id="summary-espanol-card" class="bg-white p-6 rounded-xl shadow-md flex items-center justify-between"><div><p class="text-sm font-medium text-gray-500">Prom. Español</p><p id="summary-espanol" class="text-3xl font-bold text-gray-800">0.0</p></div><div class="bg-purple-100 p-3 rounded-full"><i data-lucide="pilcrow" class="h-6 w-6 text-purple-500"></i></div></div>
                            <div id="summary-ciencias-card" class="bg-white p-6 rounded-xl shadow-md flex items-center justify-between"><div><p class="text-sm font-medium text-gray-500">Prom. Ciencias</p><p id="summary-ciencias" class="text-3xl font-bold text-gray-800">0.0</p></div><div class="bg-green-100 p-3 rounded-full"><i data-lucide="flask-conical" class="h-6 w-6 text-green-500"></i></div></div>
                            <div id="summary-ingles-card" class="bg-white p-6 rounded-xl shadow-md flex items-center justify-between"><div><p class="text-sm font-medium text-gray-500">Prom. Inglés</p><p id="summary-ingles" class="text-3xl font-bold text-gray-800">0.0</p></div><div class="bg-blue-100 p-3 rounded-full"><i data-lucide="languages" class="h-6 w-6 text-blue-500"></i></div></div>
                        </div>
                    </section>
                    <section id="estudiantes" class="content-section hidden fade-in">
                        <h2 class="text-3xl font-bold mb-6 text-gray-800">Estadísticas de Estudiantes</h2>
                        <div class="bg-white p-4 rounded-xl shadow-md mb-6"><div class="flex flex-wrap gap-4 items-center justify-between"><div class="flex flex-wrap gap-4 items-center"><h3 class="font-bold text-lg text-gray-700">Filtros:</h3><div><label for="student-grade-filter" class="text-sm font-medium text-gray-700 mr-2">Grado:</label><select id="student-grade-filter" class="rounded-md border-gray-300 shadow-sm"></select></div><div><label for="student-group-filter" class="text-sm font-medium text-gray-700 mr-2">Grupo:</label><select id="student-group-filter" class="rounded-md border-gray-300 shadow-sm"></select></div><div><label for="student-gender-filter" class="text-sm font-medium text-gray-700 mr-2">Género:</label><select id="student-gender-filter" class="rounded-md border-gray-300 shadow-sm"><option value="Todos">Todos</option><option value="Femenino">Femenino</option><option value="Masculino">Masculino</option></select></div><div><label for="student-bap-filter" class="text-sm font-medium text-gray-700 mr-2">BAP:</label><select id="student-bap-filter" class="rounded-md border-gray-300 shadow-sm"><option value="Todos">Todos</option><option value="Sí">Sí</option><option value="No">No</option></select></div></div><div class="text-right"><p class="text-sm font-medium text-gray-500">Total Estudiantes</p><p id="student-count-stats" class="text-2xl font-bold text-gray-800">0</p></div></div></div>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6"><div class="bg-white p-6 rounded-xl shadow-md"><h3 class="font-bold text-lg text-gray-700">Movimiento de Matrícula</h3><canvas id="matriculaChart" class="mt-4"></canvas></div><div class="bg-white p-6 rounded-xl shadow-md lg:col-span-2"><h3 id="asistencia-chart-title" class="font-bold text-lg text-gray-700">Análisis de Asistencia Mensual</h3><canvas id="asistenciaChart" class="mt-4"></canvas></div></div>
                    </section>
                    <section id="docentes" class="content-section hidden fade-in"><h2 class="text-3xl font-bold mb-6 text-gray-800">Estadísticas de Docentes</h2><div class="grid grid-cols-1 lg:grid-cols-2 gap-6"><div class="bg-white p-6 rounded-xl shadow-md"><h3 class="font-bold text-lg text-gray-700">Altas y Bajas (Último Semestre)</h3><canvas id="docentesChart" class="mt-4"></canvas></div></div></section>
                    <section id="calificaciones" class="content-section hidden fade-in">
                        <h2 class="text-3xl font-bold mb-6 text-gray-800">Rendimiento Académico General</h2>
                        <div class="grid grid-cols-1 gap-6">
                            <div id="calificacionesMatematicas-container" class="bg-white p-6 rounded-xl shadow-md"><div class="flex flex-wrap justify-between items-center"><h3 class="font-bold text-lg text-gray-700">Promedio por Bloque: Matemáticas</h3><div class="mt-2 sm:mt-0"><span class="text-sm font-medium text-gray-500 mr-2">Nivel General:</span><span id="nivel-logro-matematicas" class="text-sm font-bold px-2 py-1 rounded-md"></span></div></div><canvas id="calificacionesMatematicasChart" class="mt-4"></canvas></div>
                            <div id="calificacionesEspanol-container" class="bg-white p-6 rounded-xl shadow-md"><div class="flex flex-wrap justify-between items-center"><h3 class="font-bold text-lg text-gray-700">Promedio por Bloque: Español</h3><div class="mt-2 sm:mt-0"><span class="text-sm font-medium text-gray-500 mr-2">Nivel General:</span><span id="nivel-logro-espanol" class="text-sm font-bold px-2 py-1 rounded-md"></span></div></div><canvas id="calificacionesEspanolChart" class="mt-4"></canvas></div>
                            <div id="calificacionesCiencias-container" class="bg-white p-6 rounded-xl shadow-md"><div class="flex flex-wrap justify-between items-center"><h3 class="font-bold text-lg text-gray-700">Promedio por Bloque: Ciencias</h3><div class="mt-2 sm:mt-0"><span class="text-sm font-medium text-gray-500 mr-2">Nivel General:</span><span id="nivel-logro-ciencias" class="text-sm font-bold px-2 py-1 rounded-md"></span></div></div><canvas id="calificacionesCienciasChart" class="mt-4"></canvas></div>
                            <div id="calificacionesIngles-container" class="bg-white p-6 rounded-xl shadow-md"><div class="flex flex-wrap justify-between items-center"><h3 class="font-bold text-lg text-gray-700">Promedio por Bloque: Inglés</h3><div class="mt-2 sm:mt-0"><span class="text-sm font-medium text-gray-500 mr-2">Nivel General:</span><span id="nivel-logro-ingles" class="text-sm font-bold px-2 py-1 rounded-md"></span></div></div><canvas id="calificacionesInglesChart" class="mt-4"></canvas></div>
                        </div>
                    </section>
                    <section id="calificaciones-grado" class="content-section hidden fade-in"><h2 class="text-3xl font-bold mb-6 text-gray-800">Calificaciones por Grado y Grupo</h2><div class="bg-white p-6 rounded-xl shadow-md"><div class="flex flex-wrap gap-4 mb-4 items-center justify-between"><div class="flex flex-wrap gap-4 items-center"><div><label for="grade-filter" class="text-sm font-medium text-gray-700 mr-2">Grado:</label><select id="grade-filter" class="rounded-md border-gray-300 shadow-sm"></select></div><div><label for="group-filter" class="text-sm font-medium text-gray-700 mr-2">Grupo:</label><select id="group-filter" class="rounded-md border-gray-300 shadow-sm"></select></div><div><label for="block-filter" class="text-sm font-medium text-gray-700 mr-2">Bloque:</label><select id="block-filter" class="rounded-md border-gray-300 shadow-sm"></select></div><div><label for="gender-filter-cal" class="text-sm font-medium text-gray-700 mr-2">Género:</label><select id="gender-filter-cal" class="rounded-md border-gray-300 shadow-sm"><option value="Todos">Todos</option><option value="Femenino">Femenino</option><option value="Masculino">Masculino</option></select></div></div><div class="text-right"><p class="text-sm font-medium text-gray-500">Estudiantes Filtrados</p><p id="student-count-grades" class="text-2xl font-bold text-gray-800">0</p></div></div><div class="grid grid-cols-1 lg:grid-cols-2 gap-6"><div><h3 class="font-bold text-lg text-gray-700 mb-2">Promedio por Materia</h3><canvas id="calificacionesGradoChart" class="mt-4"></canvas></div><div><h3 class="font-bold text-lg text-gray-700 mb-2">Distribución de Niveles de Logro</h3><canvas id="nivelLogroChart" class="mt-4"></canvas></div></div></div></section>
                    <section id="boletos-salida" class="content-section hidden fade-in"><h2 class="text-3xl font-bold mb-6 text-gray-800">Análisis de Boletos de Salida</h2><div class="bg-white p-6 rounded-xl shadow-md"><div class="flex flex-wrap gap-4 mb-4 items-center"><div><label for="boleto-block-filter" class="text-sm font-medium text-gray-700 mr-2">Bloque:</label><select id="boleto-block-filter" class="rounded-md border-gray-300 shadow-sm"></select></div><div><label for="boleto-grade-filter" class="text-sm font-medium text-gray-700 mr-2">Grado:</label><select id="boleto-grade-filter" class="rounded-md border-gray-300 shadow-sm"></select></div><div><label for="boleto-group-filter" class="text-sm font-medium text-gray-700 mr-2">Grupo:</label><select id="boleto-group-filter" class="rounded-md border-gray-300 shadow-sm"></select></div><div><label for="boleto-subject-filter" class="text-sm font-medium text-gray-700 mr-2">Materia:</label><select id="boleto-subject-filter" class="rounded-md border-gray-300 shadow-sm"></select></div></div><div id="boletos-chart-container"><canvas id="boletosSalidaChart"></canvas></div><div id="boletos-no-data" class="text-center p-10 hidden"><i data-lucide="info" class="mx-auto h-12 w-12 text-gray-400"></i><h3 class="mt-2 text-sm font-medium text-gray-900">Sin datos</h3><p class="mt-1 text-sm text-gray-500">No hay resultados para la selección actual.</p></div></div></section>
                    <section id="expediente-estudiante" class="content-section hidden fade-in">
                        <h2 class="text-3xl font-bold mb-6 text-gray-800">Expediente del Estudiante</h2>
                        <div class="bg-white p-4 rounded-xl shadow-md mb-6"><div class="flex flex-wrap gap-4 items-center"><h3 class="font-bold text-lg text-gray-700">Buscar Estudiante:</h3><div><label for="expediente-grade-filter" class="text-sm font-medium text-gray-700 mr-2">Grado:</label><select id="expediente-grade-filter" class="rounded-md border-gray-300 shadow-sm"></select></div><div><label for="expediente-group-filter" class="text-sm font-medium text-gray-700 mr-2">Grupo:</label><select id="expediente-group-filter" class="rounded-md border-gray-300 shadow-sm"></select></div><div><label for="expediente-student-filter" class="text-sm font-medium text-gray-700 mr-2">Estudiante:</label><select id="expediente-student-filter" class="rounded-md border-gray-300 shadow-sm"></select></div></div></div>
                        <div id="expediente-placeholder" class="text-center p-10 bg-white rounded-xl shadow-md"><i data-lucide="search" class="mx-auto h-12 w-12 text-gray-400"></i><h3 class="mt-2 text-sm font-medium text-gray-900">Seleccione un estudiante</h3><p class="mt-1 text-sm text-gray-500">Elija grado, grupo y estudiante para ver su expediente.</p></div>
                        <div id="expediente-container" class="hidden space-y-6">
                            <div class="bg-white p-6 rounded-xl shadow-md">
                                <div class="flex justify-between items-center">
                                    <h3 id="expediente-nombre" class="text-2xl font-bold text-gray-800"></h3>
                                    <button id="download-pdf-button" class="bg-green-500 text-white px-4 py-2 rounded shadow hover:bg-green-600 flex items-center space-x-2 transition-colors">
                                        <i data-lucide="download" class="h-5 w-5"></i>
                                        <span>Generar PDF</span>
                                    </button>
                                </div>
                                <div class="mt-4 grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-y-4 gap-x-2 text-center items-center"><div><p class="text-sm font-medium text-gray-500">Grado y Grupo</p><p id="expediente-grupo" class="text-lg font-semibold text-gray-700"></p></div><div><p class="text-sm font-medium text-gray-500">Género</p><p id="expediente-genero" class="text-lg font-semibold text-gray-700"></p></div><div><p class="text-sm font-medium text-gray-500">Clave Escolar</p><p id="expediente-clave" class="text-lg font-semibold text-gray-700"></p></div><div><p class="text-sm font-medium text-gray-500">Estatus</p><p id="expediente-estatus" class="text-lg font-semibold text-gray-700"></p></div><div><p class="text-sm font-medium text-gray-500">Diagnóstico BAP</p><p id="expediente-bap" class="text-lg font-semibold text-gray-700"></p></div></div>
                                <hr class="my-4">
                                <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-y-4 gap-x-2 text-center"><div><p class="text-sm font-medium text-gray-500">Promedio General</p><p id="expediente-promedio" class="text-lg font-semibold text-gray-700"></p></div><div><p class="text-sm font-medium text-gray-500">Nivel de Logro</p><p id="expediente-nivel-logro" class="text-base font-bold px-2 py-1 rounded-md inline-block align-middle"></p></div></div>
                                <hr class="my-4">
                                <div id="expediente-filter-container" class="flex justify-end items-center mb-4">
                                    <label for="expediente-block-filter" class="text-sm font-medium text-gray-700 mr-2">Filtrar por Bloque:</label>
                                    <select id="expediente-block-filter" class="rounded-md border-gray-300 shadow-sm"></select>
                                </div>
                                <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-y-4 gap-x-2 text-center">
                                    <div id="expediente-prom-mat-container">
                                        <p class="text-sm font-medium text-gray-500">Prom. Matemáticas</p>
                                        <div class="flex items-center justify-center mt-1 space-x-2"><i data-lucide="function-square" class="h-6 w-6 text-yellow-500"></i><p id="expediente-prom-mat" class="text-lg font-semibold text-gray-700"></p></div>
                                        <p id="expediente-nivel-mat" class="text-xs font-bold px-2 py-0.5 rounded-md inline-block mt-1 align-middle"></p>
                                    </div>
                                    <div id="expediente-prom-esp-container">
                                        <p class="text-sm font-medium text-gray-500">Prom. Español</p>
                                        <div class="flex items-center justify-center mt-1 space-x-2"><i data-lucide="pilcrow" class="h-6 w-6 text-purple-500"></i><p id="expediente-prom-esp" class="text-lg font-semibold text-gray-700"></p></div>
                                        <p id="expediente-nivel-esp" class="text-xs font-bold px-2 py-0.5 rounded-md inline-block mt-1 align-middle"></p>
                                    </div>
                                    <div id="expediente-prom-cie-container">
                                        <p class="text-sm font-medium text-gray-500">Prom. Ciencias</p>
                                        <div class="flex items-center justify-center mt-1 space-x-2"><i data-lucide="flask-conical" class="h-6 w-6 text-green-500"></i><p id="expediente-prom-cie" class="text-lg font-semibold text-gray-700"></p></div>
                                        <p id="expediente-nivel-cie" class="text-xs font-bold px-2 py-0.5 rounded-md inline-block mt-1 align-middle"></p>
                                    </div>
                                    <div id="expediente-prom-ing-container">
                                        <p class="text-sm font-medium text-gray-500">Prom. Inglés</p>
                                        <div class="flex items-center justify-center mt-1 space-x-2"><i data-lucide="languages" class="h-6 w-6 text-blue-500"></i><p id="expediente-prom-ing" class="text-lg font-semibold text-gray-700"></p></div>
                                        <p id="expediente-nivel-ing" class="text-xs font-bold px-2 py-0.5 rounded-md inline-block mt-1 align-middle"></p>
                                    </div>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <div class="bg-white p-6 rounded-xl shadow-md"><h3 class="font-bold text-lg text-gray-700">Comparativa de Materias</h3><canvas id="expedienteRadarChart" class="mt-4"></canvas></div>
                                 <div class="bg-white p-6 rounded-xl shadow-md"><h3 class="font-bold text-lg text-gray-700">Evolución de Calificaciones por Bloque</h3><canvas id="expedienteCalificacionesChart" class="mt-4"></canvas></div>
                                <div class="bg-white p-6 rounded-xl shadow-md lg:col-span-2"><h3 class="font-bold text-lg text-gray-700">Historial de Asistencia Mensual</h3><canvas id="expedienteAsistenciaChart" class="mt-4"></canvas></div>
                            </div>
                        </div>
                    </section>
                    <section id="asistencia-padres" class="content-section hidden fade-in"><h2 class="text-3xl font-bold mb-6 text-gray-800">Escuela para Padres</h2><div class="bg-white p-6 rounded-xl shadow-md"><h3 class="font-bold text-lg text-gray-700">Asistencia Mensual a Juntas</h3><canvas id="asistenciaPadresChart" class="mt-4"></canvas></div></section>
                </div>
            </main>
        </div>
    </div>

    <script>
        const CLIENT_ID = 'TU_CLIENT_ID.apps.googleusercontent.com'; // <-- REEMPLAZA ESTO
        
        // ==== CAMBIO 1: Añade tus IDs y Clave de API aquí ====
        const MASTER_SHEET_ID = 'TU_MASTER_SHEET_ID'; // <-- REEMPLAZA ESTO
        const API_KEY = 'TU_API_KEY';                 // <-- REEMPLAZA ESTO
        // =======================================================
        
        let SELECTED_SPREADSHEET_ID = null;
        const SCOPES = 'https://www.googleapis.com/auth/spreadsheets.readonly https://www.googleapis.com/auth/userinfo.email';
        
        const SHEET_RANGES = {
            permisos: 'Permisos!A:Z', 
            alumnos: 'Alumnos!A:Z',
            calificaciones: 'Calificaciones!A:Z',
            asistencia: 'Asistencia!A:Z',
            boletos: 'Boletos!A:Z',
            docentes: 'Docentes!A:Z',
            asistenciaPadres: 'AsistenciaPadres!A:Z',
            matricula: 'Matricula!A:Z'
        };
        const MESES_MAP = ["", "Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
        const SCHOOL_YEAR_MONTH_ORDER = ["Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre", "Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio"];
        
        let tokenClient;
        let gapiInited = false, gisInited = false;
        
        document.getElementById('login-button').onclick = handleAuthClick;
        document.getElementById('signout_button').onclick = handleSignoutClick;

        function gapiLoaded() { gapi.load('client', initializeGapiClient); }
        function gisLoaded() { tokenClient = google.accounts.oauth2.initTokenClient({ client_id: CLIENT_ID, scope: SCOPES, callback: '', }); gisInited = true; maybeEnableButtons(); }
        
        async function initializeGapiClient() {
            await gapi.client.init({
                apiKey: API_KEY,
                discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4'],
            });
            gapiInited = true;
            maybeEnableButtons();
        }
        
        async function loadSchoolList() {
            try {
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: MASTER_SHEET_ID,
                    range: 'Escuelas!A2:C', // <-- CAMBIO JS: Leer hasta la columna C del logo
                });
                
                const schoolSelector = document.getElementById('school-selector');
                const loginButton = document.getElementById('login-button');
                
                schoolSelector.innerHTML = '<option value="">-- Por favor, selecciona --</option>';
                const schools = response.result.values || [];
                
                if (schools.length > 0) {
                    schools.forEach(school => {
                        const schoolName = school[0];
                        const spreadsheetId = school[1];
                        const logoUrl = school[2]; // <-- CAMBIO JS: Obtener la URL del logo
                        if (schoolName && spreadsheetId) {
                            const option = document.createElement('option');
                            option.value = spreadsheetId;
                            option.textContent = schoolName;
                            // Guardamos la URL en el propio elemento para usarla después
                            if (logoUrl) {
                                option.dataset.logoUrl = logoUrl; // <-- CAMBIO JS: Guardar la URL
                            }
                            schoolSelector.appendChild(option);
                        }
                    });
                    schoolSelector.disabled = false;
                    
                    loginButton.disabled = true;
                    loginButton.classList.add('opacity-50', 'cursor-not-allowed');

                    schoolSelector.addEventListener('change', () => {
                        if (schoolSelector.value) {
                            loginButton.disabled = false;
                            loginButton.classList.remove('opacity-50', 'cursor-not-allowed');
                        } else {
                            loginButton.disabled = true;
                            loginButton.classList.add('opacity-50', 'cursor-not-allowed');
                        }
                    });

                } else {
                    schoolSelector.innerHTML = '<option>No se encontraron escuelas</option>';
                }

            } catch (error) {
                console.error("Error al cargar la lista de escuelas:", error);
                document.getElementById('school-selector').innerHTML = '<option>Error al cargar</option>';
                alert("No se pudo cargar la lista de escuelas. Revisa que el ID de la Hoja Maestra y la Clave de API sean correctos y que la hoja sea pública.");
            }
        }
        
        function maybeEnableButtons() { 
            if (gapiInited && gisInited) { 
                loadSchoolList();
                lucide.createIcons();
            } 
        }

        function handleAuthClick() {
            const schoolSelector = document.getElementById('school-selector');
            // Obtenemos la opción seleccionada para acceder a su URL de logo
            const selectedOption = schoolSelector.options[schoolSelector.selectedIndex];
            const logoUrl = selectedOption.dataset.logoUrl; // <-- CAMBIO JS: Obtener la URL guardada

            SELECTED_SPREADSHEET_ID = schoolSelector.value;

            if (!SELECTED_SPREADSHEET_ID) {
                alert('Por favor, selecciona una escuela antes de iniciar sesión.');
                return;
            }

            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                    alert("Error de autenticación. Por favor, intenta de nuevo.");
                    console.error(resp);
                    return;
                }

                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app-wrapper').classList.remove('hidden');
                document.getElementById('signout_button').classList.remove('hidden');
                
                // ==== CAMBIO JS: AÑADIR ESTE BLOQUE PARA MOSTRAR EL LOGO ====
                const sidebarLogo = document.getElementById('school-logo-sidebar');
                const defaultIcon = document.getElementById('default-icon');

                if (logoUrl && sidebarLogo) {
                    sidebarLogo.src = logoUrl;
                    sidebarLogo.classList.remove('hidden');
                    if (defaultIcon) defaultIcon.classList.add('hidden');
                } else {
                    if (sidebarLogo) sidebarLogo.classList.add('hidden');
                    if (defaultIcon) defaultIcon.classList.remove('hidden');
                }
                // ========================================================

                const userInfoResponse = await fetch('https://www.googleapis.com/oauth2/v3/userinfo', {
                    headers: { 'Authorization': `Bearer ${gapi.client.getToken().access_token}` }
                });
                const userInfo = await userInfoResponse.json();
                
                const userInfoEl = document.getElementById('user-info');
                userInfoEl.textContent = userInfo.email;
                userInfoEl.classList.remove('hidden');

                await loadAndProcessData(userInfo.email);
            };

            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({ prompt: 'consent' });
            } else {
                tokenClient.requestAccessToken({ prompt: '' });
            }
        }

        function handleSignoutClick() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken('');
                
                // ==== CAMBIO JS: AÑADIR ESTE BLOQUE PARA RESTABLECER EL LOGO ====
                const sidebarLogo = document.getElementById('school-logo-sidebar');
                const defaultIcon = document.getElementById('default-icon');
                if (sidebarLogo) {
                    sidebarLogo.src = '';
                    sidebarLogo.classList.add('hidden');
                }
                if (defaultIcon) {
                    defaultIcon.classList.remove('hidden');
                }
                // ==========================================================
                
                document.getElementById('app-wrapper').classList.add('hidden');
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('main-container').classList.add('hidden');
                document.getElementById('unauthorized-message').classList.add('hidden');
                document.getElementById('loading-indicator').classList.add('hidden');
                document.getElementById('signout_button').classList.add('hidden');
                document.getElementById('user-info').classList.add('hidden');
                document.querySelectorAll('.nav-link').forEach(link => link.style.display = 'none');

                SELECTED_SPREADSHEET_ID = null;
                const schoolSelector = document.getElementById('school-selector');
                if(schoolSelector) {
                    schoolSelector.selectedIndex = 0;
                }
                const loginButton = document.getElementById('login-button');
                if(loginButton) {
                     loginButton.disabled = true;
                     loginButton.classList.add('opacity-50', 'cursor-not-allowed');
                }
            }
        }

        function sheetsArrayToJson(dataArray) { if (!dataArray || dataArray.length < 2) return []; const headers = dataArray[0]; const jsonData = []; for (let i = 1; i < dataArray.length; i++) { const row = dataArray[i]; if (row.length === 0 || row.every(cell => cell.trim() === '')) continue; const obj = {}; for (let j = 0; j < headers.length; j++) { obj[headers[j]] = row[j]; } jsonData.push(obj); } return jsonData; }
        
        async function loadAndProcessData(userEmail) {
            const loadingIndicator = document.getElementById('loading-indicator');
            const unauthorizedMessage = document.getElementById('unauthorized-message');
            
            loadingIndicator.classList.remove('hidden');
            document.getElementById('main-container').classList.add('hidden');
            unauthorizedMessage.classList.add('hidden');

            try {
                const response = await gapi.client.sheets.spreadsheets.values.batchGet({
                    spreadsheetId: SELECTED_SPREADSHEET_ID,
                    ranges: Object.values(SHEET_RANGES),
                });

                const jsonData = {};
                Object.keys(SHEET_RANGES).forEach((key, index) => {
                    jsonData[key] = sheetsArrayToJson(response.result.valueRanges[index]?.values || []);
                });
                
                const permissionsList = jsonData.permisos || [];
                let userPermissions = permissionsList.find(p => p.Email && p.Email.toLowerCase() === userEmail.toLowerCase());

                if (!userPermissions) {
                    loadingIndicator.classList.add('hidden');
                    unauthorizedMessage.classList.remove('hidden');
                    console.warn(`Usuario ${userEmail} no encontrado en la hoja de Permisos.`);
                    handleSignoutClick(); 
                    alert('Acceso Denegado. Tu cuenta no tiene permisos para ver este tablero.');
                    return;
                }

                const data = (jsonData.alumnos.length === 0) ? getDemoData() : processRealData(jsonData);
                
                main(data, userPermissions);

                loadingIndicator.classList.add('hidden');
                document.getElementById('main-container').classList.remove('hidden');

            } catch (error) {
                console.error("Error al cargar datos o permisos desde la API:", error);
                loadingIndicator.innerHTML = `<i data-lucide="alert-triangle" class="mx-auto h-12 w-12 text-red-500"></i><h3 class="mt-2 text-sm font-medium text-gray-900">Error al cargar datos</h3><p class="mt-1 text-sm text-gray-500">No se pudo obtener la información. Revisa que la hoja de cálculo de la escuela sea correcta y que tengas permiso para verla.<br>(Más detalles en la consola)</p>`;
                lucide.createIcons();
            }
        }
        
        function processRealData(jsonData) {
            const data = { resumenGeneral: {}, resumenMensual: [], resumenPorBloque: [], estudiantes: {}, docentes: {}, asistenciaPadres: {} };
            const validAlumnos = jsonData.alumnos.filter(a => a.id && a.clave_escolar && a.nombre && a.nombre.trim() !== '');
            const validStudentKeys = new Set(validAlumnos.map(a => a.clave_escolar));
            const validCalificaciones = jsonData.calificaciones.filter(c => validStudentKeys.has(c.clave_escolar));
            const validAsistencia = jsonData.asistencia.filter(a => validStudentKeys.has(a.clave_escolar));
            const validBoletos = jsonData.boletos.filter(b => validStudentKeys.has(b.clave_escolar));
            data.listaEstudiantes = validAlumnos.map(alumno => {
                const clave = alumno.clave_escolar, id = alumno.id, calificaciones = {}, asistencia = {}, boletos = {};
                validCalificaciones.filter(c => c.clave_escolar === clave).forEach(c => { if (c.calificacion && c.bloque && c.materia) { const grade = parseFloat(String(c.calificacion).replace(',', '.')); if (!isNaN(grade)) { const subjectKey = c.materia.toLowerCase().substring(0, 1); if (!calificaciones[c.bloque]) calificaciones[c.bloque] = {}; calificaciones[c.bloque][subjectKey] = grade; } } });
                const studentAttendanceRecord = validAsistencia.find(row => row.clave_escolar === clave);
                if (studentAttendanceRecord) { for (const monthName in studentAttendanceRecord) { if (monthName.toLowerCase() !== 'clave_escolar' && studentAttendanceRecord[monthName]) { const monthNumber = MESES_MAP.findIndex(m => m.toLowerCase() === monthName.toLowerCase()); if (monthNumber > 0) { const percentage = parseFloat(String(studentAttendanceRecord[monthName]).replace('%', '')); if (!isNaN(percentage)) { asistencia[monthNumber] = percentage; } } } } }
                validBoletos.filter(b => b.clave_escolar === clave).forEach(b => { if (b.bloque && b.materia && b.fecha && b.calificacion) { if (!boletos[b.bloque]) boletos[b.bloque] = {}; if (!boletos[b.bloque][b.materia]) boletos[b.bloque][b.materia] = []; boletos[b.bloque][b.materia].push({ date: b.fecha, score: parseInt(b.calificacion) }); } });
                return { id, clave_escolar: clave, nombre: alumno.nombre, genero: alumno.genero, grado: alumno.grado, grupo: alumno.grupo, status: (String(alumno.status).toLowerCase() === 'baja') ? 'baja' : 'activo', motivoBaja: alumno.motivoBaja, bap: (String(alumno.bap).toLowerCase() === 'true') ? 'Sí' : 'No', calificaciones, asistencia, boletos };
            });
            const subjects = [...new Set(validCalificaciones.map(c => c.materia))], blocks = [...new Set(validCalificaciones.map(c => c.bloque))].sort(), subjectKeyMap = { "Matemáticas": "matematicas", "Español": "espanol", "Ciencias": "ciencias", "Inglés": "ingles" };
            data.calificaciones = { bloques: blocks };
            subjects.forEach(subject => { const subjectKey = subjectKeyMap[subject]; if (!subjectKey) return; data.calificaciones[subjectKey] = []; blocks.forEach(block => { const gradesForBlock = validCalificaciones.filter(c => c.bloque === block && c.materia === subject).map(c => parseFloat(String(c.calificacion).replace(',', '.'))).filter(g => !isNaN(g)); data.calificaciones[subjectKey].push(gradesForBlock.length > 0 ? gradesForBlock.reduce((a, b) => a + b, 0) / gradesForBlock.length : 0); }); });
            if (jsonData.matricula && jsonData.matricula.length > 0) {
                data.resumenMensual = jsonData.matricula.map(m => { const monthName = MESES_MAP[parseInt(m.mes)] || m.mes; const monthNumber = MESES_MAP.indexOf(monthName); let monthlyAttendanceTotal = 0; let studentCountForMonth = 0; if (monthNumber > 0) { data.listaEstudiantes.forEach(student => { if (student.asistencia && student.asistencia[monthNumber] !== undefined) { monthlyAttendanceTotal += student.asistencia[monthNumber]; studentCountForMonth++; } }); } const avgMonthlyAttendance = studentCountForMonth > 0 ? monthlyAttendanceTotal / studentCountForMonth : 0; return { periodo: monthName, matricula: parseInt(m.matricula) || 0, asistencia: avgMonthlyAttendance }; }).sort((a, b) => (SCHOOL_YEAR_MONTH_ORDER.indexOf(a.periodo) - SCHOOL_YEAR_MONTH_ORDER.indexOf(b.periodo)));
                data.resumenGeneral.matricula = data.resumenMensual[data.resumenMensual.length - 1]?.matricula || 0; data.estudiantes.meses = data.resumenMensual.map(m => m.periodo); data.estudiantes.matricula = data.resumenMensual.map(m => m.matricula);
            } else { data.resumenGeneral.matricula = data.listaEstudiantes.filter(s => s.status === 'activo').length; data.estudiantes.meses = []; data.estudiantes.matricula = []; }
            data.resumenPorBloque = blocks.map(block => { const blockSummary = { bloque: block }; subjects.forEach(subject => { const subjectKey = `prom_${subjectKeyMap[subject]}`; if (subjectKey && !subjectKey.endsWith('undefined')) { const gradesInBlock = validCalificaciones.filter(c => c.bloque === block && c.materia === subject).map(c => parseFloat(String(c.calificacion).replace(',', '.'))).filter(g => !isNaN(g)); blockSummary[subjectKey] = gradesInBlock.length > 0 ? gradesInBlock.reduce((a, b) => a + b, 0) / gradesInBlock.length : 0; } }); return blockSummary; });
            data.resumenGeneral.bajas = data.listaEstudiantes.filter(s => s.status === 'baja').length; data.resumenGeneral.alumnosBAP = data.listaEstudiantes.filter(s => s.bap === 'Sí' && s.status === 'activo').length;
            subjects.forEach(subject => { const subjectKey = `prom_${subjectKeyMap[subject]}`; const allGrades = validCalificaciones.filter(c => c.materia === subject).map(c => parseFloat(String(c.calificacion).replace(',', '.'))).filter(g => !isNaN(g)); data.resumenGeneral[subjectKey] = allGrades.length > 0 ? allGrades.reduce((a, b) => a + b, 0) / allGrades.length : 0; });
            const allAttendancePercentages = []; validAsistencia.forEach(row => { Object.keys(row).forEach(key => { if (key.toLowerCase() !== 'clave_escolar') { const percentage = parseFloat(String(row[key]).replace('%', '')); if (!isNaN(percentage)) { allAttendancePercentages.push(percentage); } } }); });
            data.resumenGeneral.asistencia = allAttendancePercentages.length > 0 ? allAttendancePercentages.reduce((a, b) => a + b, 0) / allAttendancePercentages.length : 0;
            if(jsonData.docentes && jsonData.docentes.length > 0) { data.docentes = { altas: jsonData.docentes.map(d => parseInt(d.altas) || 0), bajas: jsonData.docentes.map(d => parseInt(d.bajas) || 0), meses: jsonData.docentes.map(d => MESES_MAP[parseInt(d.mes)] || d.mes) }; data.resumenGeneral.docentes = jsonData.docentes.length; } else { data.docentes = {altas: [], bajas: [], meses: []}; data.resumenGeneral.docentes = 0; }
            if(jsonData.asistenciaPadres && jsonData.asistenciaPadres.length > 0){ data.asistenciaPadres = { asistencia: jsonData.asistenciaPadres.map(d => parseInt(d.porcentaje_asistencia) || 0), meses: jsonData.asistenciaPadres.map(d => MESES_MAP[parseInt(d.mes)] || d.mes) }; const avgParentAttendance = data.asistenciaPadres.asistencia.length > 0 ? data.asistenciaPadres.asistencia.reduce((s, c) => s + c, 0) / data.asistenciaPadres.asistencia.length : 0; data.resumenGeneral.prom_asistencia_padres = avgParentAttendance || 0; } else { data.asistenciaPadres = {asistencia: [], meses: []}; data.resumenGeneral.prom_asistencia_padres = 0; }
            return data;
        }

        // Resto del código JavaScript (funciones main, getDemoData, etc.)
        // Este código es largo, por lo que se omite por brevedad, pero
        // debe ser el mismo que tenías en tu archivo original.
        // Asegúrate de pegar desde la función 'main' en adelante aquí.
        function main(data, permissions) {
            const nav = document.getElementById('main-nav');
            const navLinks = nav.querySelectorAll('.nav-link');
            let firstVisibleLink = null;
            const permissionMap = { 'resumen': 'Resumen', 'estudiantes': 'Estudiantes', 'docentes': 'Docentes', 'calificaciones': 'Calificaciones', 'calificaciones-grado': 'Calificaciones por Grado', 'boletos-salida': 'Boletos de Salida', 'expediente-estudiante': 'Expediente Estudiante', 'asistencia-padres': 'Escuela para Padres' };
            navLinks.forEach(link => { const sectionName = link.getAttribute('href').substring(1); const permissionKey = permissionMap[sectionName]; if (permissions[permissionKey] === 'TRUE') { link.style.display = 'block'; if (!firstVisibleLink) { firstVisibleLink = link; } } else { link.style.display = 'none'; const sectionElement = document.getElementById(sectionName); if (sectionElement) { sectionElement.remove(); } } });
            if (permissions[permissionMap['estudiantes']] !== 'TRUE') { const cardBajas = document.getElementById('card-bajas'); if (cardBajas) cardBajas.style.display = 'none'; }
            if (permissions[permissionMap['docentes']] !== 'TRUE') { const cardDocentes = document.getElementById('card-docentes'); if (cardDocentes) cardDocentes.style.display = 'none'; }
            if (permissions[permissionMap['asistencia-padres']] !== 'TRUE') { const cardPadres = document.getElementById('card-padres'); if (cardPadres) cardPadres.style.display = 'none'; }
            navLinks.forEach(link => link.classList.remove('active-link'));
            if (firstVisibleLink) { firstVisibleLink.classList.add('active-link'); const firstVisibleSection = document.getElementById(firstVisibleLink.getAttribute('href').substring(1)); document.querySelectorAll('.content-section').forEach(s => s.classList.add('hidden')); if (firstVisibleSection) { firstVisibleSection.classList.remove('hidden'); } }
            Chart.register(ChartDataLabels);
            function getNivelDeLogro(promedio) { if (promedio > 9.5) return { nivel: 'Sobresaliente', color: 'bg-[#c0e6af] text-green-900' }; if (promedio >= 8.0) return { nivel: 'Buen desempeño', color: 'bg-[#ffe599] text-amber-800' }; if (promedio >= 7.0) return { nivel: 'Desempeño medio', color: 'bg-[#f9cb9c] text-orange-900' }; if (promedio >= 6.0) return { nivel: 'Bajo desempeño', color: 'bg-[#e06666] text-white' }; return { nivel: 'Foco Rojo', color: 'bg-[#990000] text-white' }; }
            const getEl = (id) => document.getElementById(id);
            const summaryMatricula = getEl('summary-matricula'), summaryBap = getEl('summary-bap'), summaryAsistencia = getEl('summary-asistencia'), summaryBajas = getEl('summary-bajas'), summaryDocentes = getEl('summary-docentes'), summaryMatematicas = getEl('summary-matematicas'), summaryEspanol = getEl('summary-espanol'), summaryCiencias = getEl('summary-ciencias'), summaryIngles = getEl('summary-ingles'), summaryPadres = getEl('summary-padres'), periodFilter = getEl('period-filter'), gradeFilter = getEl('grade-filter'), groupFilter = getEl('group-filter'), blockFilter = getEl('block-filter'), genderFilterCal = getEl('gender-filter-cal'), studentCountGrades = getEl('student-count-grades'), studentGradeFilter = getEl('student-grade-filter'), studentGroupFilter = getEl('student-group-filter'), studentGenderFilter = getEl('student-gender-filter'), studentBapFilter = getEl('student-bap-filter'), studentCountStats = getEl('student-count-stats'), asistenciaChartTitle = getEl('asistencia-chart-title'), boletoBlockFilter = getEl('boleto-block-filter'), boletoGradeFilter = getEl('boleto-grade-filter'), boletoGroupFilter = getEl('boleto-group-filter'), boletoSubjectFilter = getEl('boleto-subject-filter'), boletosChartContainer = getEl('boletos-chart-container'), boletosNoData = getEl('boletos-no-data'), expedienteGradeFilter = getEl('expediente-grade-filter'), expedienteGroupFilter = getEl('expediente-group-filter'), expedienteStudentFilter = getEl('expediente-student-filter'), expedienteContainer = getEl('expediente-container'), expedientePlaceholder = getEl('expediente-placeholder');
            let matriculaChartInstance, asistenciaChartInstance, calificacionesGradoChart, nivelLogroChartInstance, boletosSalidaChartInstance, expedienteAsistenciaChartInstance, expedienteCalificacionesChartInstance, expedienteRadarChartInstance;
            const datalabelConfig = { anchor: 'end', align: 'top', formatter: (value) => value ? parseFloat(value).toFixed(1) : '', color: '#555', font: { weight: 'bold' } };
            function manageVisibility() { const subjects = { matematicas: "Matemáticas", espanol: "Español", ciencias: "Ciencias", ingles: "Inglés" }; Object.entries(subjects).forEach(([key, name]) => { const hasData = data.calificaciones[key] && data.calificaciones[key].length > 0 && data.calificaciones[key].some(v => v > 0); const summaryCard = getEl(`summary-${key}-card`); const chartContainer = getEl(`calificaciones${name.replace('á','a').replace('ñ','n')}-container`); const expPromContainer = getEl(`expediente-prom-${key.substring(0,3)}-container`); if (summaryCard) summaryCard.style.display = hasData ? 'flex' : 'none'; if (chartContainer) chartContainer.style.display = hasData ? 'block' : 'none'; if (expPromContainer) expPromContainer.style.display = hasData ? 'block' : 'none'; }); }
            function populateFilter() { periodFilter.innerHTML = '<option value="General">General</option>'; const a = document.createElement("optgroup"); a.label = "Meses", (data.resumenMensual || []).forEach(b => { const c = document.createElement("option"); c.value = b.periodo, c.textContent = b.periodo, a.appendChild(c) }), periodFilter.appendChild(a); const b = document.createElement("optgroup"); b.label = "Bloques", (data.resumenPorBloque || []).forEach(a => { const c = document.createElement("option"); c.value = a.bloque, c.textContent = a.bloque, b.appendChild(c) }), periodFilter.appendChild(b); }
            function updateSummary(selectedPeriod) { const isGeneral = (!selectedPeriod || selectedPeriod === 'General'); let periodData = isGeneral ? data.resumenGeneral : (data.resumenMensual || []).find(item => item.periodo === selectedPeriod) || (data.resumenPorBloque || []).find(item => item.bloque === selectedPeriod); if (!periodData) { periodData = {}; } const fallbackAsistencia = isGeneral ? (data.resumenGeneral.asistencia || 0) : 0; summaryAsistencia.textContent = `${(periodData.asistencia || fallbackAsistencia).toFixed(1)}%`; summaryMatricula.textContent = periodData.matricula || (isGeneral ? data.resumenGeneral.matricula : 0) || 0; summaryBap.textContent = periodData.alumnosBAP || (isGeneral ? data.resumenGeneral.alumnosBAP : 0) || 0; summaryBajas.textContent = periodData.bajas || (isGeneral ? data.resumenGeneral.bajas : 0) || 0; summaryDocentes.textContent = periodData.docentes || (isGeneral ? data.resumenGeneral.docentes : 0) || 0; summaryPadres.textContent = `${((periodData.prom_asistencia_padres || (isGeneral ? data.resumenGeneral.prom_asistencia_padres : 0)) || 0).toFixed(1)}%`; summaryMatematicas.textContent = (periodData.prom_matematicas || 0).toFixed(1); summaryEspanol.textContent = (periodData.prom_espanol || 0).toFixed(1); summaryCiencias.textContent = (periodData.prom_ciencias || 0).toFixed(1); summaryIngles.textContent = (periodData.prom_ingles || 0).toFixed(1); }
            const allNavLinks = document.querySelectorAll('.nav-link'), allContentSections = document.querySelectorAll('.content-section'), sidebar = getEl("sidebar"), menuButton = getEl("menu-button"); allNavLinks.forEach(a => { a.addEventListener("click", b => { b.preventDefault(); const c = a.getAttribute("href").substring(1); allContentSections.forEach(s => s.classList.add("hidden")); const sectionEl = getEl(c); if(sectionEl) sectionEl.classList.remove("hidden"); allNavLinks.forEach(link => link.classList.remove("active-link", "bg-gray-700")); a.classList.add("active-link", "bg-gray-700"); window.innerWidth < 768 && sidebar.classList.add("-translate-x-full") }) }), menuButton.addEventListener("click", () => sidebar.classList.toggle("-translate-x-full"));
            function createGeneralCharts(){ if(getEl("docentesChart")) {new Chart(getEl("docentesChart"),{type:"bar",data:{labels:data.docentes.meses,datasets:[{label:"Altas",data:data.docentes.altas,backgroundColor:"rgba(59, 130, 246, 0.7)"},{label:"Bajas",data:data.docentes.bajas,backgroundColor:"rgba(239, 68, 68, 0.7)"}]},options:{responsive:!0,scales:{y:{beginAtZero:!0,ticks:{stepSize:1}}}}});} const createBarChart = (elementId, label, color) => { const canvas = getEl(elementId); if(!canvas) return; if(canvas.chart) canvas.chart.destroy(); const subjectKey = label.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace('ñ','n'); new Chart(canvas, { type: "bar", data: { labels: data.calificaciones.bloques, datasets: [{ label: `Promedio ${label}`, data: data.calificaciones[subjectKey], backgroundColor: `rgba(${color}, 0.7)` }] }, options: { responsive: true, scales: { y: { beginAtZero: false, min: 5, max: 10.5 } }, plugins: { legend: { display: false }, datalabels: datalabelConfig } } }); }; createBarChart("calificacionesMatematicasChart","Matemáticas","234, 179, 8"); createBarChart("calificacionesEspanolChart","Español","139, 92, 246"); createBarChart("calificacionesCienciasChart","Ciencias","22, 163, 74"); createBarChart("calificacionesInglesChart","Inglés","37, 99, 235"); const setupNivelLogroGeneral = (subjectKey, elementId) => { const promedioGeneral = data.resumenGeneral[`prom_${subjectKey}`]; const nivelElement = getEl(elementId); if (nivelElement && promedioGeneral !== undefined && promedioGeneral > 0) { const { nivel, color } = getNivelDeLogro(promedioGeneral); nivelElement.textContent = nivel; nivelElement.className = `text-sm font-bold px-2 py-1 rounded-md ${color}`; } else if (nivelElement) { nivelElement.textContent = 'N/A'; nivelElement.className = 'text-sm font-bold px-2 py-1 rounded-md bg-gray-100 text-gray-800'; } }; setupNivelLogroGeneral("matematicas", "nivel-logro-matematicas"); setupNivelLogroGeneral("espanol", "nivel-logro-espanol"); setupNivelLogroGeneral("ciencias", "nivel-logro-ciencias"); setupNivelLogroGeneral("ingles", "nivel-logro-ingles"); }
            function createStudentCharts() { if (getEl("matriculaChart")){if (matriculaChartInstance) matriculaChartInstance.destroy(); matriculaChartInstance = new Chart(getEl("matriculaChart"), { type: "line", data: { labels: data.estudiantes.meses, datasets: [{ label: 'Matrícula Mensual', data: data.estudiantes.matricula, borderColor: 'rgba(54, 162, 235, 1)', backgroundColor: 'rgba(54, 162, 235, 0.2)', fill: true, tension: 0.1 }] }, options: { responsive: true, plugins: { datalabels: { ...datalabelConfig, align: 'bottom' } } } });} if(getEl("asistenciaChart")) {if (asistenciaChartInstance) asistenciaChartInstance.destroy(); asistenciaChartInstance = new Chart(getEl("asistenciaChart"), { type: "bar", options: { responsive: !0, scales: { y: { beginAtZero: !1, min: 80, max: 100 } } } });} }
            function updateStudentCharts() { if (!getEl("asistenciaChart")) return; const a = studentGradeFilter.value, b = studentGroupFilter.value, c = studentGenderFilter.value, d = studentBapFilter.value; let e = data.listaEstudiantes; "Todos" !== a && (e = e.filter(b => b.grado === a)); "Todos" !== b && (e = e.filter(a => a.grupo === b)); "Todos" !== c && (e = e.filter(a => a.genero === c)); "Todos" !== d && (e = e.filter(a => a.bap === d)); studentCountStats.textContent = e.length; let h = "Análisis de Asistencia Mensual"; "Todos" !== b ? h = `Promedio del Grupo ${a} ${b}` : "Todos" !== a && (h = `Promedio del Grado ${a}`); asistenciaChartTitle.textContent = h; const j = SCHOOL_YEAR_MONTH_ORDER.map(monthName => { const monthNumber = MESES_MAP.indexOf(monthName); if(monthNumber === -1) return 0; let total = 0, count = 0; e.forEach(student => { if (student.asistencia[monthNumber] !== undefined) { total += student.asistencia[monthNumber]; count++; } }); return count > 0 ? (total / count).toFixed(1) : 0; }); asistenciaChartInstance.data.labels = SCHOOL_YEAR_MONTH_ORDER; asistenciaChartInstance.data.datasets = [{ label: "% de Asistencia", data: j, backgroundColor: "rgba(22, 163, 74, 0.6)", borderColor: "rgba(22, 163, 74, 1)", borderWidth: 1 }]; asistenciaChartInstance.update(); }
            function setupStudentFilters() { if (!studentGradeFilter) return; const grados = [...new Set(data.listaEstudiantes.map(a => a.grado))].sort((x, y) => x.localeCompare(y, undefined, { numeric: true })); studentGradeFilter.innerHTML = '<option value="Todos">Todos</option>'; grados.forEach(grado => { studentGradeFilter.innerHTML += `<option value="${grado}">${grado}</option>`; }); studentGroupFilter.innerHTML = '<option value="Todos">Todos</option>'; studentGradeFilter.addEventListener("change", () => { const selectedGrade = studentGradeFilter.value; studentGroupFilter.innerHTML = '<option value="Todos">Todos</option>'; if (selectedGrade !== "Todos") { studentGroupFilter.disabled = false; const grupos = [...new Set(data.listaEstudiantes.filter(b => b.grado === selectedGrade).map(a => a.grupo))].sort(); grupos.forEach(grupo => { studentGroupFilter.innerHTML += `<option value="${grupo}">${grupo}</option>`; }); } else { studentGroupFilter.disabled = true; } updateStudentCharts(); }); studentGroupFilter.addEventListener("change", updateStudentCharts); studentGenderFilter.addEventListener("change", updateStudentCharts); studentBapFilter.addEventListener("change", updateStudentCharts); studentGroupFilter.disabled = true; }
            function populateGradeFilter() { if (!gradeFilter) return; const grados = [...new Set(data.listaEstudiantes.map(a => a.grado))].sort((x, y) => x.localeCompare(y, undefined, { numeric: true })); gradeFilter.innerHTML = '<option value="Todos">Todos</option>'; grados.forEach(grado => { gradeFilter.innerHTML += `<option value="${grado}">${grado}</option>` }); }
            function populateGroupFilter(grado) { if (!groupFilter) return; groupFilter.innerHTML = '<option value="Todos">Todos</option>'; const grupos = [...new Set(data.listaEstudiantes.filter(b => b.grado === grado).map(a => a.grupo))].sort(); grupos.forEach(grupo => { groupFilter.innerHTML += `<option value="${grupo}">${grupo}</option>` }); }
            function populateBlockFilter(){if (!blockFilter) return; blockFilter.innerHTML='<option value="General">General</option>',data.calificaciones.bloques.forEach(a=>{const b=document.createElement("option");b.value=a,b.textContent=a,blockFilter.appendChild(b)})}
            function updateCalificacionesGradoCharts(grade, group, block, gender){ if (!getEl("calificacionesGradoChart")) return; updateCalificacionesGradoBarChart(grade, group, block, gender); updateNivelLogroChart(grade, group, block, gender); }
            function updateNivelLogroChart(grade, group, block, gender) { let filteredStudents; if (grade === 'Todos') { filteredStudents = data.listaEstudiantes.filter(s => s.status === 'activo'); } else { filteredStudents = data.listaEstudiantes.filter(s => s.grado === grade && s.status === 'activo'); } if (group !== 'Todos') { filteredStudents = filteredStudents.filter(s => s.grupo === group); } if (gender !== 'Todos') { filteredStudents = filteredStudents.filter(s => s.genero === gender); } studentCountGrades.textContent = filteredStudents.length; const levelsBySubject = { m: { "Sobresaliente": 0, "Buen desempeño": 0, "Desempeño medio": 0, "Bajo desempeño": 0, "Foco Rojo": 0 }, e: { "Sobresaliente": 0, "Buen desempeño": 0, "Desempeño medio": 0, "Bajo desempeño": 0, "Foco Rojo": 0 }, c: { "Sobresaliente": 0, "Buen desempeño": 0, "Desempeño medio": 0, "Bajo desempeño": 0, "Foco Rojo": 0 }, i: { "Sobresaliente": 0, "Buen desempeño": 0, "Desempeño medio": 0, "Bajo desempeño": 0, "Foco Rojo": 0 }}; const subjectNames = { m: "Matemáticas", e: "Español", c: "Ciencias", i: "Inglés" }; filteredStudents.forEach(student => { if (student.calificaciones) { if (block === 'General') { const studentAverages = { m: [], e: [], c: [], i: [] }; for (const blockName in student.calificaciones) { const blockGrades = student.calificaciones[blockName]; Object.keys(blockGrades).forEach(subjectKey => { if (studentAverages[subjectKey]) { studentAverages[subjectKey].push(blockGrades[subjectKey]); } }); } Object.keys(studentAverages).forEach(subjectKey => { if (studentAverages[subjectKey].length > 0) { const avg = studentAverages[subjectKey].reduce((a, b) => a + b, 0) / studentAverages[subjectKey].length; const level = getNivelDeLogro(avg).nivel; if(levelsBySubject[subjectKey]) levelsBySubject[subjectKey][level]++; } }); } else { const blockGrades = student.calificaciones[block]; if (blockGrades) { Object.keys(blockGrades).forEach(subjectKey => { const gradeValue = blockGrades[subjectKey]; if (gradeValue !== undefined && !isNaN(parseFloat(gradeValue)) && levelsBySubject[subjectKey]) { levelsBySubject[subjectKey][getNivelDeLogro(gradeValue).nivel]++; } }); } } } }); 
                const levelOrder = ["Sobresaliente", "Buen desempeño", "Desempeño medio", "Bajo desempeño", "Foco Rojo"];
                const levelColors = ["#c0e6af", "#ffe599", "#f9cb9c", "#e06666", "#990000"];
                const chartLabels = Object.keys(subjectNames).filter(key => data.calificaciones[key.replace('m','matematicas').replace('e','espanol').replace('c','ciencias').replace('i','ingles')]).map(key => subjectNames[key]); const datasets = levelOrder.map((level, index) => ({ label: level, data: Object.keys(subjectNames).filter(key => data.calificaciones[key.replace('m','matematicas').replace('e','espanol').replace('c','ciencias').replace('i','ingles')]).map(key => levelsBySubject[key][level]), backgroundColor: levelColors[index] })); if (nivelLogroChartInstance) nivelLogroChartInstance.destroy(); nivelLogroChartInstance = new Chart(getEl("nivelLogroChart"), { type: "bar", data: { labels: chartLabels, datasets: datasets }, options: { responsive: !0, plugins: { legend: { position: "top" }, title: { display: true, text: `Niveles de Logro - ${grade === 'Todos' ? 'General' : grade} ${group !== "Todos" && grade !== 'Todos' ? "Grupo " + group : ""}` } }, scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true, title: { display: true, text: "Cantidad de Estudiantes" } } } } }); }
            function updateCalificacionesGradoBarChart(grade, group, block, gender) { let filteredStudents; if (grade === 'Todos') { filteredStudents = data.listaEstudiantes.filter(s => s.status === 'activo'); } else { filteredStudents = data.listaEstudiantes.filter(s => s.grado === grade && s.status === 'activo'); } if (group !== 'Todos') { filteredStudents = filteredStudents.filter(s => s.grupo === group); } if (gender !== 'Todos') { filteredStudents = filteredStudents.filter(s => s.genero === gender); } const subjectKeyMap = { "matematicas": "m", "espanol": "e", "ciencias": "c", "ingles": "i" }; const subjectNames = { "matematicas": "Matemáticas", "espanol": "Español", "ciencias": "Ciencias", "ingles": "Inglés" }; const colorMap = {matematicas: ['rgba(255, 206, 86, 0.6)', 'rgba(255, 206, 86, 1)'],espanol: ['rgba(153, 102, 255, 0.6)', 'rgba(153, 102, 255, 1)'],ciencias: ['rgba(75, 192, 192, 0.6)', 'rgba(75, 192, 192, 1)'],ingles: ['rgba(54, 162, 235, 0.6)', 'rgba(54, 162, 235, 1)']}; let chartLabels = [], chartDataValues = [], backgroundColors = [], borderColors = []; Object.keys(subjectKeyMap).forEach(subjectKey => { if (!data.calificaciones[subjectKey] || data.calificaciones[subjectKey].length === 0) return; const shortKey = subjectKeyMap[subjectKey]; let totalSum = 0, totalCount = 0; filteredStudents.forEach(student => { if (student.calificaciones) { if (block === 'General') { Object.values(student.calificaciones).forEach(blockGrades => { if (blockGrades[shortKey] !== undefined && !isNaN(parseFloat(blockGrades[shortKey]))) { totalSum += parseFloat(blockGrades[shortKey]); totalCount++; } }); } else { if (student.calificaciones[block] && student.calificaciones[block][shortKey] !== undefined && !isNaN(parseFloat(student.calificaciones[block][shortKey]))) { totalSum += parseFloat(student.calificaciones[block][shortKey]); totalCount++; } } } }); const avg = totalCount > 0 ? (totalSum / totalCount) : 0; chartLabels.push(subjectNames[subjectKey]); chartDataValues.push(avg.toFixed(2)); backgroundColors.push(colorMap[subjectKey][0]); borderColors.push(colorMap[subjectKey][1]); }); if (!calificacionesGradoChart) { calificacionesGradoChart = new Chart(getEl("calificacionesGradoChart"), { type: "bar", data: { labels: chartLabels, datasets: [{ label: "Promedio de Calificaciones", data: chartDataValues, backgroundColor: backgroundColors, borderColor: borderColors, borderWidth: 1 }] }, options: { responsive: !0, plugins: { legend: { display: !1 }, datalabels: datalabelConfig }, scales: { y: { beginAtZero: !1, min: 5, max: 10.5 } } } }); } else { calificacionesGradoChart.data.labels = chartLabels; calificacionesGradoChart.data.datasets[0].data = chartDataValues; calificacionesGradoChart.data.datasets[0].backgroundColor = backgroundColors; calificacionesGradoChart.data.datasets[0].borderColor = borderColors; calificacionesGradoChart.update(); } const titleText = `Promedio - ${grade === 'Todos' ? 'General' : grade} ${group === 'Todos' || grade === 'Todos' ? '' : 'Grupo ' + group} (${block})`; calificacionesGradoChart.options.plugins.title = { display: true, text: titleText }; calificacionesGradoChart.update(); }
            function setupBoletosFilters() { if (!boletoBlockFilter) return; boletoBlockFilter.innerHTML = "", data.calificaciones.bloques.forEach(a => { const b = document.createElement("option"); b.value = a, b.textContent = a, boletoBlockFilter.appendChild(b) }); const a = [...new Set(data.listaEstudiantes.map(a => a.grado))].sort((x,y)=>x.localeCompare(y, undefined, {numeric: true})); boletoGradeFilter.innerHTML = '<option value="Todos">Todos</option>', a.forEach(a => { boletoGradeFilter.innerHTML += `<option value="${a}">${a}</option>` }); const b = ["Matemáticas", "Español", "Ciencias", "Inglés"]; boletoSubjectFilter.innerHTML = '<option value="Todas">Todas</option>', b.sort().forEach(a => { boletoSubjectFilter.innerHTML += `<option value="${a}">${a}</option>` }), boletoGradeFilter.addEventListener("change", () => { const a = boletoGradeFilter.value; boletoGroupFilter.innerHTML = '<option value="Todos">Todos</option>', "Todos" !== a ? (boletoGroupFilter.disabled = !1, [...new Set(data.listaEstudiantes.filter(b => b.grado === a).map(a => a.grupo))].sort().forEach(a => { boletoGroupFilter.innerHTML += `<option value="${a}">${a}</option>` })) : boletoGroupFilter.disabled = !0, updateBoletosChart() }), boletoGroupFilter.disabled = !0, [boletoBlockFilter, boletoGroupFilter, boletoSubjectFilter].forEach(a => { a.addEventListener("change", updateBoletosChart) }) }
            function updateBoletosChart(){ if (!getEl('boletosSalidaChart')) return; const a=boletoBlockFilter.value,b=boletoGradeFilter.value,c=boletoGroupFilter.value,d=boletoSubjectFilter.value;let e=data.listaEstudiantes;"Todos"!==b&&(e=e.filter(a=>a.grado===b)),"Todos"!==c&&(e=e.filter(a=>a.grupo===c));const f={};let g=!1;e.forEach(b=>{if(b.boletos&&b.boletos[a]){const c="Todas"===d?Object.keys(b.boletos[a]):[d];c.forEach(c=>{b.boletos[a][c]&&b.boletos[a][c].forEach(b=>{g=!0,f[b.date]||(f[b.date]={1:0,2:0,3:0}),f[b.date][b.score]++})})}});if(!g)return boletosChartContainer.classList.add("hidden"),void boletosNoData.classList.remove("hidden");boletosChartContainer.classList.remove("hidden"),boletosNoData.classList.add("hidden");const h=Object.keys(f).sort((a,b)=>new Date(a)-new Date(b)),i=h.map(a=>f[a][1]),j=h.map(a=>f[a][2]),k=h.map(a=>f[a][3]);boletosSalidaChartInstance&&boletosSalidaChartInstance.destroy(),boletosSalidaChartInstance=new Chart(getEl("boletosSalidaChart"),{type:"bar",data:{labels:h,datasets:[{label:"Calificación 1 (Bajo)",data:i,backgroundColor:"rgba(239, 68, 68, 0.7)"},{label:"Calificación 2 (Medio)",data:j,backgroundColor:"rgba(245, 158, 11, 0.7)"},{label:"Calificación 3 (Alto)",data:k,backgroundColor:"rgba(22, 163, 74, 0.7)"}]},options:{responsive:!0,plugins:{legend:{position:"top"}},scales:{x:{stacked:!0,title:{display:!0,text:"Fecha de Clase"}},y:{stacked:!0,beginAtZero:!0,title:{display:!0,text:"Cantidad de Estudiantes"}}}}})}
            function setupExpedienteFilters(){if (!expedienteGradeFilter) return; const a=[...new Set(data.listaEstudiantes.map(a=>a.grado))].sort((x,y)=>x.localeCompare(y, undefined, {numeric: true}));expedienteGradeFilter.innerHTML='<option value="">Seleccione...</option>',a.forEach(a=>{expedienteGradeFilter.innerHTML+=`<option value="${a}">${a}</option>`}),expedienteGradeFilter.addEventListener("change",()=>{const a=expedienteGradeFilter.value;expedienteGroupFilter.innerHTML='<option value="">Seleccione...</option>',expedienteStudentFilter.innerHTML='<option value="">Seleccione...</option>',expedienteContainer.classList.add("hidden"),expedientePlaceholder.classList.remove("hidden"),a?(expedienteGroupFilter.disabled=!1,[...new Set(data.listaEstudiantes.filter(b=>b.grado===a).map(a=>a.grupo))].sort().forEach(a=>{expedienteGroupFilter.innerHTML+=`<option value="${a}">${a}</option>`})):expedienteGroupFilter.disabled=!0,expedienteStudentFilter.disabled=!0}),expedienteGroupFilter.addEventListener("change",()=>{const a=expedienteGradeFilter.value,b=expedienteGroupFilter.value;expedienteStudentFilter.innerHTML='<option value="">Seleccione...</option>',expedienteContainer.classList.add("hidden"),expedientePlaceholder.classList.remove("hidden"),a&&b?(expedienteStudentFilter.disabled=!1,data.listaEstudiantes.filter(c=>c.grado===a&&c.grupo===b).sort((a,b)=>a.nombre.localeCompare(b.nombre)).forEach(a=>{expedienteStudentFilter.innerHTML+=`<option value="${a.id}">${a.nombre}</option>`})):expedienteStudentFilter.disabled=!0}),expedienteStudentFilter.addEventListener("change",a=>{a.target.value?(updateExpedienteView(a.target.value),expedienteContainer.classList.remove("hidden"),expedientePlaceholder.classList.add("hidden")):(expedienteContainer.classList.add("hidden"),expedientePlaceholder.classList.remove("hidden"))}),expedienteGroupFilter.disabled=!0,expedienteStudentFilter.disabled=!0}
            function updateExpedienteView(a){ const b=data.listaEstudiantes.find(b=>b.id==a); if(!b)return; getEl("expediente-nombre").textContent=b.nombre,getEl("expediente-grupo").textContent=`${b.grado} - ${b.grupo}`,getEl("expediente-genero").textContent=b.genero; const c=getEl("expediente-estatus");c.textContent=b.status.charAt(0).toUpperCase()+b.status.slice(1),c.className=`text-lg font-semibold ${"activo"===b.status?"text-green-600":"text-red-600"}`,getEl("expediente-bap").textContent=b.bap||"No", getEl("expediente-clave").textContent = b.clave_escolar || b.id || 'N/A'; let d=0,e=0;if(b.calificaciones&&Object.keys(b.calificaciones).length>0){for(const a in b.calificaciones){const c=b.calificaciones[a];for(const key in c) {d+=c[key]||0,e++}}}const f=e>0?d/e:0;getEl("expediente-promedio").textContent=f.toFixed(2); const g=getNivelDeLogro(f),h=getEl("expediente-nivel-logro");h.textContent=g.nivel,h.className=`text-base font-bold px-2 py-1 rounded-md inline-block align-middle ${g.color}`; const i=getEl("expediente-block-filter");i.innerHTML='<option value="General">General</option>';const j=Object.keys(b.calificaciones||{}).sort();j.forEach(a=>{const b=document.createElement("option");b.value=a,b.textContent=a,i.appendChild(b)}); const initialAverages = updateExpedienteSubjectAverages(b,"General"); updateExpedienteRadarChart(initialAverages, "General"); const studentMonths = Object.keys(b.asistencia).sort((a,b) => a-b).map(num => MESES_MAP[num]); const studentAttendance = Object.keys(b.asistencia).sort((a,b) => a-b).map(key => b.asistencia[key]); if(expedienteAsistenciaChartInstance)expedienteAsistenciaChartInstance.destroy(); expedienteAsistenciaChartInstance=new Chart(getEl("expedienteAsistenciaChart"),{type:"bar",options:{responsive:!0,plugins:{datalabels:{...datalabelConfig, formatter: (v) => v ? `${v}%` : ''}},scales:{y:{beginAtZero:!1,min:70,max:100.5}}}}); expedienteAsistenciaChartInstance.data={labels:studentMonths,datasets:[{label:"% de Asistencia",data:studentAttendance,backgroundColor:"rgba(22, 163, 74, 0.6)",borderColor:"rgba(22, 163, 74, 1)",borderWidth:1}]},expedienteAsistenciaChartInstance.update(); const m=data.calificaciones.bloques,n=m.map(a=>b.calificaciones[a]?.m||null),o=m.map(a=>b.calificaciones[a]?.e||null),p=m.map(a=>b.calificaciones[a]?.c||null),q=m.map(a=>b.calificaciones[a]?.i||null); if(expedienteCalificacionesChartInstance)expedienteCalificacionesChartInstance.destroy(); expedienteCalificacionesChartInstance=new Chart(getEl("expedienteCalificacionesChart"),{type:"bar",data:{labels:m,datasets:[{label:"Matemáticas",data:n,backgroundColor:"rgba(234, 179, 8, 0.7)"},{label:"Español",data:o,backgroundColor:"rgba(139, 92, 246, 0.7)"},{label:"Ciencias",data:p,backgroundColor:"rgba(22, 163, 74, 0.7)"},{label:"Inglés",data:q,backgroundColor:"rgba(37, 99, 235, 0.7)"}]}, options:{responsive:!0,plugins:{datalabels: datalabelConfig},scales:{y:{beginAtZero:!0,min:0,max:10.5}}}}); expedienteCalificacionesChartInstance.update() }
            function updateExpedienteSubjectAverages(a,b){if(!a)return;let c={m:NaN,e:NaN,c:NaN,i:NaN};if(a.calificaciones&&Object.keys(a.calificaciones).length>0)if("General"===b){const b={m:[],e:[],c:[],i:[]};for(const d in a.calificaciones){const e=a.calificaciones[d];Object.keys(e).forEach(a=>{b[a]&&b[a].push(e[a])})} Object.keys(b).forEach(a=>{b[a].length>0&&(c[a]=b[a].reduce((a,b)=>a+b,0)/b[a].length)})}else{const d=a.calificaciones[b]||{};c.m=d.m,c.e=d.e,c.c=d.c,c.i=d.i} const d=c.m,e=getNivelDeLogro(d);getEl("expediente-prom-mat").textContent=isNaN(d)?"N/A":d.toFixed(2),getEl("expediente-nivel-mat").textContent=isNaN(d)?"":e.nivel,getEl("expediente-nivel-mat").className=`text-xs font-bold px-2 py-0.5 rounded-md inline-block mt-1 align-middle ${isNaN(d)?"":e.color}`;const f=c.e,g=getNivelDeLogro(f);getEl("expediente-prom-esp").textContent=isNaN(f)?"N/A":f.toFixed(2),getEl("expediente-nivel-esp").textContent=isNaN(f)?"":g.nivel,getEl("expediente-nivel-esp").className=`text-xs font-bold px-2 py-0.5 rounded-md inline-block mt-1 align-middle ${isNaN(f)?"":g.color}`;const h=c.c,i=getNivelDeLogro(h);getEl("expediente-prom-cie").textContent=isNaN(h)?"N/A":h.toFixed(2),getEl("expediente-nivel-cie").textContent=isNaN(h)?"":i.nivel,getEl("expediente-nivel-cie").className=`text-xs font-bold px-2 py-0.5 rounded-md inline-block mt-1 align-middle ${isNaN(h)?"":i.color}`;const j=c.i,k=getNivelDeLogro(j);getEl("expediente-prom-ing").textContent=isNaN(j)?"N/A":j.toFixed(2),getEl("expediente-nivel-ing").textContent=isNaN(j)?"":k.nivel,getEl("expediente-nivel-ing").className=`text-xs font-bold px-2 py-0.5 rounded-md inline-block mt-1 align-middle ${isNaN(j)?"":k.color}`; return c;}
            function updateExpedienteRadarChart(averages, blockName) { if(!getEl("expedienteRadarChart")) return; if (expedienteRadarChartInstance) expedienteRadarChartInstance.destroy(); const subjectMap = { m: 'Matemáticas', e: 'Español', c: 'Ciencias', i: 'Inglés' }; const labels = [], dataPoints = []; Object.keys(subjectMap).forEach(key => { if (!isNaN(averages[key])) { labels.push(subjectMap[key]); dataPoints.push(averages[key]); } }); expedienteRadarChartInstance = new Chart(getEl("expedienteRadarChart"), { type: 'radar', data: { labels: labels, datasets: [{ label: `Promedio (${blockName})`, data: dataPoints, backgroundColor: 'rgba(54, 162, 235, 0.2)', borderColor: 'rgba(54, 162, 235, 1)', borderWidth: 2 }] }, options: { responsive: true, scales: { r: { beginAtZero: true, min: 0, max: 10, ticks: { stepSize: 2 } } }, plugins: { legend: { position: 'top' }, datalabels: { color: '#36A2EB', font: {weight: 'bold'}, formatter: (v) => parseFloat(v).toFixed(1) } } } }); }
            if(getEl("asistenciaPadresChart")) {new Chart(getEl("asistenciaPadresChart"),{type:"bar",data:{labels:data.asistenciaPadres.meses,datasets:[{label:"% de Asistencia de Padres",data:data.asistenciaPadres.asistencia,backgroundColor:"rgba(20, 184, 166, 0.6)",borderColor:"rgba(15, 118, 110, 1)",borderWidth:1}]},options:{responsive:!0,scales:{y:{beginAtZero:!1,min:60,max:100,ticks:{callback:function(a){return a+"%"}}}},plugins:{legend:{display:!1}}}});}
            periodFilter.addEventListener('change', (e) => updateSummary(e.target.value));
            if(gradeFilter) gradeFilter.addEventListener('change', e => { const selectedGrade = e.target.value; if (selectedGrade === 'Todos') { groupFilter.innerHTML = '<option value="Todos">Todos</option>'; groupFilter.disabled = true; } else { groupFilter.disabled = false; populateGroupFilter(selectedGrade); } updateCalificacionesGradoCharts(selectedGrade, groupFilter.value, blockFilter.value, genderFilterCal.value); });
            if(groupFilter) groupFilter.addEventListener('change', e => { updateCalificacionesGradoCharts(gradeFilter.value, e.target.value, blockFilter.value, genderFilterCal.value); });
            if(blockFilter) blockFilter.addEventListener('change', e => { updateCalificacionesGradoCharts(gradeFilter.value, groupFilter.value, e.target.value, genderFilterCal.value); });
            if(genderFilterCal) genderFilterCal.addEventListener('change', e => { updateCalificacionesGradoCharts(gradeFilter.value, groupFilter.value, blockFilter.value, e.target.value); });
            if(getEl('expediente-block-filter')) getEl('expediente-block-filter').addEventListener('change', () => { const studentId = getEl('expediente-student-filter').value; if(studentId){ const student = data.listaEstudiantes.find(s => s.id == studentId); const selectedBlock = getEl('expediente-block-filter').value; const newAverages = updateExpedienteSubjectAverages(student, selectedBlock); updateExpedienteRadarChart(newAverages, selectedBlock); }});
            async function generateStudentPDF() { const studentName = getEl('expediente-nombre').textContent || "Estudiante"; const fileName = `Expediente-${studentName.replace(/ /g, '_')}.pdf`; const downloadButton = getEl('download-pdf-button'); const contentToCapture = getEl('expediente-container'); downloadButton.style.visibility = 'hidden'; try { const canvas = await html2canvas(contentToCapture, { scale: 2, backgroundColor: '#ffffff', onclone: (clonedDoc) => { const filterContainer = clonedDoc.getElementById('expediente-filter-container'); if (filterContainer) { const selectedBlock = document.getElementById('expediente-block-filter').value; filterContainer.innerHTML = `<p class="text-right text-sm text-gray-600 font-medium mb-4">Mostrando resultados para: <strong>${selectedBlock}</strong></p>`; } Array.from(clonedDoc.getElementsByTagName('canvas')).forEach(canvasEl => { if (canvasEl.__chartjs__) { canvasEl.__chartjs__.options.animation = false; } }); } }); const imgData = canvas.toDataURL('image/png'); const { jsPDF } = window.jspdf; const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' }); const pageHeight = pdf.internal.pageSize.getHeight() - 20; const pageWidth = pdf.internal.pageSize.getWidth() - 20; const pageRatio = pageWidth / pageHeight; const imgWidth = canvas.width; const imgHeight = canvas.height; const imgRatio = imgWidth / imgHeight; let finalWidth, finalHeight; if (imgRatio > pageRatio) { finalWidth = pageWidth; finalHeight = finalWidth / imgRatio; } else { finalHeight = pageHeight; finalWidth = finalHeight * imgRatio; } const x = (pdf.internal.pageSize.getWidth() - finalWidth) / 2; const y = 10; pdf.addImage(imgData, 'PNG', x, y, finalWidth, finalHeight); pdf.save(fileName); } catch (error) { console.error("Error al generar el PDF:", error); alert("Hubo un error al generar el PDF. Revisa la consola para más detalles."); } finally { downloadButton.style.visibility = 'visible'; } }
            if(getEl('download-pdf-button')) getEl('download-pdf-button').addEventListener('click', generateStudentPDF);
            lucide.createIcons();
            populateFilter();
            updateSummary('General');
            createGeneralCharts();
            createStudentCharts();
            setupStudentFilters();
            updateStudentCharts();
            populateGradeFilter();
            if (data.listaEstudiantes.length > 0 && gradeFilter) { const initialGrade = gradeFilter.value; if (initialGrade === 'Todos') { groupFilter.innerHTML = '<option value="Todos">Todos</option>'; groupFilter.disabled = true; } else { populateGroupFilter(initialGrade); } updateCalificacionesGradoCharts(initialGrade, groupFilter.value, 'General', genderFilterCal.value); }
            populateBlockFilter();
            setupBoletosFilters();
            updateBoletosChart();
            setupExpedienteFilters();
            manageVisibility();
        }
        function getDemoData() {
            return {resumenGeneral: { matricula: 452, asistencia: 92.1, bajas: 15, docentes: 28, prom_matematicas: 8.4, prom_espanol: 8.9, prom_ciencias: 8.1, prom_ingles: 9.3, alumnosBAP: 2, prom_asistencia_padres: 86.3 },resumenMensual: [ { periodo: "Enero", matricula: 435, bajas: 2, asistencia: 95.5, prom_matematicas: 8.2, prom_espanol: 8.8, prom_ciencias: 7.5, prom_ingles: 9, prom_asistencia_padres: 85 }, { periodo: "Febrero", matricula: 440, bajas: 1, asistencia: 96, prom_matematicas: 7.9, prom_espanol: 8.5, prom_ciencias: 8, prom_ingles: 9.2, prom_asistencia_padres: 90 }],resumenPorBloque: [ { bloque: "Bloque 1", matricula: 425, bajas: 1, asistencia: 96, prom_matematicas: 8.2, prom_espanol: 8.8, prom_ciencias: 7.5, prom_ingles: 9, prom_asistencia_padres: 85 }, { bloque: "Bloque 2", matricula: 438, bajas: 1, asistencia: 95, prom_matematicas: 7.9, prom_espanol: 8.5, prom_ciencias: 8, prom_ingles: 9.2, prom_asistencia_padres: 90 }],listaEstudiantes: [ { id: 1, clave_escolar: 'DEMO-001', nombre: "Ana García (Demo)", genero: "Femenino", grado: "1ro", grupo: "A", status: "activo", motivoBaja: null, bap: "Sí", asistencia: { 9: 98, 10: 95 }, calificaciones: { "Bloque 1": { m: 9.6, e: 9, c: 8, i: 9 }, "Bloque 2": { m: 9.8, e: 9, c: 8, i: 10 } }, boletos: { "Bloque 1": { Matemáticas: [{ date: "2025-09-18", score: 3 }] } } }, { id: 2, clave_escolar: 'DEMO-002', nombre: "Luis Rodríguez (Demo)", genero: "Masculino", grado: "1ro", grupo: "A", status: "activo", motivoBaja: null, bap: "No", asistencia: { 9: 95, 10: 100 }, calificaciones: { "Bloque 1": { m: 8.5, e: 9, c: 8, i: 9 }, "Bloque 2": { m: 9, e: 9, c: 9, i: 9 } }, boletos: {} } ],docentes: { altas: [2, 1, 3, 1, 0, 1], bajas: [1, 0, 1, 0, 1, 0], meses: ["Mar", "Abr", "May", "Jun", "Jul", "Ago"] },calificaciones: { matematicas: [8.2, 7.9], espanol: [8.8, 8.5], ciencias: [7.5, 8], ingles: [9, 9.2], bloques: ["Bloque 1", "Bloque 2"] },asistenciaPadres: { meses: ["Enero", "Febrero", "Marzo"], asistencia: [85, 90, 78] }, estudiantes: {meses: ["Agosto", "Septiembre"], matricula: [450, 452]}};
        }
    </script>
</body>
</html>